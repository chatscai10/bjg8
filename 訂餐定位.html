<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>跨裝置 - 最近分店地圖示範</title>
  <!-- 行動裝置 RWD 必備 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (不使用 SRI, 避免被擋) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    h1 {
      text-align: center;
      font-size: 1.2em;
      margin-top: 10px;
    }
    /* 地圖佔 50% 螢幕高度，可依需求調整 */
    #map {
      width: 100%;
      height: 50vh;
    }
    #storeList {
      padding: 10px;
    }
    .store-item {
      border-bottom: 1px solid #ccc;
      padding: 8px 0;
    }
    .store-item:last-child {
      border-bottom: none;
    }
    .distance {
      color: #666;
      font-size: 0.9em;
    }
    .alert {
      color: red;
      margin-bottom: 10px;
    }
    @media screen and (max-width: 600px) {
      h1 {
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <h1>最近分店地圖示範 (跨裝置)</h1>
  <div id="map"></div>
  <div id="storeList"></div>

  <!-- Leaflet JS (不使用 SRI, 避免被擋) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

  <script>
    // 1. 定義分店資料
    var stores = [
      {
        name: "店家 A",
        lat: 25.0340,
        lon: 121.5645,
        address: "台北市某處 A",
        link: "https://goo.gl/maps/xxxxA"
      },
      {
        name: "店家 B",
        lat: 25.0478,
        lon: 121.5319,
        address: "台北市某處 B",
        link: "https://goo.gl/maps/xxxxB"
      },
      {
        name: "店家 C",
        lat: 24.9934,
        lon: 121.3016,
        address: "桃園市某處 C",
        link: "https://goo.gl/maps/xxxxC"
      }
      // ...可持續擴增
    ];

    // 2. 初始化 Leaflet 地圖 (設定台灣為初始中心)
    var map = L.map("map").setView([23.5, 121], 7);

    // 3. 載入 OSM 圖磚
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    // 4. 計算兩組經緯度之間的距離 (km)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      var R = 6371; // 地球半徑
      var dLat = deg2rad(lat2 - lat1);
      var dLon = deg2rad(lon2 - lon1);
      var a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) *
          Math.cos(deg2rad(lat2)) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c;
      return d;
    }
    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    // 5. 在地圖上標示分店
    function showStoreMarkers(storeArray) {
      for (var i = 0; i < storeArray.length; i++) {
        var store = storeArray[i];
        L.marker([store.lat, store.lon])
          .addTo(map)
          .bindPopup("<b>" + store.name + "</b><br>" + store.address);
      }
    }

    // 6. 依距離排序分店
    function sortStoresByDistance(userLat, userLon, storeArr) {
      // 用 map 產生一個新陣列，裡面包含 distance
      var newArr = [];
      for (var i = 0; i < storeArr.length; i++) {
        var store = storeArr[i];
        var dist = getDistanceFromLatLonInKm(userLat, userLon, store.lat, store.lon);
        var newStore = {
          name: store.name,
          lat: store.lat,
          lon: store.lon,
          address: store.address,
          link: store.link,
          distance: dist
        };
        newArr.push(newStore);
      }
      // 排序
      newArr.sort(function(a, b) {
        return a.distance - b.distance;
      });
      return newArr;
    }

    // 7. 將分店列表顯示在下方
    function renderStoreList(sortedStores) {
      var storeListDiv = document.getElementById("storeList");
      storeListDiv.innerHTML = "";

      for (var i = 0; i < sortedStores.length; i++) {
        var s = sortedStores[i];
        var distanceText = s.distance ? "距離約 " + s.distance.toFixed(2) + " 公里" : "";
        var itemHtml =
          '<div class="store-item">' +
            "<div><strong>" + s.name + "</strong></div>" +
            "<div>" + s.address + "</div>" +
            '<div class="distance">' + distanceText + "</div>" +
            '<div><a href="' + s.link + '" target="_blank">查看連結</a></div>' +
          "</div>";
        storeListDiv.innerHTML += itemHtml;
      }
    }

    // 8. 若定位成功
    function onLocationFound(pos) {
      var userLat = pos.coords.latitude;
      var userLon = pos.coords.longitude;

      // 在地圖上標註使用者位置
      var userMarker = L.marker([userLat, userLon]).addTo(map);
      userMarker.bindPopup("您目前在這裡").openPopup();

      // 調整地圖視野
      map.setView([userLat, userLon], 14);

      // 依距離排序並顯示
      var sortedStores = sortStoresByDistance(userLat, userLon, stores);
      showStoreMarkers(sortedStores);
      renderStoreList(sortedStores);
    }

    // 9. 若定位失敗
    function onLocationError(err) {
      var storeListDiv = document.getElementById("storeList");
      storeListDiv.innerHTML =
        '<div class="alert">定位未開啟或被拒絕，無法判斷哪家店最近。</div>';

      // 直接顯示所有分店
      showStoreMarkers(stores);
      renderStoreList(stores);
    }

    // 10. 嘗試取得定位
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      });
    } else {
      // 瀏覽器不支援 Geolocation
      onLocationError({ message: "Geolocation is not supported." });
    }
  </script>
</body>
</html>
