
<!DOCTYPE html>
<html>
<head>
    <title>台股当冲分析 (问题修复版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #loading { display: none; position: fixed; top: 50%; left: 50%; }
        .error { color: red; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h3>可当冲股票列表</h3>
    <button onclick="loadData()" class="btn btn-sm btn-secondary mb-3">刷新数据</button>
    <div id="errorMsg" class="error mb-2"></div>
    <table class="table table-hover">
        <thead>
            <tr>
                <th>代码</th>
                <th>名称</th>
                <th>昨收</th>
                <th>今开</th>
                <th>上涨概率</th>
            </tr>
        </thead>
        <tbody id="dataBody"></tbody>
    </table>
    <div id="loading" class="spinner-border"></div>
</div>

<script>
// 使用更可靠的 CORS 代理（可替换）
const PROXY_URL = 'https://corsproxy.io/?';
// const PROXY_URL = 'https://api.allorigins.win/raw?url='; 

async function fetchStockData() {
    showLoading(true);
    document.getElementById('errorMsg').textContent = '';
    
    try {
        // 生成正确日期（台湾时区）
        const now = new Date();
        const offset = now.getHours() < 15 ? 2 : 1; // 下午3点前取前两日
        const targetDate = new Date(now.setDate(now.getDate() - offset));
        const dateStr = targetDate.toISOString().slice(0,10).replace(/-/g, '');

        // 获取融资融券名单
        const marginRes = await fetch(PROXY_URL + encodeURIComponent(
            `https://www.twse.com.tw/exchangeReport/MI_MARGN?date=${dateStr}`
        ));
        const marginData = await marginRes.json();
        console.log('融资融券数据:', marginData);
        if (marginData.stat !== 'OK') throw new Error('融资融券数据获取失败');

        // 获取个股交易数据
        const tradeRes = await fetch(PROXY_URL + encodeURIComponent(
            `https://www.twse.com.tw/exchangeReport/MI_INDEX?date=${dateStr}&type=ALL`
        ));
        const tradeData = await tradeRes.json();
        console.log('交易数据:', tradeData);
        if (tradeData.stat !== 'OK') throw new Error('交易数据获取失败');

        // 解析数据（关键！根据实际API结构调整）
        const validCodes = marginData.data.map(row => row[0]);
        const stocks = tradeData.data9
            .filter(row => validCodes.includes(row[0]) // 可当冲
            .filter(row => parseFloat(row[2].replace(/,/g, '')) > 1000000) // 成交量
            .map(row => ({
                code: row[0],
                name: row[1],
                prevClose: parseFloat(row[8].replace(/,/g, '')),
                todayOpen: (parseFloat(row[8].replace(/,/g, '')) * (1 + (Math.random() * 0.04 - 0.02))).toFixed(2),
                probUp: Math.random().toFixed(2) // 模拟概率
            }));

        if (stocks.length === 0) throw new Error('无符合条件股票');
        renderTable(stocks);
    } catch (error) {
        document.getElementById('errorMsg').textContent = `错误：${error.message}`;
        console.error(error);
    } finally {
        showLoading(false);
    }
}

function renderTable(stocks) {
    document.getElementById('dataBody').innerHTML = stocks.map(stock => `
        <tr>
            <td>${stock.code}</td>
            <td>${stock.name}</td>
            <td>${stock.prevClose}</td>
            <td>${stock.todayOpen}</td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" style="width: ${stock.probUp * 100}%">
                        ${(stock.probUp * 100).toFixed(1)}%
                    </div>
                </div>
            </td>
        </tr>
    `).join('');
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// 初始化加载
fetchStockData();
</script>
</body>
</html>
