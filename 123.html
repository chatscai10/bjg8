<!DOCTYPE html>
<html>
<head>
    <title>台股当冲分析 (纯前端版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-bar {
            min-width: 40px; /* 确保低概率值仍可阅读 */
        }
        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">台股当日可当冲股票分析</h1>
        
        <!-- 控制栏 -->
        <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="输入股票代码或名称...">
            <button onclick="loadData()" class="btn btn-primary mt-2">重新加载数据</button>
        </div>

        <!-- 数据表格 -->
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>股票代码</th>
                    <th>股票名称</th>
                    <th>前日收盘价</th>
                    <th>当日开盘价</th>
                    <th>上涨概率</th>
                </tr>
            </thead>
            <tbody id="dataBody"></tbody>
        </table>

        <!-- 加载提示 -->
        <div id="loading" class="spinner-border text-primary"></div>
    </div>

    <script>
        // 获取台湾日期格式 (YYYYMMDD)
        function getTWDate(date) {
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '');
        }

        // 核心数据处理函数
        async function loadData() {
            showLoading(true);
            
            try {
                // 获取前一日日期
                const today = new Date();
                const prevDay = new Date(today);
                prevDay.setDate(today.getDate() - 1);
                const prevDate = getTWDate(prevDay);

                // 并行获取融资融券名单与前日交易数据
                const [marginStocks, tradeData] = await Promise.all([
                    fetch(`https://cors-anywhere.herokuapp.com/https://www.twse.com.tw/exchangeReport/MI_MARGN?date=${prevDate}`)
                        .then(res => res.json())
                        .then(data => data.data.map(row => row[0])),
                    
                    fetch(`https://cors-anywhere.herokuapp.com/https://www.twse.com.tw/exchangeReport/MI_INDEX?date=${prevDate}&type=ALL`)
                        .then(res => res.json())
                        .then(data => data.data)
                ]);

                // 数据清洗与筛选
                const filteredStocks = tradeData
                    .filter(row => 
                        marginStocks.includes(row[0]) && 
                        parseFloat(row[2].replace(/,/g, '')) > 1000000
                    )
                    .map(row => ({
                        code: row[0],
                        name: row[1],
                        prevClose: parseFloat(row[8].replace(/,/g, '')),
                        todayOpen: parseFloat(row[8].replace(/,/g, '')) * (1 + (Math.random() * 0.04 - 0.02)), // 模拟开盘价
                    }))
                    .map(stock => ({
                        ...stock,
                        probUp: stock.todayOpen > stock.prevClose ? 0.6 : 0.4 // 简单概率模型
                    }));

                renderTable(filteredStocks);
            } catch (error) {
                alert('数据加载失败，请稍后重试');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        // 渲染表格
        function renderTable(stocks) {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = stocks.map(stock => `
                <tr>
                    <td>${stock.code}</td>
                    <td>${stock.name}</td>
                    <td>${stock.prevClose.toFixed(2)}</td>
                    <td>${stock.todayOpen.toFixed(2)}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar bg-success" 
                                 style="width: ${stock.probUp * 100}%">
                                ${(stock.probUp * 100).toFixed(1)}%
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');

            // 动态绑定搜索功能
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const keyword = e.target.value.toLowerCase();
                const filtered = stocks.filter(stock => 
                    stock.code.toLowerCase().includes(keyword) || 
                    stock.name.toLowerCase().includes(keyword)
                );
                tbody.innerHTML = filtered.map(stock => `
                    <tr>
                        <td>${stock.code}</td>
                        <td>${stock.name}</td>
                        <td>${stock.prevClose.toFixed(2)}</td>
                        <td>${stock.todayOpen.toFixed(2)}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-success" 
                                     style="width: ${stock.probUp * 100}%">
                                    ${(stock.probUp * 100).toFixed(1)}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // 加载状态控制
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 页面加载时自动获取数据
        window.onload = loadData;
    </script>
</body>
</html>
