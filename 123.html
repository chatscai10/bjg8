<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>專業室內佈局編輯器 (v7.0 - 跨區/字型)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- 基本頁面樣式 --- */
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
        }

        /* --- 控制面板 (左側) --- */
        .controls {
            width: 300px;
            flex-shrink: 0;
            padding: 20px;
            background-color: #fff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 100;
            height: 100vh;
            box-sizing: border-box;
        }
        
        .controls h3 { margin-top: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .controls h3:first-child { margin-top: 0; }
        .control-group { margin-bottom: 15px; }
        .controls label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .controls input[type="text"],
        .controls input[type="number"],
        .controls select,
        .controls textarea {
            width: calc(100% - 20px); 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 12px;
        }
        .controls select { font-family: Arial, sans-serif; font-size: 14px; }
        .controls input[type="text"],
        .controls input[type="number"] { font-family: Arial, sans-serif; font-size: 14px; }
        .controls input[type="range"] { width: 100%; padding: 0; }
        .controls input[type="color"] { padding: 0; height: 35px; width: 100%; }
        
        .controls button { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; margin-top: 5px; }
        .controls button:hover { background-color: #0056b3; }
        .controls button.secondary { background-color: #6c757d; }
        .controls button.secondary:hover { background-color: #5a6268; }
        .controls button.success { background-color: #28a745; }
        .controls button.success:hover { background-color: #218838; }
        .controls button.danger { background-color: #dc3545; }
        .controls button.danger:hover { background-color: #c82333; }
        
        .controls button:disabled,
        .controls button:disabled:hover {
            background-color: #c6c6c6;
            cursor: not-allowed;
        }
        
        .control-row { display: flex; gap: 10px; }
        .control-row button { width: 100%; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; }

        /* --- 模擬區域 (右側) --- */
        #canvas-wrapper {
            flex-grow: 1;
            height: 100vh;
            overflow: auto;
            background-color: #e9ebee;
            -webkit-overflow-scrolling: touch;
        }
        
        #canvas {
            position: relative;
            width: 5000px;
            height: 5000px;
            background-color: #f8f9fa;
            background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            transform-origin: top left;
            transition: transform 0.2s ease-out;
        }

        /* --- 房間 (畫布) --- */
        .room {
            position: absolute; 
            background-color: #ffffff;
            border: 3px solid #ccc;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            transition: border-color 0.3s;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .room:active { cursor: grabbing; }
        .room.room-active {
            border: 3px solid #007bff;
            box-shadow: 0 0 15px rgba(0,123,255,0.3);
            z-index: 50; 
        }

        /* --- 房間標籤 (新) --- */
        .room-label {
            position: absolute;
            /* (新) 使用 CSS 變數，預設 14px */
            font-size: var(--font-size, 14px); 
            font-weight: bold;
            color: rgba(0,0,0,0.25);
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
        }
        .label-room-main { position: relative; }
        .label-room-width { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .label-room-height { right: 8px; top: 50%; transform: translateY(-50%) rotate(90deg); transform-origin: center; }
        
        /* --- 家具 (色塊) --- */
        .furniture {
            position: absolute; 
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            border: 2px solid #555;
            transition: left 0.1s ease-out, top 0.1s ease-out, border-color 0.2s, background-color 0.2s;
            /* (新) 確保家具在房間上面 */
            z-index: 100;
        }
        
        .furniture.furniture-active {
            border: 3px solid #007bff;
            box-shadow: 0 0 15px rgba(0,123,255,0.3);
            z-index: 500; 
        }

        /* --- 家具標籤 (新) --- */
        .furniture-label {
            position: absolute;
            /* (新) 使用 CSS 變數，預設 14px */
            font-size: var(--font-size, 14px);
            color: #1f1f1f;
            text-shadow: 0 0 3px rgba(255,255,255,0.9);
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
        }
        .label-main { position: relative; font-weight: bold; }
        .label-width { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .label-height { right: 5px; top: 50%; transform: translateY(-50%) rotate(90deg); transform-origin: center; }
        
        .furniture.colliding {
            border: 3px solid #dc3545 !important;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
            z-index: 1001 !important;
            transition: none; 
        }
        
        /* --- 手機版響應式樣式 --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            .controls { width: 100%; height: 40vh; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
            #canvas-wrapper { height: 60vh; }
        }

    </style>
</head>
<body>

    <div class="controls">
        <h3>視圖控制</h3>
        <div class="control-group control-row">
            <button id="zoomInBtn">+</button>
            <button id="zoomOutBtn">-</button>
            <button id="zoomResetBtn">100%</button>
        </div>
        <div class="control-group control-row">
            <button id="undoBtn" class="secondary" disabled>上一步</button>
            <button id="redoBtn" class="secondary" disabled>下一步</button>
        </div>
        
        <h3>專案 (分享/匯入)</h3>
        <div class="control-group">
            <label for="importExportArea">佈局代碼 (機器碼)</label>
            <textarea id="importExportArea" rows="4" placeholder="貼上代碼, 或點擊下方匯出..."></textarea>
            <button id="importTextBtn" class="secondary" style="margin-top:10px;">從代碼匯入</button>
            <button id="exportTextBtn">匯出為代碼</button>
        </div>
        <div class="control-group">
            <button id="exportImageBtn" class="secondary">輸出為圖片 (PNG)</button>
            <button id="clearBtn" class="danger">清空所有</button>
        </div>

        <h3>編輯選中項目</h3>
        <div class="control-group">
            <p style="font-size: 13px; color: #555;">(請點擊/觸控畫布上的項目)</p>
            <button id="updateBtn" class="success">更新屬性</button>
            <button id="deleteBtn" class="danger">刪除選中項目</button>
        </div>
        <div class="control-group checkbox-group">
            <input type="checkbox" id="preventOverlap">
            <label for="preventOverlap">禁止家具重疊</label>
        </div>
        <div class="control-group checkbox-group">
            <input type="checkbox" id="enableSnapping" checked>
            <label for="enableSnapping">啟用邊緣吸附</label>
        </div>

        <h3>新增項目</h3>
        <div style="border:1px solid #eee; padding: 15px; border-radius: 5px;">
            <h4>新增房間</h4>
            <div class="control-group">
                <label for="roomWidth">寬度 (cm)</label>
                <input type="number" id="roomWidth" value="500">
            </div>
            <div class="control-group">
                <label for="roomHeight">長度 (cm)</label>
                <input type="number" id="roomHeight" value="400">
            </div>
            <div class="control-group">
                <label for="roomLabel">備註</label>
                <input type="text" id="roomLabel" value="客廳">
            </div>
            <div class="control-group">
                <label for="roomFontSize">文字大小 (px)</label>
                <input type="number" id="roomFontSize" value="14" min="8" max="100">
            </div>
            <button id="addRoomBtn">新增房間</button>
        </div>
        
        <div style="border:1px solid #eee; padding: 15px; border-radius: 5px; margin-top:15px;">
            <h4>新增家具</h4>
            <div class="control-group">
                <label for="furnWidth">寬度 (cm)</label>
                <input type="number" id="furnWidth" value="180">
            </div>
            <div class="control-group">
                <label for="furnHeight">長度 (cm)</label>
                <input type="number" id="furnHeight" value="90">
            </div>
            <div class="control-group">
                <label for="furnShape">形狀</label>
                <select id="furnShape">
                    <option value="rectangle">四方形</option>
                    <option value="circle">圓形/橢圓</option>
                </select>
            </div>
            <div class="control-group">
                <label for="furnColor">顏色</label>
                <input type="color" id="furnColor" value="#a3b18a">
            </div>
            <div class="control-group">
                <label for="furnOpacity">透明度 (<span id="opacityValue">100</span>%)</label>
                <input type="range" id="furnOpacity" min="10" max="100" value="100">
            </div>
            <div class="control-group">
                <label for="furnLabel">備註</label>
                <input type="text" id="furnLabel" value="沙發">
            </div>
            <div class="control-group">
                <label for="furnFontSize">文字大小 (px)</label>
                <input type="number" id="furnFontSize" value="14" min="8" max="100">
            </div>
            <button id="addFurnitureBtn">新增家具</button>
        </div>
    </div>

    <div id="canvas-wrapper">
        <div id="canvas">
            </div>
    </div>

    <script>
        // 3. JavaScript 功能實現

        // --- 比例尺 & 常數 ---
        const SCALE = 1.5; 
        const SNAP_DISTANCE = 10;

        // 獲取元素
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const canvas = document.getElementById('canvas');
        const addRoomBtn = document.getElementById('addRoomBtn');
        const addFurnitureBtn = document.getElementById('addFurnitureBtn');
        const opacitySlider = document.getElementById('furnOpacity');
        const opacityValue = document.getElementById('opacityValue');
        
        // 全局變數
        let activeRoom = null;
        let activeFurniture = null;
        let zoomLevel = 1.0;
        
        // --- 歷史紀錄功能變數 ---
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        let historyStack = [];
        let redoStack = [];
        let stateBeforeDrag = null;

        // --- 輔助函式：取得事件座標 ---
        function getEventCoords(e) {
            if (e.touches && e.touches.length) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        // --- 輔助函式：Hex 轉 RGB ---
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) {
                r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length == 7) {
                r = parseInt(hex.substring(1, 3), 16); g = parseInt(hex.substring(3, 5), 16); b = parseInt(hex.substring(5, 7), 16);
            }
            return { r, g, b };
        }
        
        // 更新透明度滑桿文字
        opacitySlider.oninput = function() {
            opacityValue.innerText = this.value;
        }

        // --- 功能 A: 視圖縮放 ---
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomResetBtn = document.getElementById('zoomResetBtn');
        function updateZoom() { canvas.style.transform = `scale(${zoomLevel})`; }
        zoomInBtn.onclick = () => { zoomLevel = Math.min(zoomLevel + 0.1, 3.0); updateZoom(); };
        zoomOutBtn.onclick = () => { zoomLevel = Math.max(zoomLevel - 0.1, 0.2); updateZoom(); };
        zoomResetBtn.onclick = () => { zoomLevel = 1.0; updateZoom(); };
        
        
        // --- (*** 重構 ***) 功能 B: 歷史紀錄 (Undo/Redo) ---
        
        // B-1: 取得目前狀態 (新架構)
        function getCurrentState() {
            const layoutData = {
                rooms: [],
                furniture: [] // (新) 家具現在是頂層
            };
            
            // 儲存所有房間
            canvas.querySelectorAll('.room').forEach(room => {
                layoutData.rooms.push({
                    left: room.style.left, top: room.style.top,
                    width: room.style.width, height: room.style.height,
                    cmWidth: room.dataset.cmWidth, cmHeight: room.dataset.cmHeight,
                    label: room.dataset.label,
                    fontSize: room.dataset.fontSize // (新) 儲存文字大小
                });
            });
            
            // 儲存所有家具
            canvas.querySelectorAll('.furniture').forEach(f => {
                layoutData.furniture.push({
                    left: f.style.left, top: f.style.top,
                    width: f.style.width, height: f.style.height,
                    color: f.dataset.colorHex, opacity: f.dataset.opacity,
                    shape: f.style.borderRadius === '50%' ? 'circle' : 'rectangle',
                    label: f.dataset.label,
                    cmWidth: f.dataset.cmWidth, cmHeight: f.dataset.cmHeight,
                    fontSize: f.dataset.fontSize // (新) 儲存文字大小
                });
            });
            return layoutData;
        }

        // B-2: 載入狀態 (新架構)
        function loadLayout(layoutData) {
            clearCanvas(false); // 清空畫布，但不儲存歷史
            
            if (!layoutData) { console.error("Invalid layout data to load."); return; }
            
            // 載入房間
            (layoutData.rooms || []).forEach((roomData) => {
                const fontSize = roomData.fontSize || 14; // (新)
                const room = createRoomElement(roomData.cmWidth, roomData.cmHeight, roomData.label, fontSize);
                room.style.left = roomData.left; room.style.top = roomData.top;
                canvas.appendChild(room); // (新) 加入 canvas
                
                makeRoomDraggable(room);
                room.addEventListener('click', (e) => { e.stopPropagation(); setActiveRoom(room); });
                room.addEventListener('touchstart', (e) => { e.stopPropagation(); }); 
            });
            
            // 載入家具
            (layoutData.furniture || []).forEach(furnData => {
                const opacity = furnData.opacity || 1; 
                const fontSize = furnData.fontSize || 14; // (新)
                const furniture = createFurnitureElement(furnData.cmWidth, furnData.cmHeight, furnData.shape, furnData.color, furnData.label, opacity, fontSize);
                furniture.style.left = furnData.left; furniture.style.top = furnData.top;
                canvas.appendChild(furniture); // (新) 加入 canvas
                
                makeFurnitureDraggable(furniture);
                furniture.addEventListener('click', (e) => { e.stopPropagation(); setActiveFurniture(furniture); });
                furniture.addEventListener('touchstart', (e) => { e.stopPropagation(); setActiveFurniture(furniture); });
            });
        }
        
        // B-3: 更新 Undo/Redo 按鈕狀態
        function updateUndoRedoButtons() {
            undoBtn.disabled = historyStack.length === 0;
            redoBtn.disabled = redoStack.length === 0;
        }

        // B-4: 儲存一個動作到歷史
        function saveStateForUndo() {
            redoStack = []; 
            historyStack.push(getCurrentState());
            if (historyStack.length > 50) historyStack.shift();
            updateUndoRedoButtons();
        }
        
        // B-5: 按下 Undo
        undoBtn.onclick = function() {
            if (historyStack.length === 0) return;
            redoStack.push(getCurrentState());
            loadLayout(historyStack.pop());
            updateUndoRedoButtons();
        };

        // B-6: 按下 Redo
        redoBtn.onclick = function() {
            if (redoStack.length === 0) return;
            historyStack.push(getCurrentState());
            loadLayout(redoStack.pop());
            updateUndoRedoButtons();
        };

        // --- 功能 C: 專案 (代碼匯入/匯出) ---
        const importTextBtn = document.getElementById('importTextBtn');
        const exportTextBtn = document.getElementById('exportTextBtn');
        const exportImageBtn = document.getElementById('exportImageBtn');
        const clearBtn = document.getElementById('clearBtn');
        const importExportArea = document.getElementById('importExportArea');

        // C-1: 匯出為代碼
        exportTextBtn.onclick = function() {
            importExportArea.value = JSON.stringify(getCurrentState(), null, 2);
            alert('代碼已匯出到上方的文字框！');
        };

        // C-2: 從代碼匯入
        importTextBtn.onclick = function() {
            const dataString = importExportArea.value;
            if (!dataString) { alert('請先在文字框中貼上佈局代碼。'); return; }
            let layoutData;
            try { layoutData = JSON.parse(dataString); } 
            catch (e) { alert('代碼格式錯誤，無法解析。\n' + e.message); return; }
            
            historyStack = []; // 匯入時清空所有歷史
            redoStack = [];
            loadLayout(layoutData);
            historyStack.push(getCurrentState()); // 把匯入的狀態當作「第一步」
            updateUndoRedoButtons();
            
            alert('佈局已從代碼載入！');
        };

        // C-3: 輸出圖片
        exportImageBtn.onclick = function() {
            if (typeof html2canvas === 'undefined') { alert('錯誤：圖片輸出函式庫載入失敗。'); return; }
            alert('正在準備輸出圖片... 請稍候。');
            setActiveRoom(null); setActiveFurniture(null);
            
            html2canvas(canvas, { useCORS: true, backgroundColor: '#e9ebee' })
            .then(canvasImage => {
                const link = document.createElement('a');
                link.download = 'my-layout.png';
                link.href = canvasImage.toDataURL('image/png');
                link.click();
            }).catch(err => { alert('輸出失敗: ' + err.message); });
        };

        // C-4: 清空畫布
        clearBtn.onclick = function() {
            if (confirm('確定要清空所有房間和家具嗎？')) {
                saveStateForUndo(); 
                clearCanvas(false); 
                updateUndoRedoButtons();
            }
        };
        
        function clearCanvas(saveHistory = true) {
            if (saveHistory) saveStateForUndo();
            canvas.innerHTML = '';
            activeRoom = null;
            activeFurniture = null;
            if (saveHistory) updateUndoRedoButtons();
        }

        // --- (*** 重構 ***) 功能 D: 選取管理 (已修復BUG) ---
        
        canvasWrapper.addEventListener('click', function(e) {
             if (e.target === canvasWrapper || e.target === canvas) {
                setActiveRoom(null);
                setActiveFurniture(null);
            }
        });
        canvasWrapper.addEventListener('touchstart', function(e) {
             if (e.target === canvasWrapper || e.target === canvas) {
                setActiveRoom(null);
                setActiveFurniture(null);
            }
        });
        
        // D-1: 設定選中房間
        function setActiveRoom(room) {
            if (activeRoom) activeRoom.classList.remove('room-active');
            if (activeFurniture) activeFurniture.classList.remove('furniture-active');
            
            activeFurniture = null; // (*** 修正 ***) 選房間時，一定取消家具
            activeRoom = room;
            
            if (room) {
                room.classList.add('room-active');
                document.getElementById('roomWidth').value = room.dataset.cmWidth;
                document.getElementById('roomHeight').value = room.dataset.cmHeight;
                document.getElementById('roomLabel').value = room.dataset.label;
                document.getElementById('roomFontSize').value = room.dataset.fontSize || 14; // (新)
            }
        }
        
        // D-2: 設定選中家具
        function setActiveFurniture(furniture) {
            if (activeRoom) activeRoom.classList.remove('room-active');
            if (activeFurniture) activeFurniture.classList.remove('furniture-active');
            
            activeRoom = null; // (*** 修正 ***) 選家具時，一定取消房間
            activeFurniture = furniture;
            
            if (furniture) {
                furniture.classList.add('furniture-active');
                
                document.getElementById('furnWidth').value = furniture.dataset.cmWidth;
                document.getElementById('furnHeight').value = furniture.dataset.cmHeight;
                document.getElementById('furnLabel').value = furniture.dataset.label;
                document.getElementById('furnColor').value = furniture.dataset.colorHex;
                document.getElementById('furnShape').value = furniture.style.borderRadius === '50%' ? 'circle' : 'rectangle';
                document.getElementById('furnFontSize').value = furniture.dataset.fontSize || 14; // (新)
                
                const opacity = (furniture.dataset.opacity || 1) * 100;
                opacitySlider.value = opacity;
                opacityValue.innerText = Math.round(opacity);
                
                // (*** 移除 ***) 
                // 不再需要 setActiveRoom(furniture.parentElement)，因為父元素是 canvas
                // 這也自然修復了你提的刪除 BUG
            }
        }

        // --- 功能 E: 編輯 / 刪除 (已修正) ---
        const updateBtn = document.getElementById('updateBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        // E-1: 刪除 (已修正)
        deleteBtn.onclick = function() {
            if (activeFurniture) {
                if (confirm(`確定要刪除選中的家具 "${activeFurniture.dataset.label}" 嗎？`)) {
                    saveStateForUndo(); 
                    activeFurniture.remove();
                    activeFurniture = null;
                }
            } else if (activeRoom) {
                if (confirm(`確定要刪除選中的房間 "${activeRoom.dataset.label}" 嗎？`)) {
                    saveStateForUndo();
                    activeRoom.remove();
                    activeRoom = null;
                }
            } else {
                alert('請先點擊一個房間或家具來選取。');
            }
        };

        // E-2: 更新 (新)
        updateBtn.onclick = function() {
            saveStateForUndo();
            
            if (activeFurniture) {
                try {
                    const width = document.getElementById('furnWidth').value, height = document.getElementById('furnHeight').value;
                    const label = document.getElementById('furnLabel').value, color = document.getElementById('furnColor').value;
                    const shape = document.getElementById('furnShape').value, opacity = opacitySlider.value / 100;
                    const fontSize = document.getElementById('furnFontSize').value; // (新)
                    
                    activeFurniture.dataset.cmWidth = width; activeFurniture.dataset.cmHeight = height;
                    activeFurniture.dataset.label = label; activeFurniture.dataset.colorHex = color;
                    activeFurniture.dataset.opacity = opacity;
                    activeFurniture.dataset.fontSize = fontSize; // (新)
                    
                    activeFurniture.style.width = (width * SCALE) + 'px';
                    activeFurniture.style.height = (height * SCALE) + 'px';
                    activeFurniture.style.borderRadius = (shape === 'circle') ? '50%' : '0';
                    activeFurniture.style.setProperty('--font-size', fontSize + 'px'); // (新)
                    
                    const rgb = hexToRgb(color);
                    activeFurniture.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                    updateElementLabels(activeFurniture, 'furniture', label, width, height);
                    alert('家具已更新！');
                } catch (e) { alert('更新失敗: ' + e.message); }
                
            } else if (activeRoom) {
                 try {
                    const width = document.getElementById('roomWidth').value, height = document.getElementById('roomHeight').value;
                    const label = document.getElementById('roomLabel').value;
                    const fontSize = document.getElementById('roomFontSize').value; // (新)

                    activeRoom.dataset.cmWidth = width; activeRoom.dataset.cmHeight = height;
                    activeRoom.dataset.label = label;
                    activeRoom.dataset.fontSize = fontSize; // (新)

                    activeRoom.style.width = (width * SCALE) + 'px';
                    activeRoom.style.height = (height * SCALE) + 'px';
                    activeRoom.style.setProperty('--font-size', fontSize + 'px'); // (新)
                    
                    updateElementLabels(activeRoom, 'room', label, width, height);
                    alert('房間已更新！');
                } catch (e) { alert('更新失敗: ' + e.message); }
            } else {
                alert('請先點擊一個房間或家具來選取。');
                historyStack.pop(); 
                updateUndoRedoButtons();
            }
        };

        // --- (*** 重構 ***) 功能 F: 新增項目 ---

        // F-1: 新增房間
        addRoomBtn.onclick = function() {
            saveStateForUndo(); 
            
            const roomWidth = document.getElementById('roomWidth').value;
            const roomHeight = document.getElementById('roomHeight').value;
            const roomLabel = document.getElementById('roomLabel').value;
            const roomFontSize = document.getElementById('roomFontSize').value; // (新)

            const room = createRoomElement(roomWidth, roomHeight, roomLabel, roomFontSize);
            room.style.left = (canvasWrapper.scrollLeft + 50) / zoomLevel + 'px';
            room.style.top = (canvasWrapper.scrollTop + 50) / zoomLevel + 'px';
            makeRoomDraggable(room);
            
            room.addEventListener('click', (e) => { e.stopPropagation(); setActiveRoom(room); });
            room.addEventListener('touchstart', (e) => { e.stopPropagation(); });
            
            canvas.appendChild(room); // (新)
            setActiveRoom(room);
        };

        // F-2: 新增家具
        addFurnitureBtn.onclick = function() {
            // (*** 移除 ***) 不再需要 'if (!activeRoom)' 檢查
            
            saveStateForUndo(); 
            
            const width = document.getElementById('furnWidth').value, height = document.getElementById('furnHeight').value;
            const shape = document.getElementById('furnShape').value, color = document.getElementById('furnColor').value;
            const label = document.getElementById('furnLabel').value, opacity = opacitySlider.value / 100;
            const fontSize = document.getElementById('furnFontSize').value; // (新)
            
            const furniture = createFurnitureElement(width, height, shape, color, label, opacity, fontSize);
            furniture.style.left = (canvasWrapper.scrollLeft + 50) / zoomLevel + 'px';
            furniture.style.top = (canvasWrapper.scrollTop + 50) / zoomLevel + 'px';
            
            canvas.appendChild(furniture); // (新)
            makeFurnitureDraggable(furniture);
            
            furniture.addEventListener('click', (e) => { e.stopPropagation(); setActiveFurniture(furniture); });
            furniture.addEventListener('touchstart', (e) => { e.stopPropagation(); setActiveFurniture(furniture); });
            
            setActiveFurniture(furniture);
        };
        
        // --- 輔助功能：建立元素 DOM ---

        // G-1: 建立房間 (新)
        function createRoomElement(width, height, label, fontSize = 14) {
            const room = document.createElement('div');
            room.className = 'room';
            room.dataset.cmWidth = width; room.dataset.cmHeight = height;
            room.dataset.label = label; room.dataset.fontSize = fontSize; // (新)
            room.style.width = (width * SCALE) + 'px'; room.style.height = (height * SCALE) + 'px';
            room.style.setProperty('--font-size', fontSize + 'px'); // (新)
            updateElementLabels(room, 'room', label, width, height);
            return room;
        }

        // G-2: 建立家具 (新)
        function createFurnitureElement(width, height, shape, color, label, opacity = 1, fontSize = 14) {
            const furniture = document.createElement('div');
            furniture.className = 'furniture';
            furniture.dataset.cmWidth = width; furniture.dataset.cmHeight = height;
            furniture.dataset.label = label; furniture.dataset.colorHex = color;
            furniture.dataset.opacity = opacity; furniture.dataset.fontSize = fontSize; // (新)
            
            furniture.style.width = (width * SCALE) + 'px'; furniture.style.height = (height * SCALE) + 'px';
            furniture.style.setProperty('--font-size', fontSize + 'px'); // (新)
            
            const rgb = hexToRgb(color);
            furniture.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
            if (shape === 'circle') furniture.style.borderRadius = '50%';
            updateElementLabels(furniture, 'furniture', label, width, height);
            return furniture;
        }
        
        // G-3: 更新元素標籤
        function updateElementLabels(element, type, label, width, height) {
            element.innerHTML = '';
            const prefix = (type === 'room') ? 'room-' : '';
            const mainClass = (type === 'room') ? 'label-room-main' : 'label-main';
            const widthClass = (type === 'room') ? 'label-room-width' : 'label-width';
            const heightClass = (type === 'room') ? 'label-room-height' : 'label-height';

            const labelMain = document.createElement('span');
            labelMain.className = `${prefix}label ${mainClass}`;
            labelMain.innerText = label;
            
            const labelWidth = document.createElement('span');
            labelWidth.className = `${prefix}label ${widthClass}`;
            labelWidth.innerText = `${width} cm`;
            
            const labelHeight = document.createElement('span');
            labelHeight.className = `${prefix}label ${heightClass}`;
            labelHeight.innerText = `${height} cm`;
            
            element.appendChild(labelMain);
            element.appendChild(labelWidth);
            element.appendChild(labelHeight);
        }

        
        // --- (*** 重構 ***) 功能 H: 讓家具可拖曳 (支援觸控) ---
        function makeFurnitureDraggable(element) {
            let isDragging = false, offsetX, offsetY, elemWidth, elemHeight, preventOverlap, siblings, allRooms;

            function onDragStart(e) {
                e.stopPropagation(); 
                isDragging = true;
                stateBeforeDrag = getCurrentState();
                
                const { x, y } = getEventCoords(e);
                const rect = element.getBoundingClientRect();
                
                elemWidth = element.clientWidth; elemHeight = element.clientHeight;
                preventOverlap = document.getElementById('preventOverlap').checked;
                
                // (新) 取得所有兄弟家具 和 所有房間 (用於吸附)
                siblings = [];
                canvas.querySelectorAll('.furniture').forEach(f => { if (f !== element) siblings.push(f); });
                allRooms = canvas.querySelectorAll('.room'); // (新)
                
                const canvasRect = canvas.getBoundingClientRect(); // (新)
                offsetX = (x / zoomLevel) - (rect.left / zoomLevel);
                offsetY = (y / zoomLevel) - (rect.top / zoomLevel);
                
                element.dataset.lastValidX = element.offsetLeft;
                element.dataset.lastValidY = element.offsetTop;
                element.style.zIndex = 1001; // (新) 拖曳時最高
                element.style.transition = 'none';
                
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('touchend', onDragEnd);
            }

            function onDragMove(e) {
                if (!isDragging) return;
                if (e.touches) e.preventDefault();
                
                const { x, y } = getEventCoords(e);
                const canvasRect = canvas.getBoundingClientRect(); // (新)
                
                // (新) 計算相對於 canvas 的位置
                let newX = (x / zoomLevel) - (canvasRect.left / zoomLevel) - offsetX;
                let newY = (y / zoomLevel) - (canvasRect.top / zoomLevel) - offsetY;

                // 吸附邏輯
                if (document.getElementById('enableSnapping').checked) {
                    let snappedX = false, snappedY = false;
                    const myLeft = newX, myRight = newX + elemWidth, myTop = newY, myBottom = newY + elemHeight;
                    
                    // (新) 1. 吸附其他家具
                    for (const sibling of siblings) {
                        const sLeft = sibling.offsetLeft, sRight = sLeft + sibling.clientWidth, sTop = sibling.offsetTop, sBottom = sTop + sibling.clientHeight;
                        if (!snappedX) {
                            if (Math.abs(myLeft - sRight) < SNAP_DISTANCE) { newX = sRight; snappedX = true; }
                            else if (Math.abs(myRight - sLeft) < SNAP_DISTANCE) { newX = sLeft - elemWidth; snappedX = true; }
                            else if (Math.abs(myLeft - sLeft) < SNAP_DISTANCE) { newX = sLeft; snappedX = true; }
                            else if (Math.abs(myRight - sRight) < SNAP_DISTANCE) { newX = sRight - elemWidth; snappedX = true; }
                        }
                        if (!snappedY) {
                            if (Math.abs(myTop - sBottom) < SNAP_DISTANCE) { newY = sBottom; snappedY = true; }
                            else if (Math.abs(myBottom - sTop) < SNAP_DISTANCE) { newY = sTop - elemHeight; snappedY = true; }
                            else if (Math.abs(myTop - sTop) < SNAP_DISTANCE) { newY = sTop; snappedY = true; }
                            else if (Math.abs(myBottom - sBottom) < SNAP_DISTANCE) { newY = sBottom - elemHeight; snappedY = true; }
                        }
                        if(snappedX && snappedY) break;
                    }
                    
                    // (新) 2. 吸附房間邊框
                    for (const room of allRooms) {
                        const rLeft = room.offsetLeft, rRight = rLeft + room.clientWidth, rTop = room.offsetTop, rBottom = rTop + room.clientHeight;
                        if (!snappedX) {
                            if (Math.abs(myLeft - rLeft) < SNAP_DISTANCE) { newX = rLeft; snappedX = true; }
                            else if (Math.abs(myRight - rRight) < SNAP_DISTANCE) { newX = rRight - elemWidth; snappedX = true; }
                        }
                        if (!snappedY) {
                            if (Math.abs(myTop - rTop) < SNAP_DISTANCE) { newY = rTop; snappedY = true; }
                            else if (Math.abs(myBottom - rBottom) < SNAP_DISTANCE) { newY = rBottom - elemHeight; snappedY = true; }
                        }
                        if(snappedX && snappedY) break;
                    }
                }
                
                // (*** 移除 ***) 房間邊界檢查
                
                // 碰撞偵測 (只偵測其他家具)
                let isColliding = false;
                if (preventOverlap) {
                    for (const sibling of siblings) {
                        const sRect = { left: sibling.offsetLeft, top: sibling.offsetTop, right: sibling.offsetLeft + sibling.clientWidth, bottom: sibling.offsetTop + sibling.clientHeight };
                        const eRect = { left: newX, top: newY, right: newX + elemWidth, bottom: newY + elemHeight };
                        if (eRect.left < sRect.right && eRect.right > sRect.left && eRect.top < sRect.bottom && eRect.bottom > sRect.top) {
                            isColliding = true; break;
                        }
                    }
                }
                
                element.style.left = newX + 'px'; element.style.top = newY + 'px';
                
                if (isColliding) { element.classList.add('colliding'); } 
                else { element.classList.remove('colliding'); element.dataset.lastValidX = newX; element.dataset.lastValidY = newY; }
            }

            function onDragEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                
                const hasMoved = element.offsetLeft != element.dataset.lastValidX || element.offsetTop != element.dataset.lastValidY;
                if (hasMoved && stateBeforeDrag) {
                    redoStack = [];
                    historyStack.push(stateBeforeDrag);
                    updateUndoRedoButtons();
                }
                stateBeforeDrag = null;

                element.style.zIndex = '100'; // (新) 恢復 z-index
                element.style.transition = 'left 0.1s ease-out, top 0.1s ease-out, background-color 0.2s';
                if (element.classList.contains('colliding')) {
                    element.classList.remove('colliding');
                    element.style.left = element.dataset.lastValidX + 'px';
                    element.style.top = element.dataset.lastValidY + 'px';
                }
                
                document.removeEventListener('mousemove', onDragMove);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchmove', onDragMove);
                document.removeEventListener('touchend', onDragEnd);
                
                setActiveFurniture(element);
            }
            
            element.addEventListener('mousedown', onDragStart);
            element.addEventListener('touchstart', onDragStart, { passive: false });
        }
        
        // --- 功能 I: 讓房間可拖曳 (支援觸控) ---
        function makeRoomDraggable(element) {
            let isDragging = false, offsetX, offsetY, hasMoved = false; 

            function onDragStart(e) {
                if (e.type === 'mousedown' && e.button !== 0) return;
                isDragging = true; hasMoved = false;
                stateBeforeDrag = getCurrentState();
                
                element.style.cursor = 'grabbing';
                const { x, y } = getEventCoords(e);
                const rect = element.getBoundingClientRect();
                offsetX = (x / zoomLevel) - (rect.left / zoomLevel);
                offsetY = (y / zoomLevel) - (rect.top / zoomLevel);
                element.style.zIndex = '51'; 

                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('touchend', onDragEnd);
            }
            
            function onDragMove(e) {
                if (!isDragging) return;
                if (e.touches) e.preventDefault();
                hasMoved = true;
                
                const { x, y } = getEventCoords(e);
                const canvasRect = canvas.getBoundingClientRect();
                let newX = (x / zoomLevel) - (canvasRect.left / zoomLevel) - offsetX;
                let newY = (y / zoomLevel) - (canvasRect.top / zoomLevel) - offsetY;
                
                // 房間吸附 (只吸附其他房間)
                if (document.getElementById('enableSnapping').checked) {
                    let snappedX = false, snappedY = false;
                    const elemWidth = element.clientWidth, elemHeight = element.clientHeight;
                    const myLeft = newX, myRight = newX + elemWidth, myTop = newY, myBottom = newY + elemHeight;
                    const siblings = [];
                    canvas.querySelectorAll('.room').forEach(r => { if (r !== element) siblings.push(r); });

                    for (const sibling of siblings) {
                        const sLeft = sibling.offsetLeft, sRight = sLeft + sibling.clientWidth, sTop = sibling.offsetTop, sBottom = sTop + sibling.clientHeight;
                        if (!snappedX) {
                            if (Math.abs(myLeft - sRight) < SNAP_DISTANCE) { newX = sRight; snappedX = true; }
                            else if (Math.abs(myRight - sLeft) < SNAP_DISTANCE) { newX = sLeft - elemWidth; snappedX = true; }
                        }
                        if (!snappedY) {
                            if (Math.abs(myTop - sBottom) < SNAP_DISTANCE) { newY = sBottom; snappedY = true; }
                            else if (Math.abs(myBottom - sTop) < SNAP_DISTANCE) { newY = sTop - elemHeight; snappedY = true; }
                        }
                        if(snappedX && snappedY) break;
                    }
                }
                
                element.style.left = newX + 'px'; element.style.top = newY + 'px';
            }
            
            function onDragEnd(e) {
                if (!isDragging) return;
                isDragging = false;

                if (hasMoved && stateBeforeDrag) {
                    redoStack = [];
                    historyStack.push(stateBeforeDrag);
                    updateUndoRedoButtons();
                }
                stateBeforeDrag = null;

                element.style.cursor = 'grab';
                element.style.zIndex = '50';
                
                if (hasMoved) {
                    setActiveRoom(element);
                }

                document.removeEventListener('mousemove', onDragMove);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchmove', onDragMove);
                document.removeEventListener('touchend', onDragEnd);
            }

            element.addEventListener('mousedown', onDragStart);
            element.addEventListener('touchstart', onDragStart, { passive: false });
        }
        
        // --- 初始設定 ---
        updateUndoRedoButtons();
        historyStack.push(getCurrentState()); // 儲存空白的初始狀態

    </script>
</body>
</html>
