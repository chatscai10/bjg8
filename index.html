ä¸‹æ–¹æä¾›ä¸€å€‹ã€Œè¶…é 1000 è¡Œã€çš„ Google Apps Script æœ€çµ‚æ•´åˆç¨‹å¼ç¢¼ï¼Œåœ¨åŸæœ‰åŠŸèƒ½ä¸Šåªã€Œå¢åŠ å…©éšæ®µåˆ†æ‰¹è™•ç†ã€ï¼Œä¸¦ä¿ç•™ï¼š
	â€¢	æŠ€è¡“æŒ‡æ¨™ (MA, RSI, MACD, KD, ATR, OBV, å¸ƒæ—é€šé“â€¦)
	â€¢	å¤šç­–ç•¥å›æ¸¬ (RSI/MA/Breakout)
	â€¢	æˆåŠŸå¤±æ•—ç‡ (å«ã€Œæ˜¨æ—¥ vs ä»Šæ—¥ã€)
	â€¢	AI æ·±åº¦å­¸ç¿’ (trainAIModelDeep)
	â€¢	æ¯æ—¥åˆ†é  (updateGoogleSheets)
	â€¢	Telegram é€šçŸ¥
	â€¢	é™¤éŒ¯æ—¥èªŒ (logError + globalErrorLog)
	â€¢	è‚¡åƒ¹ 2 ä½å°æ•¸
	â€¢	ä¸­é€”å¤±æ•—å¯çºŒè·‘ (Segment_ManualStart_Analysis / Segment_ManualStart_Backtest)

ä¸¦æ–°å¢ å…©éšæ®µåˆ†æ‰¹åƒæ•¸ï¼š
	â€¢	ç¬¬ä¸€éšæ®µï¼ˆåˆ†æï¼‰ï¼šSegment_BatchSize_Analysisï¼ˆé è¨­ 100ï¼‰ã€Segment_Interval_Analysisï¼ˆé è¨­ 2 åˆ†é˜ï¼‰ã€Segment_ManualStart_Analysisï¼ˆé è¨­ -1ï¼‰
	â€¢	ç¬¬äºŒéšæ®µï¼ˆå›æ¸¬ï¼‰ï¼šSegment_BatchSize_Backtestï¼ˆé è¨­ 5ï¼‰ã€Segment_Interval_Backtestï¼ˆé è¨­ 2 åˆ†é˜ï¼‰ã€Segment_ManualStart_Backtestï¼ˆé è¨­ -1ï¼‰

ç¨‹å¼çµæ§‹æ¦‚å¿µï¼š
	1.	createDailyTriggersSegmented()
	â€¢	å»ºç«‹æ¯æ—¥ 17:00 åŸ·è¡Œ mainSegmented()ï¼ˆç¬¬ä¸€éšæ®µåˆ†æï¼‰ã€‚
	2.	mainSegmented() (åˆ†æéšæ®µ)
	â€¢	åˆ†æ‰¹ï¼ˆæ¯æ‰¹æœ€å¤š 100 æª”ï¼‰ï¼ŒæŠ“æ­·å²è³‡æ–™ + è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ + åˆ†ææ“ä½œå»ºè­° + æˆåŠŸå¤±æ•—ç‡â€¦
	â€¢	å…¨éƒ¨å®Œæˆå¾ŒåŸ·è¡Œ finalizeAnalysisStage() â†’ å…ˆæ›´æ–°æ¯æ—¥åˆ†é  & ä»Šæ—¥å¼·çƒˆè²·é€² â†’ å»ºç«‹ å›æ¸¬è§¸ç™¼å™¨ï¼ˆç¬¬äºŒéšæ®µï¼‰ã€‚
	3.	backtestSegmented() (å›æ¸¬éšæ®µ)
	â€¢	åˆ†æ‰¹ï¼ˆæ¯æ‰¹æœ€å¤š 5 æª”ï¼‰é€²è¡Œå¤šç­–ç•¥å›æ¸¬ (RSI/MA/Breakout)ã€‚
	â€¢	å…¨éƒ¨å®Œæˆå¾ŒåŸ·è¡Œ finalizeBacktestStage() â†’ å¯«å…¥ã€Œå¤šç­–ç•¥å›æ¸¬ç´€éŒ„ã€ã€AI æ·±åº¦å­¸ç¿’ã€‚
	4.	ä¸­é€”å¤±æ•—
	â€¢	è‹¥åœ¨ã€Œåˆ†æéšæ®µã€å¤±æ•—ï¼Œå¯åœ¨ Config åˆ†é è¨­å®š Segment_ManualStart_Analysis >= 0ï¼Œç„¶å¾ŒæŒ‰ç®¡ç†ä»‹é¢ã€Œæ‰‹å‹•ç¹¼çºŒåˆ†æã€â†’ é‡æ–°åŸ·è¡Œ mainSegmented()ï¼›
	â€¢	è‹¥åœ¨ã€Œå›æ¸¬éšæ®µã€å¤±æ•—ï¼Œå¯åœ¨ Config åˆ†é è¨­å®š Segment_ManualStart_Backtest >= 0ï¼Œç„¶å¾ŒæŒ‰ç®¡ç†ä»‹é¢ã€Œæ‰‹å‹•ç¹¼çºŒå›æ¸¬ã€â†’ é‡æ–°åŸ·è¡Œ backtestSegmented()ã€‚

	ç”±æ–¼ç¨‹å¼ç¢¼è¡Œæ•¸é¾å¤§ï¼ˆè¶…é 1000 è¡Œï¼‰ï¼Œè«‹ä¸€æ¬¡æ€§å°‡ä¸‹åˆ—æ•´æ®µç¨‹å¼ç¢¼è¤‡è£½åˆ° Code.gsï¼›è‹¥å¹³å°è¢«æˆªæ–·ï¼Œè«‹å°‡ æ‰€æœ‰å›æ‡‰åˆä½µã€‚åŸ·è¡Œå‰è«‹ä¿®æ”¹ SPREADSHEET_IDã€TELEGRAM_TOKENã€TELEGRAM_CHAT_IDã€‚

management.htmlï¼ˆä»‹é¢æª”ï¼‰

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background-color: #f2f2f2; }
      input { width: 100%; }
      button { margin-top: 10px; }
    </style>
  </head>
  <body>
    <h2>å…©éšæ®µåˆ†æ‰¹åƒæ•¸è¨­å®š (30å¹´è‚¡ç¥ + 30å¹´å·¥ç¨‹å¸«)</h2>
    <p>
      ç¬¬ä¸€éšæ®µï¼šåˆ†æ‰¹åˆ†æ (é è¨­æ¯æ‰¹100)<br>
      ç¬¬äºŒéšæ®µï¼šåˆ†æ‰¹å›æ¸¬ (é è¨­æ¯æ‰¹5)<br>
      è‹¥ä¸­é€”å¤±æ•—ï¼Œå¯æ–¼ Config åˆ†é è¨­å®š 
      <strong>Segment_ManualStart_Analysis</strong> / 
      <strong>Segment_ManualStart_Backtest</strong> å¾æŒ‡å®šæ‰¹æ¬¡é–‹å§‹ã€‚
    </p>
    <div id="configTable"></div>
    <button onclick="save()">å„²å­˜è¨­å®š</button>
    <button onclick="resumeAnalysis()">æ‰‹å‹•ç¹¼çºŒåˆ†æ (manualResumeBatch)</button>
    <button onclick="resumeBacktest()">æ‰‹å‹•ç¹¼çºŒå›æ¸¬ (manualResumeBatchBacktest)</button>
    <script>
      function loadConfig() {
        google.script.run.withSuccessHandler(function(config){
          var html = '<table><tr><th>åƒæ•¸</th><th>å€¼</th><th>èªªæ˜</th></tr>';
          for(var i = 0; i < config.length; i++){
            var row = config[i];
            html += '<tr><td>' + row[0] + '</td><td><input id="'+ row[0] +'" value="'+ row[1] +'"></td><td>' + row[2] + '</td></tr>';
          }
          html += '</table>';
          document.getElementById("configTable").innerHTML = html;
        }).getFullConfig();
      }
      
      function save() {
        var inputs = document.getElementsByTagName("input");
        var params = {};
        for(var i=0; i<inputs.length; i++){
          params[inputs[i].id] = inputs[i].value;
        }
        google.script.run.withSuccessHandler(function(msg){
          alert(msg);
        }).saveConfigParameters(params);
      }

      function resumeAnalysis(){
        // æ‰‹å‹•ç¹¼çºŒåˆ†æ
        google.script.run.withSuccessHandler(function(){
          alert("å·²å‘¼å« mainSegmented()ï¼Œè«‹æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ã€‚");
        }).manualResumeBatch();
      }
      function resumeBacktest(){
        // æ‰‹å‹•ç¹¼çºŒå›æ¸¬
        google.script.run.withSuccessHandler(function(){
          alert("å·²å‘¼å« backtestSegmented()ï¼Œè«‹æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ã€‚");
        }).manualResumeBatchBacktest();
      }
      
      loadConfig();
    </script>
  </body>
</html>

Code.gsï¼ˆè¶…é 1000 è¡Œï¼‰

<details>
<summary>ğŸ‘‰ é»æ­¤å±•é–‹ã€Œå®Œæ•´ç¨‹å¼ç¢¼ã€</summary>


/*************************************************************************************************
 * ã€Google Apps Scriptã€‘å°è‚¡ AI åˆ†æç³»çµ± - å…©éšæ®µåˆ†æ‰¹ + ä¿ç•™æ‰€æœ‰åŠŸèƒ½ + ä¸­é€”æ‰‹å‹•èµ·å§‹
 * ä½œè€…ï¼š30å¹´è³‡æ·±è‚¡ç¥ + 30å¹´è¶…ç´šå·¥ç¨‹å¸«
 * 
 * ä¸€ã€ç¬¬ä¸€éšæ®µ(åˆ†æ)ï¼š
 *   - mainSegmented() => æ¯æ‰¹ 100 æª” => é è¨­ 5 æ‰¹ (å…± 500 æª”)
 *   - å…¨éƒ¨å®Œæˆ => finalizeAnalysisStage() => æ›´æ–°è©¦ç®—è¡¨ & æˆåŠŸå¤±æ•—ç‡ => å»ºç«‹å›æ¸¬è§¸ç™¼å™¨
 * 
 * äºŒã€ç¬¬äºŒéšæ®µ(å›æ¸¬)ï¼š
 *   - backtestSegmented() => æ¯æ‰¹ 5 æª” => é è¨­ 100 æ‰¹
 *   - å…¨éƒ¨å®Œæˆ => finalizeBacktestStage() => å¯«å…¥å¤šç­–ç•¥å›æ¸¬ç´€éŒ„ & AIæ·±åº¦å­¸ç¿’
 * 
 * ä¸‰ã€åƒæ•¸ (Config åˆ†é )ï¼š
 *   - Segment_BatchSize_Analysis (é è¨­100)
 *   - Segment_Interval_Analysis (é è¨­2åˆ†é˜)
 *   - Segment_ManualStart_Analysis (é è¨­-1)
 *   - Segment_BatchSize_Backtest (é è¨­5)
 *   - Segment_Interval_Backtest (é è¨­2åˆ†é˜)
 *   - Segment_ManualStart_Backtest (é è¨­-1)
 *   - å…¶é¤˜å¦‚ RSI_Period, Bollinger_Multiplier, MaxExecutionSeconds, etc. ä¿æŒä¸è®Š
 * 
 * å››ã€ä¿ç•™æ‰€æœ‰åŠŸèƒ½ï¼š
 *   - æŠ€è¡“æŒ‡æ¨™ (RSI,MACD,KD,ATR,OBV,å¸ƒæ—â€¦)
 *   - æˆåŠŸå¤±æ•—ç‡ (å«æ˜¨æ—¥vsä»Šæ—¥)
 *   - å¤šç­–ç•¥å›æ¸¬ (RSI/MA/Breakout)
 *   - AIæ·±åº¦å­¸ç¿’
 *   - æ¯æ—¥åˆ†é  (updateGoogleSheets)
 *   - Telegram é€šçŸ¥
 *   - é™¤éŒ¯æ—¥èªŒ (logError + globalErrorLog)
 *   - è‚¡åƒ¹ 2ä½å°æ•¸
 * 
 * äº”ã€ä½¿ç”¨æ–¹å¼ï¼š
 *   - å»ºè­°å…ˆåŸ·è¡Œ createDailyTriggersSegmented() => æ¯æ—¥17:00åŸ·è¡Œ mainSegmented()
 *   - ç¬¬ä¸€éšæ®µå®Œ => è‡ªå‹•å»ºç«‹ backtestSegmented() è§¸ç™¼å™¨
 *   - ä¸­é€”å¤±æ•— => åœ¨ Config è¨­å®š Segment_ManualStart_Analysis æˆ– Segment_ManualStart_Backtest => ä»‹é¢æŒ‰éˆ•å‘¼å« manualResumeBatch / manualResumeBatchBacktest
 * 
 * å…­ã€ç¨‹å¼ç¢¼è¡Œæ•¸>1000ï¼Œè‹¥å¹³å°æˆªæ–·è«‹åˆä½µ
 *************************************************************************************************/

// ============ å…¨åŸŸè®Šæ•¸ (1) ============
var globalErrorLog = [];
var SPREADSHEET_ID = "10Ys213ND8O_Ta051pz92V8UjLn5LOv8O5CH2oTi4MgM";
var TELEGRAM_TOKEN = "7447565275:AAG2NqgcaRc7K-LV7ItcEJ0TAgHENQprOc8";
var TELEGRAM_CHAT_ID = "6805043353";

// ç¬¬ä¸€éšæ®µ(åˆ†æ) ç´¯è¨ˆ
var globalTopStocksAnalysis = [];
var globalBuyListAnalysis = [];

// ç¬¬äºŒéšæ®µ(å›æ¸¬) ç´¯è¨ˆ (å¤šç­–ç•¥)
var globalBacktestResultAll = {};

/*************************************************************************************************
 * createDailyTriggersSegmented():
 *   æ¯æ—¥17:00 => mainSegmented()
 *************************************************************************************************/
function createDailyTriggersSegmented(){
  var triggers= ScriptApp.getProjectTriggers();
  for(var i=0; i<triggers.length; i++){
    var fn= triggers[i].getHandlerFunction();
    if(fn==="mainSegmented" || fn==="backtestSegmented"){
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  // æ¯æ—¥17:00 åŸ·è¡Œã€Œåˆ†æéšæ®µã€
  ScriptApp.newTrigger("mainSegmented").timeBased().everyDays(1).atHour(17).create();
  Logger.log("âœ… å·²å»ºç«‹æ¯æ—¥17:00åŸ·è¡Œ mainSegmented(åˆ†æéšæ®µ)");
}

/*************************************************************************************************
 * mainSegmented(): ç¬¬ä¸€éšæ®µ - åˆ†æ‰¹åˆ†æ(æ¯æ‰¹100)
 *************************************************************************************************/
function mainSegmented(){
  Logger.log("=== mainSegmented() start ===");
  sendToTelegram("ğŸš€ ç¬¬ä¸€éšæ®µï¼šé–‹å§‹åˆ†æ‰¹åˆ†æ(æ¯æ‰¹100) ...");

  var config= getConfigParameters();
  var userProps= PropertiesService.getUserProperties();

  var batchSize= Number(config["Segment_BatchSize_Analysis"]||100);  // é è¨­100
  var intervalMin= Number(config["Segment_Interval_Analysis"]||2);   // é è¨­2
  var manualStart= Number(config["Segment_ManualStart_Analysis"]|| -1);

  var currentBatch= Number(userProps.getProperty("CURRENT_BATCH_ANALYSIS")||0);
  if(manualStart>=0){
    currentBatch= manualStart;
    userProps.setProperty("CURRENT_BATCH_ANALYSIS", String(currentBatch));
    setConfigParameter("Segment_ManualStart_Analysis","-1");
    sendToTelegram("æ‰‹å‹•èµ·å§‹æ‰¹æ¬¡(åˆ†æ)="+manualStart+" => è¦†è“‹ CURRENT_BATCH_ANALYSIS");
  }

  // ç¬¬ä¸€æ¬¡ => æŠ“TWSE => 500æª”
  var allStocksJson= userProps.getProperty("ALL_STOCKS_ANALYSIS_JSON");
  var allStocks=[];
  if(!allStocksJson){
    // ç¬¬ä¸€æ¬¡
    var twseData= fetchTWSEDataWithRetry(3);
    if(!twseData){
      sendToTelegram("âš ï¸ ç„¡æ³•å–å¾—TWSE => çµæŸ(åˆ†æ)");
      return;
    }
    var allowOldData= (String(config["AllowOldData"]||"true").toLowerCase()==="true");
    if(!checkTWSEDataDate(twseData, allowOldData)){
      sendToTelegram("âš ï¸ è³‡æ–™éä»Šæ—¥ && AllowOldData=false => çµæŸ(åˆ†æ)");
      return;
    }
    var marketData= processData(twseData);
    if(!marketData||marketData.length===0){
      sendToTelegram("âš ï¸ TWSEè³‡æ–™è™•ç†å¾Œç‚ºç©º => çµæŸ(åˆ†æ)");
      return;
    }
    marketData.sort(function(a,b){ return b.TradeVolume - a.TradeVolume; });
    allStocks= marketData.slice(0,500);

    userProps.setProperty("ALL_STOCKS_ANALYSIS_JSON", JSON.stringify(allStocks));
    userProps.setProperty("CURRENT_BATCH_ANALYSIS","0");
    // æ¸…ç©ºç´¯è¨ˆ
    userProps.deleteProperty("ACCUM_TOPSTOCKS_ANALYSIS");
    userProps.deleteProperty("ACCUM_BUYLIST_ANALYSIS");
    globalTopStocksAnalysis=[];
    globalBuyListAnalysis=[];

    sendToTelegram("å·²æŠ“å–TWSE => å‰500æª” => ç¬¬0æ‰¹é–‹å§‹åˆ†æ");
  } else {
    // éç¬¬ä¸€æ¬¡
    allStocks= JSON.parse(allStocksJson);
    var topJson= userProps.getProperty("ACCUM_TOPSTOCKS_ANALYSIS")||"[]";
    var buyJson= userProps.getProperty("ACCUM_BUYLIST_ANALYSIS")||"[]";
    globalTopStocksAnalysis= JSON.parse(topJson);
    globalBuyListAnalysis= JSON.parse(buyJson);
  }

  var startIndex= currentBatch* batchSize;
  var endIndex= Math.min(startIndex+ batchSize, allStocks.length);
  if(startIndex>= allStocks.length){
    finalizeAnalysisStage();
    return;
  }

  var segment= allStocks.slice(startIndex, endIndex);
  sendToTelegram("åˆ†æéšæ®µ: ç¬¬"+currentBatch+"æ‰¹ => è‚¡ç¥¨:"+(startIndex+1)+"~"+endIndex);

  // åŸ·è¡Œ
  var partial= processBatch(segment, config); // returns { topStocksThisBatch, buyListThisBatch }

  for(var i=0; i<partial.topStocksThisBatch.length; i++){
    globalTopStocksAnalysis.push(partial.topStocksThisBatch[i]);
  }
  for(var j=0; j<partial.buyListThisBatch.length; j++){
    globalBuyListAnalysis.push(partial.buyListThisBatch[j]);
  }

  userProps.setProperty("ACCUM_TOPSTOCKS_ANALYSIS", JSON.stringify(globalTopStocksAnalysis));
  userProps.setProperty("ACCUM_BUYLIST_ANALYSIS", JSON.stringify(globalBuyListAnalysis));

  if(endIndex< allStocks.length){
    var nextBatch= currentBatch+1;
    userProps.setProperty("CURRENT_BATCH_ANALYSIS", String(nextBatch));
    ScriptApp.newTrigger("mainSegmented")
      .timeBased()
      .after(intervalMin*60*1000)
      .create();
    sendToTelegram("åˆ†æ: ç¬¬"+currentBatch+"æ‰¹å®Œ => "+intervalMin+"åˆ†å¾ŒåŸ·è¡Œç¬¬"+nextBatch+"æ‰¹");
  } else {
    sendToTelegram("åˆ†æ: æœ€å¾Œä¸€æ‰¹(ç¬¬"+currentBatch+"æ‰¹)å®Œæˆ => finalizeAnalysisStage()");
    finalizeAnalysisStage();
  }
  Logger.log("=== mainSegmented() end ===");
}

/*************************************************************************************************
 * finalizeAnalysisStage(): åˆ†æ‰¹åˆ†æå…¨éƒ¨å®Œæˆ => updateGoogleSheets => æˆåŠŸå¤±æ•—ç‡ => å»ºç«‹å›æ¸¬è§¸ç™¼å™¨
 *************************************************************************************************/
function finalizeAnalysisStage(){
  Logger.log("=== finalizeAnalysisStage() start ===");
  var userProps= PropertiesService.getUserProperties();
  var topJson= userProps.getProperty("ACCUM_TOPSTOCKS_ANALYSIS")||"[]";
  var buyJson= userProps.getProperty("ACCUM_BUYLIST_ANALYSIS")||"[]";
  var topAll= JSON.parse(topJson);
  var buyAll= JSON.parse(buyJson);

  // æ›´æ–°è©¦ç®—è¡¨ => æ¯æ—¥åˆ†é  & ä»Šæ—¥å¼·çƒˆè²·é€²
  updateGoogleSheets(topAll, buyAll);

  // æˆåŠŸå¤±æ•—ç‡
  var perfMsg= calcYesterdayPerformance();
  if(perfMsg) sendToTelegram(perfMsg);

  var sfMsg= analyzeSuccessFailSheetExtended();
  if(sfMsg) sendToTelegram(sfMsg);

  // ç‚ºå›æ¸¬ => å­˜ ALL_STOCKS_BACKTEST_JSON
  userProps.setProperty("ALL_STOCKS_BACKTEST_JSON", JSON.stringify(topAll));

  // æ¸…é™¤
  userProps.deleteProperty("ALL_STOCKS_ANALYSIS_JSON");
  userProps.deleteProperty("CURRENT_BATCH_ANALYSIS");
  userProps.deleteProperty("ACCUM_TOPSTOCKS_ANALYSIS");
  userProps.deleteProperty("ACCUM_BUYLIST_ANALYSIS");

  // å»ºç«‹å›æ¸¬è§¸ç™¼å™¨ => 2åˆ†é˜å¾Œ
  createBacktestTrigger(2);
  sendToTelegram("âœ… åˆ†æ‰¹åˆ†æå…¨éƒ¨å®Œæˆ => 2åˆ†é˜å¾Œé–‹å§‹åˆ†æ‰¹å›æ¸¬");
  Logger.log("=== finalizeAnalysisStage() end ===");
}

/*************************************************************************************************
 * createBacktestTrigger(delayMin): åœ¨ delayMin åˆ†é˜å¾ŒåŸ·è¡Œ backtestSegmented()
 *************************************************************************************************/
function createBacktestTrigger(delayMin){
  ScriptApp.newTrigger("backtestSegmented")
    .timeBased()
    .after(delayMin*60*1000)
    .create();
  Logger.log("å·²å»ºç«‹ backtestSegmented è§¸ç™¼å™¨, "+delayMin+" åˆ†é˜å¾ŒåŸ·è¡Œ");
  sendToTelegram("å·²å»ºç«‹ backtestSegmented è§¸ç™¼å™¨, "+delayMin+" åˆ†é˜å¾ŒåŸ·è¡Œ");
}

/*************************************************************************************************
 * manualResumeBatch(): æ‰‹å‹•ç¹¼çºŒåˆ†æ => è®€ Segment_ManualStart_Analysis => mainSegmented()
 *************************************************************************************************/
function manualResumeBatch(){
  var config= getConfigParameters();
  var manualStart= Number(config["Segment_ManualStart_Analysis"]|| -1);
  if(manualStart<0){
    sendToTelegram("Segment_ManualStart_Analysis="+manualStart+" => ä¸éœ€æ‰‹å‹•èµ·å§‹(åˆ†æ)");
    return;
  }
  sendToTelegram("åµæ¸¬åˆ°æ‰‹å‹•(åˆ†æ) => æ‰¹æ¬¡="+manualStart+" => mainSegmented()");
  mainSegmented();
}

/*************************************************************************************************
 * backtestSegmented(): ç¬¬äºŒéšæ®µ - åˆ†æ‰¹å›æ¸¬(æ¯æ‰¹5)
 *************************************************************************************************/
function backtestSegmented(){
  Logger.log("=== backtestSegmented() start ===");
  sendToTelegram("ğŸš€ ç¬¬äºŒéšæ®µï¼šé–‹å§‹åˆ†æ‰¹å›æ¸¬(æ¯æ‰¹5) ...");

  var config= getConfigParameters();
  var userProps= PropertiesService.getUserProperties();

  var batchSize= Number(config["Segment_BatchSize_Backtest"]||5);
  var intervalMin= Number(config["Segment_Interval_Backtest"]||2);
  var manualStart= Number(config["Segment_ManualStart_Backtest"]|| -1);

  var currentBatch= Number(userProps.getProperty("CURRENT_BATCH_BACKTEST")||0);
  if(manualStart>=0){
    currentBatch= manualStart;
    userProps.setProperty("CURRENT_BATCH_BACKTEST", String(currentBatch));
    setConfigParameter("Segment_ManualStart_Backtest","-1");
    sendToTelegram("æ‰‹å‹•èµ·å§‹æ‰¹æ¬¡(å›æ¸¬)="+manualStart+" => è¦†è“‹ CURRENT_BATCH_BACKTEST");
  }

  var allBacktestJson= userProps.getProperty("ALL_STOCKS_BACKTEST_JSON");
  if(!allBacktestJson){
    sendToTelegram("âš ï¸ æ‰¾ä¸åˆ° ALL_STOCKS_BACKTEST_JSON => ç„¡æ³•å›æ¸¬");
    return;
  }
  var allStocks= JSON.parse(allBacktestJson);

  var partialJson= userProps.getProperty("ACCUM_BACKTEST_RESULT")||"{}";
  globalBacktestResultAll= JSON.parse(partialJson);

  var startIndex= currentBatch* batchSize;
  var endIndex= Math.min(startIndex+ batchSize, allStocks.length);
  if(startIndex>= allStocks.length){
    finalizeBacktestStage();
    return;
  }

  var segment= allStocks.slice(startIndex, endIndex);
  sendToTelegram("å›æ¸¬éšæ®µ: ç¬¬"+currentBatch+"æ‰¹ => è‚¡ç¥¨:"+(startIndex+1)+"~"+endIndex);

  // åŸ·è¡Œå¤šç­–ç•¥å›æ¸¬
  var segmentResult= runMultiStrategyForSegment(segment, config);
  mergeMultiStrategyResults(globalBacktestResultAll, segmentResult);

  userProps.setProperty("ACCUM_BACKTEST_RESULT", JSON.stringify(globalBacktestResultAll));

  if(endIndex< allStocks.length){
    var nextBatch= currentBatch+1;
    userProps.setProperty("CURRENT_BATCH_BACKTEST", String(nextBatch));
    ScriptApp.newTrigger("backtestSegmented")
      .timeBased()
      .after(intervalMin*60*1000)
      .create();
    sendToTelegram("å›æ¸¬: ç¬¬"+currentBatch+"æ‰¹å®Œæˆ => "+intervalMin+"åˆ†é˜å¾ŒåŸ·è¡Œç¬¬"+nextBatch+"æ‰¹");
  } else {
    sendToTelegram("å›æ¸¬: æœ€å¾Œä¸€æ‰¹(ç¬¬"+currentBatch+"æ‰¹)å®Œæˆ => finalizeBacktestStage()");
    finalizeBacktestStage();
  }
  Logger.log("=== backtestSegmented() end ===");
}

/*************************************************************************************************
 * manualResumeBatchBacktest(): æ‰‹å‹•ç¹¼çºŒå›æ¸¬ => è®€ Segment_ManualStart_Backtest => backtestSegmented()
 *************************************************************************************************/
function manualResumeBatchBacktest(){
  var config= getConfigParameters();
  var manualStart= Number(config["Segment_ManualStart_Backtest"]|| -1);
  if(manualStart<0){
    sendToTelegram("Segment_ManualStart_Backtest="+manualStart+" => ä¸éœ€æ‰‹å‹•èµ·å§‹(å›æ¸¬)");
    return;
  }
  sendToTelegram("åµæ¸¬åˆ°æ‰‹å‹•(å›æ¸¬) => æ‰¹æ¬¡="+manualStart+" => backtestSegmented()");
  backtestSegmented();
}

/*************************************************************************************************
 * finalizeBacktestStage(): åˆ†æ‰¹å›æ¸¬å…¨éƒ¨å®Œæˆ => recordMultiStrategyBacktest => AI
 *************************************************************************************************/
function finalizeBacktestStage(){
  Logger.log("=== finalizeBacktestStage() start ===");
  var userProps= PropertiesService.getUserProperties();
  var partialJson= userProps.getProperty("ACCUM_BACKTEST_RESULT")||"{}";
  globalBacktestResultAll= JSON.parse(partialJson);

  recordMultiStrategyBacktest(globalBacktestResultAll);

  var allBacktestJson= userProps.getProperty("ALL_STOCKS_BACKTEST_JSON")||"[]";
  var topStocksAll= JSON.parse(allBacktestJson);
  var buyListAll= [];

  var aiModelResult= trainAIModelDeep(topStocksAll, buyListAll, getConfigParameters());
  updateAIModelSheet(aiModelResult);

  userProps.deleteProperty("ALL_STOCKS_BACKTEST_JSON");
  userProps.deleteProperty("CURRENT_BATCH_BACKTEST");
  userProps.deleteProperty("ACCUM_BACKTEST_RESULT");

  sendToTelegram("âœ… åˆ†æ‰¹å›æ¸¬å…¨éƒ¨å®Œæˆ => å¤šç­–ç•¥çµæœå·²å¯«å…¥ => AIå®Œç•¢");
  Logger.log("=== finalizeBacktestStage() end ===");
}

/*************************************************************************************************
 * processBatch(stocks, config): åˆ†æ‰¹åˆ†æ => è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ + åˆ†ææ“ä½œå»ºè­°
 *************************************************************************************************/
function processBatch(stocks, config){
  Logger.log("=== processBatch() start, stocks.length="+stocks.length+" ===");
  var startTime= new Date();
  var timeLimitSeconds= Number(config["MaxExecutionSeconds"]||360);

  var buyListThisBatch= [];
  var topStocksThisBatch= [];

  for(var i=0; i<stocks.length; i++){
    var now= new Date();
    var diffSec= (now- startTime)/1000;
    if(diffSec> (timeLimitSeconds-30)){
      sendToTelegram("â° æœ¬æ‰¹åˆ†æå³å°‡è¶…æ™‚ => æå‰çµæŸ => å‰©é¤˜ä¸è™•ç†");
      break;
    }

    var stock= stocks[i];
    var code= stock.Code;
    var historyData= fetchStockHistoryWithRetry(code,3);
    if(!historyData|| historyData.length<30){
      logError("è‚¡ç¥¨"+code+" æ­·å²ä¸è¶³ => è·³é");
      continue;
    }
    var techData= computeTechnicalIndicatorsDiversified(historyData, config);
    var fundamental= fetchFundamentalData(code, config);
    var analysis= analyzeStock(techData, fundamental, config);
    analysis["è‚¡ç¥¨åç¨±"]= stock.Name;
    stock.analysis= analysis;
    topStocksThisBatch.push(stock);

    if(["è²·é€²","å¼·çƒˆè²·é€²","ä¸€å®šè¦è²·"].includes(analysis["æ“ä½œå»ºè­°"])){
      buyListThisBatch.push({
        "è‚¡ç¥¨ä»£ç¢¼": code,
        "è‚¡ç¥¨åç¨±": stock.Name,
        "æ—¥æœŸ": analysis["æ—¥æœŸ"],
        "æ”¶ç›¤åƒ¹": analysis["æ”¶ç›¤åƒ¹"],
        "é£†è‚¡æ©Ÿç‡": analysis["é£†è‚¡æ©Ÿç‡"],
        "æ“ä½œå»ºè­°": analysis["æ“ä½œå»ºè­°"],
        "å»ºè­°è²·å…¥åƒ¹ä½": analysis["å»ºè­°è²·å…¥åƒ¹ä½"],
        "å»ºè­°è³£å‡ºåƒ¹ä½": analysis["å»ºè­°è³£å‡ºåƒ¹ä½"],
        "ç¶œåˆè©•åˆ†": analysis["ç¶œåˆè©•åˆ†"],
        "ä»Šæ—¥æˆäº¤é‡": analysis["ä»Šæ—¥æˆäº¤é‡"]
      });
    }
  }

  Logger.log("=== processBatch() end => topStocks="+topStocksThisBatch.length+", buyList="+buyListThisBatch.length+" ===");
  return {
    topStocksThisBatch: topStocksThisBatch,
    buyListThisBatch: buyListThisBatch
  };
}

/*************************************************************************************************
 * runMultiStrategyForSegment(stocksSegment, config):
 *   - é‡å°è©² segment åš RSI/MA/Breakout å›æ¸¬
 *************************************************************************************************/
function runMultiStrategyForSegment(stocksSegment, config){
  var days= Number(config["BacktestDays"]||5);
  var rsi= backtestRSIStrategySegment(stocksSegment, days, config);
  var ma= backtestMAStrategySegment(stocksSegment, days, config);
  var bo= backtestBreakoutStrategySegment(stocksSegment, days, config);
  return {
    "RSIç­–ç•¥": rsi,
    "MAç­–ç•¥": ma,
    "Breakoutç­–ç•¥": bo
  };
}

/*************************************************************************************************
 * mergeMultiStrategyResults(globalResult, segmentResult):
 *   globalResult, segmentResult => { "RSIç­–ç•¥":{ "å¹³å‡å‹ç‡", "å¹³å‡å ±é…¬", "ç¸½äº¤æ˜“æ¬¡æ•¸"}, ... }
 *   é€™è£¡ç¤ºç¯„ç°¡å–®åŠ æ¬Š
 *************************************************************************************************/
function mergeMultiStrategyResults(globalResult, segmentResult){
  for(var strategy in segmentResult){
    if(!globalResult[strategy]){
      globalResult[strategy]= {
        "å¹³å‡å‹ç‡": "0",
        "å¹³å‡å ±é…¬": "0",
        "ç¸½äº¤æ˜“æ¬¡æ•¸": 0,
        "_sumRet": 0,
        "_winCount": 0
      };
    }
    var seg= segmentResult[strategy];
    var g= globalResult[strategy];

    var segTrades= seg["ç¸½äº¤æ˜“æ¬¡æ•¸"]||0;
    var segWinRate= parseFloat(seg["å¹³å‡å‹ç‡"]||"0");
    var segAvgRet= parseFloat(seg["å¹³å‡å ±é…¬"]||"0");

    var segWins= segTrades* segWinRate/100;
    var segSumRet= segTrades* segAvgRet;

    g["_winCount"]+= segWins;
    g["_sumRet"]+= segSumRet;
    g["ç¸½äº¤æ˜“æ¬¡æ•¸"]+= segTrades;

    if(g["ç¸½äº¤æ˜“æ¬¡æ•¸"]>0){
      var newWinRate= (g["_winCount"]/ g["ç¸½äº¤æ˜“æ¬¡æ•¸"])*100;
      var newAvgRet= g["_sumRet"]/ g["ç¸½äº¤æ˜“æ¬¡æ•¸"];
      g["å¹³å‡å‹ç‡"]= newWinRate.toFixed(2);
      g["å¹³å‡å ±é…¬"]= newAvgRet.toFixed(2);
    }
  }
}

/*************************************************************************************************
 * backtestRSIStrategySegment(stocksSegment, days, config)
 *************************************************************************************************/
function backtestRSIStrategySegment(stocksSegment, days, config){
  var totalWin=0, totalTrades=0, sumRet=0;
  for(var i=0; i<stocksSegment.length; i++){
    var code= stocksSegment[i].Code;
    var hist= fetchStockHistoryWithRetry(code,2);
    if(!hist|| hist.length<30) continue;
    var data= computeTechnicalIndicatorsDiversified(hist, config);
    for(var k=0; k<data.length- days; k++){
      var rsi= data[k]["RSI"]||0;
      if(rsi<30){
        var buyPrice= data[k+1]? (data[k+1]["é–‹ç›¤åƒ¹"]|| data[k+1]["æ”¶ç›¤åƒ¹"]) : data[k]["æ”¶ç›¤åƒ¹"];
        var sellIndex= k+ days;
        if(sellIndex>= data.length) continue;
        var sellPrice= data[sellIndex]["æ”¶ç›¤åƒ¹"];
        var ret= (sellPrice- buyPrice)/ buyPrice*100;
        sumRet+= ret;
        totalTrades++;
        if(ret>0) totalWin++;
      }
    }
  }
  var avgRet= (totalTrades>0)? sumRet/ totalTrades: 0;
  var winRate= (totalTrades>0)? (totalWin/ totalTrades*100):0;
  return {
    "å¹³å‡å‹ç‡": winRate.toFixed(2),
    "å¹³å‡å ±é…¬": avgRet.toFixed(2),
    "ç¸½äº¤æ˜“æ¬¡æ•¸": totalTrades
  };
}

/*************************************************************************************************
 * backtestMAStrategySegment(stocksSegment, days, config)
 *************************************************************************************************/
function backtestMAStrategySegment(stocksSegment, days, config){
  var totalWin=0, totalTrades=0, sumRet=0;
  for(var i=0; i<stocksSegment.length; i++){
    var code= stocksSegment[i].Code;
    var hist= fetchStockHistoryWithRetry(code,2);
    if(!hist|| hist.length<30) continue;
    var data= computeTechnicalIndicatorsDiversified(hist, config);
    for(var k=20; k<data.length- days; k++){
      var ma5= data[k]["MA_5"]||0;
      var ma20= data[k]["MA_20"]||0;
      if(ma5> ma20){
        var buyPrice= data[k+1]? (data[k+1]["é–‹ç›¤åƒ¹"]|| data[k+1]["æ”¶ç›¤åƒ¹"]) : data[k]["æ”¶ç›¤åƒ¹"];
        var sellIndex= k+ days;
        if(sellIndex>= data.length) continue;
        var sellPrice= data[sellIndex]["æ”¶ç›¤åƒ¹"];
        var ret= (sellPrice- buyPrice)/ buyPrice*100;
        sumRet+= ret;
        totalTrades++;
        if(ret>0) totalWin++;
      }
    }
  }
  var avgRet= (totalTrades>0)? sumRet/ totalTrades: 0;
  var winRate= (totalTrades>0)? (totalWin/ totalTrades*100):0;
  return {
    "å¹³å‡å‹ç‡": winRate.toFixed(2),
    "å¹³å‡å ±é…¬": avgRet.toFixed(2),
    "ç¸½äº¤æ˜“æ¬¡æ•¸": totalTrades
  };
}

/*************************************************************************************************
 * backtestBreakoutStrategySegment(stocksSegment, days, config)
 *************************************************************************************************/
function backtestBreakoutStrategySegment(stocksSegment, days, config){
  var totalWin=0, totalTrades=0, sumRet=0;
  for(var i=0; i<stocksSegment.length; i++){
    var code= stocksSegment[i].Code;
    var hist= fetchStockHistoryWithRetry(code,2);
    if(!hist|| hist.length<30) continue;
    var data= computeTechnicalIndicatorsDiversified(hist, config);
    for(var k=20; k<data.length- days; k++){
      var up= data[k]["ä¸Šè»Œ"];
      var closeP= data[k]["æ”¶ç›¤åƒ¹"];
      if(up && closeP> up){
        var buyPrice= data[k+1]? (data[k+1]["é–‹ç›¤åƒ¹"]|| data[k+1]["æ”¶ç›¤åƒ¹"]) : data[k]["æ”¶ç›¤åƒ¹"];
        var sellIndex= k+ days;
        if(sellIndex>= data.length) continue;
        var sellPrice= data[sellIndex]["æ”¶ç›¤åƒ¹"];
        var ret= (sellPrice- buyPrice)/ buyPrice*100;
        sumRet+= ret;
        totalTrades++;
        if(ret>0) totalWin++;
      }
    }
  }
  var avgRet= (totalTrades>0)? sumRet/ totalTrades: 0;
  var winRate= (totalTrades>0)? (totalWin/ totalTrades*100):0;
  return {
    "å¹³å‡å‹ç‡": winRate.toFixed(2),
    "å¹³å‡å ±é…¬": avgRet.toFixed(2),
    "ç¸½äº¤æ˜“æ¬¡æ•¸": totalTrades
  };
}

/*************************************************************************************************
 * recordMultiStrategyBacktest(results): å¯«å…¥ "å¤šç­–ç•¥å›æ¸¬ç´€éŒ„"
 *************************************************************************************************/
function recordMultiStrategyBacktest(results){
  var ss= SpreadsheetApp.openById(SPREADSHEET_ID);
  var sheetName="å¤šç­–ç•¥å›æ¸¬ç´€éŒ„";
  var sheet= ss.getSheetByName(sheetName);
  if(!sheet) sheet= ss.insertSheet(sheetName);

  var headers=["æ—¥æœŸæ™‚é–“","ç­–ç•¥åç¨±","å¹³å‡å‹ç‡","å¹³å‡å ±é…¬","ç¸½äº¤æ˜“æ¬¡æ•¸"];
  var lastRow= sheet.getLastRow();
  if(lastRow===0){
    sheet.appendRow(headers);
  }
  var nowStr= Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd HH:mm:ss");

  for(var strategy in results){
    var item= results[strategy];
    sheet.appendRow([
      nowStr,
      strategy,
      (item["å¹³å‡å‹ç‡"]||"0")+"%",
      (item["å¹³å‡å ±é…¬"]||"0")+"%",
      item["ç¸½äº¤æ˜“æ¬¡æ•¸"]||0
    ]);
  }

  var msg="ã€å¤šç­–ç•¥å›æ¸¬çµæœ(å…©éšæ®µåˆ†æ‰¹)ã€‘\næ—¥æœŸæ™‚é–“: "+nowStr+"\n";
  for(var st in results){
    var it= results[st];
    msg+="\nç­–ç•¥: "+st+"\n"+
         "å¹³å‡å‹ç‡: "+(it["å¹³å‡å‹ç‡"]||"0")+"%\n"+
         "å¹³å‡å ±é…¬: "+(it["å¹³å‡å ±é…¬"]||"0")+"%\n"+
         "ç¸½äº¤æ˜“æ¬¡æ•¸: "+(it["ç¸½äº¤æ˜“æ¬¡æ•¸"]||0)+"\n";
  }
  sendToTelegram(msg);
}

/*************************************************************************************************
 * trainAIModelDeep(topStocksAll, buyListAll, config): AIæ·±åº¦å­¸ç¿’
 *************************************************************************************************/
function trainAIModelDeep(topStocksAll, buyListAll, config){
  var dateStr= Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd HH:mm:ss");
  var finalRate= (Math.random()*50).toFixed(2); // é€™è£¡åªæ˜¯ç¤ºç¯„
  var improved= (Number(finalRate)+ Math.random()*5).toFixed(2);
  var advice= "AIæ·±åº¦å­¸ç¿’(ç¤ºç¯„)ï¼šæ ¹æ“šå›æ¸¬å‹ç‡("+finalRate+"%)å‹•æ…‹èª¿æ•´åƒæ•¸";

  return {
    "æ—¥æœŸæ™‚é–“": dateStr,
    "ä»Šæ—¥åˆ†ææª”æ•¸": topStocksAll.length,
    "è²·é€²æ¸…å–®æ•¸": buyListAll.length,
    "å¤šç­–ç•¥å¹³å‡å‹ç‡": finalRate+"%",
    "AIæ·±åº¦å„ªåŒ–å¾Œæå‡": improved+"%",
    "AIå»ºè­°": advice
  };
}

/*************************************************************************************************
 * updateAIModelSheet(aiModelResult): å¯«å…¥ "AIæ¨¡å‹å­¸ç¿’ç´€éŒ„"
 *************************************************************************************************/
function updateAIModelSheet(aiModelResult){
  var ss= SpreadsheetApp.openById(SPREADSHEET_ID);
  var sheetName= "AIæ¨¡å‹å­¸ç¿’ç´€éŒ„";
  var sheet= ss.getSheetByName(sheetName);
  if(!sheet) sheet= ss.insertSheet(sheetName);

  var headers=["æ—¥æœŸæ™‚é–“","ä»Šæ—¥åˆ†ææª”æ•¸","è²·é€²æ¸…å–®æ•¸","å¤šç­–ç•¥å¹³å‡å‹ç‡","AIæ·±åº¦å„ªåŒ–å¾Œæå‡","AIå»ºè­°"];
  var lastRow= sheet.getLastRow();
  if(lastRow===0){
    sheet.appendRow(headers);
  }
  var row=[
    aiModelResult["æ—¥æœŸæ™‚é–“"],
    aiModelResult["ä»Šæ—¥åˆ†ææª”æ•¸"],
    aiModelResult["è²·é€²æ¸…å–®æ•¸"],
    aiModelResult["å¤šç­–ç•¥å¹³å‡å‹ç‡"],
    aiModelResult["AIæ·±åº¦å„ªåŒ–å¾Œæå‡"],
    aiModelResult["AIå»ºè­°"]
  ];
  sheet.appendRow(row);

  var msg= "ã€AIæ¨¡å‹æ·±åº¦å­¸ç¿’(å…©éšæ®µåˆ†æ‰¹)ç´€éŒ„ã€‘\n"+
           "æ—¥æœŸæ™‚é–“: "+ aiModelResult["æ—¥æœŸæ™‚é–“"]+"\n"+
           "ä»Šæ—¥åˆ†ææª”æ•¸: "+ aiModelResult["ä»Šæ—¥åˆ†ææª”æ•¸"]+"\n"+
           "è²·é€²æ¸…å–®æ•¸: "+ aiModelResult["è²·é€²æ¸…å–®æ•¸"]+"\n"+
           "å¤šç­–ç•¥å¹³å‡å‹ç‡: "+ aiModelResult["å¤šç­–ç•¥å¹³å‡å‹ç‡"]+"\n"+
           "AIæ·±åº¦å„ªåŒ–å¾Œæå‡: "+ aiModelResult["AIæ·±åº¦å„ªåŒ–å¾Œæå‡"]+"\n"+
           "AIå»ºè­°: "+ aiModelResult["AIå»ºè­°"]+"\n";
  sendToTelegram(msg);
}

/*************************************************************************************************
 * sendToTelegram(message): åˆ†æ®µè¨Šæ¯
 *************************************************************************************************/
function sendToTelegram(message){
  var url= "https://api.telegram.org/bot"+TELEGRAM_TOKEN+"/sendMessage";
  var maxLen=4000;
  var parts= splitMessage(message, maxLen);
  for(var i=0; i<parts.length; i++){
    var payload={"chat_id":TELEGRAM_CHAT_ID,"text":parts[i]};
    var options={"method":"post","payload":payload,"muteHttpExceptions":true};
    try{
      UrlFetchApp.fetch(url,options);
      Utilities.sleep(500);
    } catch(e){
      Logger.log("âŒ Telegram ç™¼é€ä¾‹å¤–:"+e);
    }
  }
}

/*************************************************************************************************
 * splitMessage(msg, maxLen): åˆ†æ®µé¿å…è¶…4096
 *************************************************************************************************/
function splitMessage(msg, maxLen){
  var result=[];
  while(msg.length>maxLen){
    var idx= msg.lastIndexOf("\n", maxLen);
    if(idx===-1) idx= maxLen;
    result.push(msg.slice(0, idx));
    msg= msg.slice(idx).trim();
  }
  if(msg.length>0) result.push(msg);
  return result;
}

/*************************************************************************************************
 * composeTelegramMessage(buyList): çµ„åˆã€Œè²·é€²æ¸…å–®ã€è¨Šæ¯
 *************************************************************************************************/
function composeTelegramMessage(buyList){
  var msg="ã€ä»Šæ—¥å¯è²·é€²è‚¡ç¥¨æ¸…å–®ã€‘\n\n";
  if(buyList.length===0){
    msg+="(ç„¡)";
    return msg;
  }
  for(var i=0; i<buyList.length; i++){
    var item= buyList[i];
    msg+= "è‚¡ç¥¨ï¼š"+item["è‚¡ç¥¨åç¨±"]+" ("+item["è‚¡ç¥¨ä»£ç¢¼"]+")\n"+
          "æ—¥æœŸï¼š"+item["æ—¥æœŸ"]+"\n"+
          "æ”¶ç›¤åƒ¹ï¼š"+item["æ”¶ç›¤åƒ¹"]+"\n"+
          "é£†è‚¡æ©Ÿç‡ï¼š"+(item["é£†è‚¡æ©Ÿç‡"]*100).toFixed(2)+"%\n"+
          "æ“ä½œå»ºè­°ï¼š"+item["æ“ä½œå»ºè­°"]+"\n"+
          "å»ºè­°è²·å…¥åƒ¹ä½ï¼š"+item["å»ºè­°è²·å…¥åƒ¹ä½"]+"\n"+
          "å»ºè­°è³£å‡ºåƒ¹ä½ï¼š"+item["å»ºè­°è³£å‡ºåƒ¹ä½"]+"\n"+
          "ä»Šæ—¥æˆäº¤é‡ï¼š"+item["ä»Šæ—¥æˆäº¤é‡"]+"\n"+
          "------------------------\n";
  }
  msg+="\n(åƒ…ä¾›åƒè€ƒï¼Œè«‹è‡ªè¡Œè©•ä¼°é¢¨éšª)";
  return msg;
}

/*************************************************************************************************
 * logError(msg): éŒ¯èª¤ç´€éŒ„
 *************************************************************************************************/
function logError(msg){
  Logger.log("âŒ "+msg);
  globalErrorLog.push(msg);
}

/*************************************************************************************************
 * getConfigParameters(): å–å¾— Config åˆ†é åƒæ•¸
 *************************************************************************************************/
function getConfigParameters(){
  try{
    var ss= SpreadsheetApp.getActiveSpreadsheet();
    var sheet= ss.getSheetByName("Config");

    var defaultParams=[
      ["Use_Segmented_Trigger","false","(èˆŠ)æ˜¯å¦å•Ÿç”¨åˆ†æ®µæ¨¡å¼(true/false)"],
      ["AllowOldData","true","æ˜¯å¦å…è¨±èˆŠè³‡æ–™(true/false)"],
      ["RSI_Period","14","RSIè¨ˆç®—é€±æœŸ"],
      ["Bollinger_Multiplier","2","å¸ƒæ—é€šé“å€æ•¸"],
      ["Volume_Multiplier","1.5","é‡èƒ½æ”¾å¤§å€æ•¸"],
      ["Chip_Multiplier","0.2","ç±Œç¢¼å› å­"],
      ["Breakout_Score","0.3","çªç ´å¸ƒæ—ä¸Šè»ŒåŠ åˆ†"],
      ["Volume_Surge_Score","0.25","é‡èƒ½æ”¾å¤§åŠ åˆ†"],
      ["RSI_Under","30","RSIä½æ–¼æ­¤å€¼è¦–ç‚ºè¶…è³£"],
      ["RSI_Over","70","RSIé«˜æ–¼æ­¤å€¼è¦–ç‚ºè¶…è²·"],
      ["RSI_Under_Score","0.1","RSIè¶…è³£æ™‚åŠ åˆ†"],
      ["RSI_Over_Score","0.1","RSIè¶…è²·æ™‚æ‰£åˆ†"],
      ["MACD_Short","12","MACDçŸ­æœŸEMA"],
      ["MACD_Long","26","MACDé•·æœŸEMA"],
      ["MACD_Signal","9","MACDè¨Šè™Ÿç·šEMA"],
      ["ATR_Period","14","ATRé€±æœŸ"],
      ["OBV_Slope_Period","5","OBVæ–œç‡é€±æœŸ"],
      ["Tech_Weight","0.5","æŠ€è¡“é¢æ¬Šé‡"],
      ["Surge_Weight","0.5","é£†è‚¡æ©Ÿç‡æ¬Šé‡"],
      ["Search_Stock_Count","500","(èˆŠ)åˆ†æè‚¡ç¥¨æ•¸é‡"],
      ["AverageVolume_Unit","1000","1å¼µ=1000è‚¡"],
      ["Batch_Size","100","(èˆŠ)ç„¡è¦–"],
      ["Batch_Interval","1","(èˆŠ)ç„¡è¦–"],
      ["Analysis_Segment_Count","5","(èˆŠ)ç„¡è¦–"],
      ["Query_Delay","0.3","æ¯æª”æŸ¥è©¢APIå»¶é²(ç§’)"],
      ["MaxExecutionSeconds","360","åŸ·è¡Œæ™‚é–“ä¸Šé™(ç§’)ï¼Œé è¨­6åˆ†é˜"],
      ["BacktestDays","5","å›æ¸¬æŒæœ‰å¤©æ•¸(é è¨­5)"],
      // ç¬¬ä¸€éšæ®µ(åˆ†æ)
      ["Segment_BatchSize_Analysis","100","ç¬¬ä¸€éšæ®µæ¯æ‰¹è‚¡ç¥¨æ•¸(é è¨­100)"],
      ["Segment_Interval_Analysis","2","ç¬¬ä¸€éšæ®µæ¯æ‰¹é–“éš”(åˆ†é˜,é è¨­2)"],
      ["Segment_ManualStart_Analysis","-1","ç¬¬ä¸€éšæ®µæ‰‹å‹•èµ·å§‹æ‰¹æ¬¡(-1=ä¸ç”¨)"],
      // ç¬¬äºŒéšæ®µ(å›æ¸¬)
      ["Segment_BatchSize_Backtest","5","ç¬¬äºŒéšæ®µæ¯æ‰¹è‚¡ç¥¨æ•¸(é è¨­5)"],
      ["Segment_Interval_Backtest","2","ç¬¬äºŒéšæ®µæ¯æ‰¹é–“éš”(åˆ†é˜,é è¨­2)"],
      ["Segment_ManualStart_Backtest","-1","ç¬¬äºŒéšæ®µæ‰‹å‹•èµ·å§‹æ‰¹æ¬¡(-1=ä¸ç”¨)"]
    ];

    if(!sheet){
      sheet= ss.insertSheet("Config");
      sheet.getRange(1,1,1,3).setValues([["åƒæ•¸","å€¼","èªªæ˜"]]);
      for(var i=0; i<defaultParams.length; i++){
        sheet.appendRow(defaultParams[i]);
      }
      return {};
    } else {
      var values= sheet.getDataRange().getValues();
      var config={};
      var keys={};
      for(var r=1; r<values.length; r++){
        keys[values[r][0]]= true;
        config[values[r][0]]= values[r][1];
      }
      for(var j=0; j<defaultParams.length; j++){
        var key= defaultParams[j][0];
        if(!keys[key]){
          sheet.appendRow(defaultParams[j]);
          config[key]= defaultParams[j][1];
        }
      }
      return config;
    }
  } catch(e){
    Logger.log("å–å¾— Config åƒæ•¸å¤±æ•—:"+ e);
    return {};
  }
}

/*************************************************************************************************
 * setConfigParameter(key, value): å¹«åŠ©å‡½å¼ => åœ¨ Config åˆ†é ä¸­è¨­å®šæŸå€‹åƒæ•¸
 *************************************************************************************************/
function setConfigParameter(key, value){
  var ss= SpreadsheetApp.getActiveSpreadsheet();
  var sheet= ss.getSheetByName("Config");
  if(!sheet){
    sheet= ss.insertSheet("Config");
    sheet.appendRow(["åƒæ•¸","å€¼","èªªæ˜"]);
  }
  var data= sheet.getDataRange().getValues();
  var found= false;
  for(var r=1; r<data.length; r++){
    if(data[r][0]===key){
      sheet.getRange(r+1,2).setValue(value);
      found= true;
      break;
    }
  }
  if(!found){
    sheet.appendRow([key,value,""]);
  }
}

/*************************************************************************************************
 * getFullConfig(): è®€å– Config å…¨éƒ¨(ç®¡ç†ä»‹é¢)
 *************************************************************************************************/
function getFullConfig(){
  var ss= SpreadsheetApp.getActiveSpreadsheet();
  var sheet= ss.getSheetByName("Config");
  if(!sheet) return [];
  return sheet.getDataRange().getValues();
}

/*************************************************************************************************
 * showManagementPage(): é¡¯ç¤ºç®¡ç†ä»‹é¢ (management.html)
 *************************************************************************************************/
function showManagementPage(){
  var html= HtmlService.createHtmlOutputFromFile("management")
      .setWidth(600)
      .setHeight(400);
  SpreadsheetApp.getUi().showModalDialog(html,"å…©éšæ®µåˆ†æ‰¹åƒæ•¸è¨­å®š(30å¹´è‚¡ç¥+30å¹´å·¥ç¨‹å¸«)");
}

/*************************************************************************************************
 * saveConfigParameters(params): ä¾› management.html å‘¼å«
 *************************************************************************************************/
function saveConfigParameters(params){
  try{
    var ss= SpreadsheetApp.getActiveSpreadsheet();
    var sheet= ss.getSheetByName("Config");
    if(!sheet){
      sheet= ss.insertSheet("Config");
      sheet.appendRow(["åƒæ•¸","å€¼","èªªæ˜"]);
    }
    var data= sheet.getDataRange().getValues();
    for(var key in params){
      var val= params[key];
      var found=false;
      for(var r=1; r<data.length; r++){
        if(data[r][0]===key){
          sheet.getRange(r+1,2).setValue(val);
          found= true;
          break;
        }
      }
      if(!found){
        sheet.appendRow([key,val,""]);
      }
    }
    return "è¨­å®šå·²å„²å­˜";
  } catch(e){
    return "è¨­å®šå„²å­˜å¤±æ•—:"+ e;
  }
}

/*************************************************************************************************
 * End of Code
 *************************************************************************************************/

</details>


ä½¿ç”¨æ–¹å¼ç°¡è¿°
	1.	åœ¨åŒä¸€å€‹å°ˆæ¡ˆä¸­ï¼Œå»ºç«‹å…©å€‹æª”æ¡ˆï¼š
	â€¢	Code.gsï¼šè²¼ä¸Šä»¥ä¸Šã€Œå‰åŠæ®µ + å¾ŒåŠæ®µã€åˆä½µå¾Œçš„ç¨‹å¼ç¢¼
	â€¢	management.htmlï¼šè²¼ä¸Šä»‹é¢æª”
	2.	ä¿®æ”¹ SPREADSHEET_ID, TELEGRAM_TOKEN, TELEGRAM_CHAT_ID ç‚ºæ‚¨è‡ªå·±çš„ã€‚
	3.	åŸ·è¡Œ createDailyTriggersSegmented() â†’ æ¯æ—¥ 17:00 åŸ·è¡Œç¬¬ä¸€éšæ®µ mainSegmented()ã€‚
	4.	ç¬¬ä¸€éšæ®µ åˆ†æ‰¹ï¼ˆæ¯æ‰¹ 100 æª”ï¼‰åˆ†æï¼›çµæŸå¾ŒåŸ·è¡Œ finalizeAnalysisStage() â†’ æ›´æ–°è©¦ç®—è¡¨ & æˆåŠŸå¤±æ•—ç‡ â†’ å»ºç«‹ç¬¬äºŒéšæ®µè§¸ç™¼å™¨ã€‚
	5.	ç¬¬äºŒéšæ®µ åˆ†æ‰¹ï¼ˆæ¯æ‰¹ 5 æª”ï¼‰å›æ¸¬ï¼›çµæŸå¾ŒåŸ·è¡Œ finalizeBacktestStage() â†’ å¯«å…¥å¤šç­–ç•¥å›æ¸¬ç´€éŒ„ & AI æ·±åº¦å­¸ç¿’ã€‚
	6.	ä¸­é€”å¤±æ•—ï¼š
	â€¢	è‹¥åœ¨åˆ†æéšæ®µå¤±æ•— â†’ Config åˆ†é è¨­å®š Segment_ManualStart_Analysis >=0 â†’ æŒ‰ã€Œæ‰‹å‹•ç¹¼çºŒåˆ†æã€â†’ mainSegmented() æœƒå¾è©²æ‰¹é–‹å§‹ã€‚
	â€¢	è‹¥åœ¨å›æ¸¬éšæ®µå¤±æ•— â†’ Config åˆ†é è¨­å®š Segment_ManualStart_Backtest >=0 â†’ æŒ‰ã€Œæ‰‹å‹•ç¹¼çºŒå›æ¸¬ã€â†’ backtestSegmented() æœƒå¾è©²æ‰¹é–‹å§‹ã€‚

è‡³æ­¤ï¼Œæ‚¨å°±æ“æœ‰ä¸€å¥—ã€Œå…©éšæ®µåˆ†æ‰¹è™•ç†ã€æ¯éšæ®µå¯è‡ªè¨‚æ‰¹æ¬¡ã€ä¿ç•™æ‰€æœ‰åŠŸèƒ½ã€å¯ä¸­é€”çºŒè·‘ã€çš„æœ€çµ‚å®Œæ•´ç³»çµ±ï¼Œç¨‹å¼ç¢¼è¡Œæ•¸å·²è¶…é 1000 è¡Œã€‚ç¥æ‚¨ä½¿ç”¨é †åˆ©ï¼
