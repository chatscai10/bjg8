<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸æ—©è„†çš®é›æ’ - åˆ†åº—åœ°åœ–</title>

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://unpkg.com https://chatscai10.github.io https://static.line-scdn.net; object-src 'none';">

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
/* --- å…¨å±€èˆ‡åŸºæœ¬è¨­å®š --- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
  min-height: 100vh;
  color: #e1e5e9;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:
    radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
  z-index: -1;
}

.main-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 0;
  position: relative;
  z-index: 1;
  min-height: 100vh;
}

/* --- å…¨è¢å¹•è¼‰å…¥é®ç½© --- */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease-out, visibility 0.6s;
  opacity: 1;
  visibility: visible;
}

#loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-content {
  text-align: center;
  position: relative;
}
.loading-logo {
  width: 120px;
  height: auto;
  margin-bottom: 24px;
  animation: pulse-glow 2.5s infinite ease-in-out, floatEnhanced 2.5s ease-in-out infinite;
}
/* è¼‰å…¥ä¸­çš„åˆ†åº—å¡ç‰‡æ¨£å¼ */
.loading-store-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 215, 0, 0.6);
  border-radius: 15px;
  padding: 20px 30px;
  margin: 10px 0;
  box-shadow:
    0 4px 15px rgba(0, 0, 0, 0.1),
    0 0 15px rgba(255, 215, 0, 0.4),
    0 0 30px rgba(255, 215, 0, 0.2);
  max-width: 600px;
  width: 98%;
  position: relative;
  animation: loadingGoldenGlow 3s ease-in-out infinite alternate;
  min-width: 350px;
}

.loading-store-header {
  background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.1));
  border: 1px solid rgba(255, 193, 7, 0.3);
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 12px;
  position: relative;
}

.loading-store-header h3 {
  color: #d97706;
  font-size: 18px;
  font-weight: 700;
  margin: 0;
  text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
  white-space: nowrap;
  overflow: visible;
}

.loading-store-address {
  color: #6b7280;
  font-size: 14px;
  font-weight: 500;
  margin: 0;
  padding-left: 4px;
  white-space: nowrap;
  overflow: visible;
}

/* è¼‰å…¥å¡ç‰‡é‡‘è‰²å…‰æšˆå‹•ç•« */
@keyframes loadingGoldenGlow {
  0% {
    box-shadow:
      0 4px 15px rgba(0, 0, 0, 0.1),
      0 0 15px rgba(255, 215, 0, 0.4),
      0 0 30px rgba(255, 215, 0, 0.2);
  }
  100% {
    box-shadow:
      0 4px 20px rgba(0, 0, 0, 0.15),
      0 0 25px rgba(255, 215, 0, 0.6),
      0 0 50px rgba(255, 215, 0, 0.3);
  }
}

/* åœ°åœ–ç™½è‰²é‚Šæ¡†é–ƒçˆå‹•ç•« */
@keyframes mapBorderFlash {
  0%, 100% {
    border-color: rgba(255, 255, 255, 0.8);
    box-shadow:
      0 4px 20px rgba(0, 0, 0, 0.3),
      0 0 10px rgba(255, 255, 255, 0.5),
      0 0 20px rgba(255, 255, 255, 0.3);
  }
  50% {
    border-color: rgba(255, 255, 255, 1);
    box-shadow:
      0 4px 20px rgba(0, 0, 0, 0.3),
      0 0 15px rgba(255, 255, 255, 0.7),
      0 0 30px rgba(255, 255, 255, 0.6);
  }
}

/* åœ°åœ–é‡‘è‰²çƒåœç¹è»Œé“å‹•ç•« */
@keyframes mapGoldenOrbit {
  0% {
    top: -6px;
    left: -6px;
    transform: none;
  }
  12.5% {
    top: -6px;
    left: 25%;
    transform: translateX(-50%);
  }
  25% {
    top: -6px;
    left: calc(100% + 6px);
    transform: none;
  }
  37.5% {
    top: 25%;
    left: calc(100% + 6px);
    transform: translateY(-50%);
  }
  50% {
    top: calc(100% + 6px);
    left: calc(100% + 6px);
    transform: none;
  }
  62.5% {
    top: calc(100% + 6px);
    left: 75%;
    transform: translateX(-50%);
  }
  75% {
    top: calc(100% + 6px);
    left: -6px;
    transform: none;
  }
  87.5% {
    top: 75%;
    left: -6px;
    transform: translateY(-50%);
  }
  100% {
    top: -6px;
    left: -6px;
    transform: none;
  }
}

/* è¼‰å…¥å¡ç‰‡ç™½è‰²éœ“è™¹çƒåœç¹æ•ˆæœ */
.loading-store-card::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 17px;
  background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.8), transparent, rgba(255, 255, 255, 0.8), transparent);
  background-size: 400% 400%;
  animation: loadingOrbitLight 3s linear infinite;
  z-index: -1;
}

@keyframes loadingOrbitLight {
  0% { background-position: 0% 0%; }
  25% { background-position: 100% 0%; }
  50% { background-position: 100% 100%; }
  75% { background-position: 0% 100%; }
  100% { background-position: 0% 0%; }
}

/* è¼‰å…¥å¡ç‰‡å®¹å™¨ */
.loading-card-container {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* é›æ’åŒ…è£å™¨ */
.loading-chicken-wrapper {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

.loading-chicken-wrapper .loading-logo {
  position: relative;
  z-index: 10;
  margin-bottom: -30px;
  transform: translateY(15px);
}

.loading-chicken-wrapper .loading-speech-bubble {
  position: absolute;
  top: -10px;
  right: -30px;
  z-index: 15;
}

/* é‡æ–°å®šä½æŒ‰éˆ•æ¨£å¼ */
.locate-button {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(59, 130, 246, 0.4);
  border-radius: 12px;
  padding: 12px 24px;
  color: #2563eb;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow:
    0 4px 15px rgba(0, 0, 0, 0.1),
    0 0 20px rgba(59, 130, 246, 0.15);
  text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
}

.locate-button:hover {
  background: rgba(255, 255, 255, 1);
  border-color: rgba(59, 130, 246, 0.6);
  box-shadow:
    0 6px 20px rgba(0, 0, 0, 0.15),
    0 0 30px rgba(59, 130, 246, 0.25);
  transform: translateY(-2px);
}

.locate-button:active {
  transform: translateY(0);
  box-shadow:
    0 2px 10px rgba(0, 0, 0, 0.1),
    0 0 15px rgba(59, 130, 246, 0.15);
}

.locate-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* è¼‰å…¥é é¢æ–‡å­— - ç™½è‰²éœ“è™¹æ•ˆæœ */
.loading-speech-bubble {
  position: absolute;
  top: -30px;
  right: -20px;
  color: white;
  font-size: 16px;
  font-weight: bold;
  white-space: nowrap;
  text-shadow:
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    2px 2px 0 #000,
    0 0 10px rgba(255, 255, 255, 0.8);
  z-index: 10;
  animation: floatEnhanced 2.5s ease-in-out infinite, loadingNeonGlow 2s ease-in-out infinite alternate;
  transform-origin: center;
}

/* è¼‰å…¥é é¢éœ“è™¹å…‰æ•ˆæœ */
@keyframes loadingNeonGlow {
  0% {
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 5px rgba(255, 255, 255, 0.5);
  }
  100% {
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 20px rgba(255, 255, 255, 1),
      0 0 30px rgba(255, 255, 255, 0.8);
  }
}

/* ç§»é™¤ä¸éœ€è¦çš„å‹•ç•«ï¼Œä½¿ç”¨floatEnhanced */

/* ç†±é¨°é¨°ç…™éœ§æ•ˆæœ - å¤šå€‹ç…™éœ§ */
.loading-speech-bubble::before {
  content: '';
  position: absolute;
  top: -15px;
  left: 10px;
  width: 3px;
  height: 12px;
  background: linear-gradient(to top,
    rgba(255, 255, 255, 0.8) 0%,
    rgba(255, 255, 255, 0.6) 30%,
    rgba(255, 255, 255, 0.3) 60%,
    rgba(255, 255, 255, 0.1) 100%);
  border-radius: 50%;
  animation: hotSteam 3s ease-in-out infinite;
  filter: blur(1px);
  box-shadow:
    15px 0 0 -1px rgba(255, 255, 255, 0.6),
    30px -2px 0 -1px rgba(255, 255, 255, 0.4),
    45px 1px 0 -1px rgba(255, 255, 255, 0.5);
}

.loading-speech-bubble::after {
  content: '';
  position: absolute;
  top: -12px;
  left: 20px;
  width: 2px;
  height: 10px;
  background: linear-gradient(to top,
    rgba(255, 255, 255, 0.6) 0%,
    rgba(255, 255, 255, 0.4) 40%,
    rgba(255, 255, 255, 0.2) 80%,
    rgba(255, 255, 255, 0.05) 100%);
  border-radius: 50%;
  animation: hotSteam 3s ease-in-out infinite 0.8s;
  filter: blur(1px);
  box-shadow:
    10px -1px 0 0 rgba(255, 255, 255, 0.4),
    20px 1px 0 0 rgba(255, 255, 255, 0.3);
}

@keyframes hotSteam {
  0% {
    transform: translateY(0px) scale(1);
    opacity: 0.8;
  }
  50% {
    transform: translateY(-10px) scale(1.2);
    opacity: 0.6;
  }
  100% {
    transform: translateY(-20px) scale(0.8);
    opacity: 0.1;
  }
}

/* è·‘é¦¬ç‡ˆæ•ˆæœ */
@keyframes marqueeScroll {
  0% { transform: translateX(0%); }
  25% { transform: translateX(-10%); }
  50% { transform: translateX(0%); }
  75% { transform: translateX(10%); }
  100% { transform: translateX(0%); }
}
.loading-dots { display: inline-block; }
.loading-dots::after {
  content: '.';
  animation: loadingDots 1.4s steps(4, end) infinite;
}

/* --- é é¢å…ƒä»¶ --- */
/* ç§»é™¤announcementæ¨£å¼ï¼Œå·²ä¸éœ€è¦ */

#map {
  height: 300px;
  margin: 20px;
  border-radius: 12px;
  border: 3px solid white;
  box-shadow:
    0 4px 20px rgba(0, 0, 0, 0.3),
    0 0 10px rgba(255, 255, 255, 0.8),
    0 0 20px rgba(255, 255, 255, 0.6);
  overflow: hidden;
  position: relative;
  animation: mapBorderFlash 2s ease-in-out infinite;
}

/* åœ°åœ–é‡‘è‰²çƒåœç¹æ•ˆæœ */
#map::before {
  content: '';
  position: absolute;
  top: -8px;
  left: -8px;
  right: -8px;
  bottom: -8px;
  border-radius: 16px;
  background: transparent;
  pointer-events: none;
  z-index: 1000;
}

#map::after {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  background: radial-gradient(circle, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
  border-radius: 50%;
  box-shadow:
    0 0 8px rgba(255, 215, 0, 0.8),
    0 0 16px rgba(255, 215, 0, 0.6);
  animation: mapGoldenOrbit 4s linear infinite;
  z-index: 1001;
  pointer-events: none;
}

#store-list { padding: 20px; }

/* --- åº—å®¶å¡ç‰‡åŸºç¤çµæ§‹ --- */
.store-item {
  margin-bottom: 24px;
  position: relative;
}
.store-card {
  width: 100%;
  border-radius: 16px;
  overflow: visible; /* ç‚ºäº†è®“ç«ç„°ç‰¹æ•ˆèƒ½æº¢å‡º */
  position: relative;
}
.store-front {
  width: 100%;
  border-radius: 24px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  box-shadow:
    0 12px 40px rgba(0, 0, 0, 0.15),
    0 4px 12px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
  z-index: 2;
  overflow: hidden;
  transition: all 0.3s ease;
}

.store-front:hover {
  transform: translateY(-4px);
  box-shadow:
    0 20px 60px rgba(0, 0, 0, 0.2),
    0 8px 20px rgba(0, 0, 0, 0.15);
}

/* --- å¡ç‰‡æ”¶åˆ/å±•é–‹æ•ˆæœ --- */
.store-front-header {
  padding: 24px 28px;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  background: transparent;
  border-bottom: none;
  border-radius: 24px 24px 0 0;
}

.store-front-header:hover {
  background: rgba(0, 0, 0, 0.02);
}
.store-front-header h3 {
  font-size: 28px;
  font-weight: 800;
  margin: 0 0 12px 0;
  color: #1a1a1a;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: nowrap;
  line-height: 1.2;
  letter-spacing: 0.3px;
  position: relative;
  padding-right: 60px;
  text-shadow:
    2px 2px 0 rgba(0, 0, 0, 0.8),
    -2px -2px 0 rgba(0, 0, 0, 0.8),
    2px -2px 0 rgba(0, 0, 0, 0.8),
    -2px 2px 0 rgba(0, 0, 0, 0.8),
    1px 1px 3px rgba(255, 255, 255, 0.9),
    -1px -1px 3px rgba(255, 255, 255, 0.9),
    0 0 6px rgba(255, 255, 255, 0.7);
}

/* åº—åæ—çš„ä¿ƒéŠ·æ´»å‹• */
.store-name-promotion {
  font-size: 12px;
  font-weight: 600;
  color: #ff6b35;
  animation: promotionGlow 2s ease-in-out infinite alternate, marqueeScroll 8s linear infinite;
  text-shadow:
    1px 1px 0 rgba(0, 0, 0, 0.8),
    -1px -1px 0 rgba(0, 0, 0, 0.8),
    1px -1px 0 rgba(0, 0, 0, 0.8),
    -1px 1px 0 rgba(0, 0, 0, 0.8),
    0 0 6px rgba(255, 107, 53, 0.4);
  white-space: nowrap;
  flex-shrink: 1;
  align-self: flex-end;
  margin-left: 12px;
  margin-bottom: 2px;
  padding: 0;
  background: transparent;
  border-radius: 0;
  border: none;
  max-width: 200px;
  overflow: hidden;
}

/* å£æ°´æ•ˆæœ - åœ¨åº—åæ¡†å…§å·¦ä¸‹è§’ */
.store-front-header h3::after {
  content: 'ğŸ’§';
  position: absolute;
  bottom: -8px;
  left: 8px;
  font-size: 18px;
  opacity: 0.8;
  animation: simpleDroolDrop 2s ease-in-out infinite;
  z-index: 15;
  text-shadow: none;
  filter: none;
  border: none;
  outline: none;
}

/* ç°¡å–®å£æ°´æ»´è½å‹•ç•« */
@keyframes simpleDroolDrop {
  0% {
    transform: translateY(0);
    opacity: 0.8;
  }
  50% {
    transform: translateY(6px);
    opacity: 1;
  }
  100% {
    transform: translateY(0);
    opacity: 0.8;
  }
}

@keyframes promotionGlow {
  0% {
    text-shadow: 0 0 6px rgba(255, 107, 53, 0.4);
    color: #ff6b35;
  }
  100% {
    text-shadow: 0 0 12px rgba(255, 107, 53, 0.8);
    color: #ff8c42;
  }
}

/* æµå£æ°´å‹•ç•« - æ°´æ»´ */
@keyframes droolDrop {
  0%, 100% {
    transform: translateY(0) scale(1);
    filter: drop-shadow(0 2px 4px rgba(76, 175, 80, 0.3));
  }
  25% {
    transform: translateY(2px) scale(1.1, 0.9);
  }
  50% {
    transform: translateY(4px) scale(1.05, 1.1);
    filter: drop-shadow(0 4px 8px rgba(76, 175, 80, 0.5));
  }
  75% {
    transform: translateY(2px) scale(0.95, 1.05);
  }
}

/* æµå£æ°´ç·šæ¢å‹•ç•« */
@keyframes droolStream {
  0%, 100% {
    height: 10px;
    opacity: 0.6;
  }
  50% {
    height: 20px;
    opacity: 0.8;
  }
}

/* æµå£æ°´å‹•ç•« - å‘ä¸Š */
@keyframes droolUp {
  0%, 100% {
    transform: rotate(180deg) translateY(0) scale(1);
    filter: drop-shadow(0 2px 4px rgba(76, 175, 80, 0.3));
  }
  25% {
    transform: rotate(180deg) translateY(-2px) scale(1.1, 0.9);
  }
  50% {
    transform: rotate(180deg) translateY(-4px) scale(1.05, 1.1);
    filter: drop-shadow(0 4px 8px rgba(76, 175, 80, 0.5));
  }
  75% {
    transform: rotate(180deg) translateY(-2px) scale(0.95, 1.05);
  }
}

/* å¡ç‰‡å±•é–‹æ™‚éš±è—åº—åæ—çš„ä¿ƒéŠ·æ´»å‹• */
.store-item.expanded .store-name-promotion {
  display: none;
}

/* å¡ç‰‡å±•é–‹æ™‚çš„ç’°ç¹é‡‘è‰²é‚Šæ¡†ç‰¹æ•ˆ */
.store-item.expanded {
  position: relative;
  overflow: visible;
}

.store-item.expanded::before {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  border-radius: 18px;
  z-index: -1;
  pointer-events: none;
  background: transparent;
}

.store-item.expanded::after {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  background: radial-gradient(circle,
    rgba(255, 255, 255, 1) 0%,
    rgba(255, 255, 255, 0.8) 30%,
    rgba(255, 255, 255, 0.4) 60%,
    transparent 100%
  );
  border-radius: 50%;
  box-shadow:
    0 0 10px rgba(255, 255, 255, 0.8),
    0 0 20px rgba(255, 255, 255, 0.6),
    0 0 30px rgba(255, 255, 255, 0.4);
  animation: circleAroundCardBorder 6s linear infinite;
  z-index: 10;
  pointer-events: none;
}

/* éœ“è™¹çƒæ²¿è‘—å¡ç‰‡é‚Šæ¡†ç’°ç¹å‹•ç•« */
@keyframes circleAroundCardBorder {
  0% {
    top: -6px;
    left: 0%;
    right: auto;
    bottom: auto;
  }
  12.5% {
    top: -6px;
    left: 50%;
    right: auto;
    bottom: auto;
  }
  25% {
    top: -6px;
    left: 100%;
    right: auto;
    bottom: auto;
  }
  37.5% {
    top: 50%;
    left: 100%;
    right: auto;
    bottom: auto;
  }
  50% {
    top: 100%;
    left: 100%;
    right: auto;
    bottom: auto;
  }
  62.5% {
    top: 100%;
    left: 50%;
    right: auto;
    bottom: auto;
  }
  75% {
    top: 100%;
    left: 0%;
    right: auto;
    bottom: auto;
  }
  87.5% {
    top: 50%;
    left: 0%;
    right: auto;
    bottom: auto;
  }
  100% {
    top: -6px;
    left: 0%;
    right: auto;
    bottom: auto;
  }
}

/* ç’°ç¹å‹•ç•« */
@keyframes circleAround {
  0% {
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
  }
  25% {
    top: 50%;
    right: 10px;
    left: auto;
    transform: translateY(-50%);
  }
  50% {
    bottom: 10px;
    right: 50%;
    top: auto;
    left: auto;
    transform: translateX(50%);
  }
  75% {
    top: 50%;
    left: 10px;
    bottom: auto;
    right: auto;
    transform: translateY(-50%);
  }
  100% {
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
  }
}

/* ç’°ç¹é‚Šæ¡†æµå‹•å‹•ç•« */
@keyframes borderFlow {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* é‚Šæ¡†è„ˆè¡å‹•ç•« */
@keyframes borderPulse {
  0%, 100% {
    background-position: 0% 0%;
    opacity: 0.6;
  }
  50% {
    background-position: 100% 100%;
    opacity: 0.9;
  }
}

/* ç‡Ÿæ¥­ä¸­åº—å®¶åç¨±æ¨£å¼ */
.store-item.store-open .store-front-header h3 {
  color: #d97706;
  text-shadow:
    2px 2px 0 rgba(0, 0, 0, 0.8),
    -2px -2px 0 rgba(0, 0, 0, 0.8),
    2px -2px 0 rgba(0, 0, 0, 0.8),
    -2px 2px 0 rgba(0, 0, 0, 0.8);
  background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(245, 158, 11, 0.1));
  padding: 8px 16px;
  border-radius: 16px;
  border: 2px solid rgba(217, 119, 6, 0.3);
  position: relative;
  z-index: 1;
}

/* ç‡Ÿæ¥­ä¸­åº—åä¸Šæ–¹å†’ç…™ç‰¹æ•ˆ */
.store-item.store-open .store-front-header h3::before {
  content: '';
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 8px;
  height: 8px;
  background: radial-gradient(circle,
    rgba(255, 255, 255, 0.8) 0%,
    rgba(255, 255, 255, 0.6) 30%,
    rgba(255, 255, 255, 0.3) 60%,
    rgba(255, 255, 255, 0.1) 100%);
  border-radius: 50%;
  animation: steamRise 2s ease-in-out infinite;
  z-index: 10;
}

@keyframes steamRise {
  0% {
    opacity: 0.8;
    transform: translateX(-50%) translateY(0px) scale(1);
  }
  50% {
    opacity: 0.6;
    transform: translateX(-50%) translateY(-8px) scale(1.2);
  }
  100% {
    opacity: 0.2;
    transform: translateX(-50%) translateY(-15px) scale(1.5);
  }
}

@keyframes goldenShimmer {
  0% {
    color: #d97706;
    text-shadow:
      0 0 8px rgba(217, 119, 6, 0.6),
      0 0 16px rgba(217, 119, 6, 0.4);
    border-color: rgba(217, 119, 6, 0.3);
  }
  100% {
    color: #f59e0b;
    text-shadow:
      0 0 12px rgba(245, 158, 11, 0.8),
      0 0 24px rgba(245, 158, 11, 0.6);
    border-color: rgba(245, 158, 11, 0.5);
  }
}
.expand-arrow {
  position: absolute;
  bottom: -4px;
  right: 4px;
  transform: rotate(0deg);
  transition: none;
  font-size: 0;
  color: #4CAF50;
  font-weight: bold;
  background: transparent;
  border-radius: 0;
  width: 20px;
  height: 28px;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
}

.expand-arrow::before {
  content: 'â–¼';
  font-size: 16px;
  color: #d97706;
  transition: transform 0.3s ease;
}

.store-item.expanded .expand-arrow::before {
  content: 'â–²';
  transform: rotate(0deg);
}
.store-address {
  font-size: 16px;
  color: #666666;
  padding: 0 28px 20px;
  cursor: pointer;
  border-bottom: none;
  font-weight: 500;
  line-height: 1.5;
}
.store-collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.store-item.expanded .store-collapsible-content { max-height: 600px; }
.basic-info {
  padding: 24px 28px;
  background: transparent;
  color: #333333;
  font-size: 16px;
  line-height: 1.8;
  border-radius: 0;
  margin: 0;
  border: none;
}
.basic-info strong {
  color: #1a1a1a;
  font-weight: 700;
}
.basic-info a {
  color: #2563eb;
  text-decoration: none;
  transition: all 0.3s ease;
  font-weight: 600;
}
.basic-info a:hover {
  color: #1d4ed8;
  transform: scale(1.02);
}
.status-info {
  padding: 20px 28px;
  background: transparent;
  border: none;
  margin: 0;
  border-radius: 0;
}
.open-status {
  color: #ffffff;
  font-weight: 700;
  padding: 8px 16px;
  background: #059669;
  border-radius: 20px;
  border: 2px solid #059669;
  display: inline-block;
  animation: openStatusPulse 2.5s ease-in-out infinite;
  box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
  position: relative;
}

/* ç‡Ÿæ¥­ä¸­åº—åç†±ç…™ç‰¹æ•ˆ */
.store-item:not(.store-closed) .store-front-header h3::before {
  content: '';
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 3px;
  height: 12px;
  background: linear-gradient(to top,
    rgba(255, 255, 255, 0.9) 0%,
    rgba(255, 255, 255, 0.7) 30%,
    rgba(255, 255, 255, 0.4) 60%,
    rgba(255, 255, 255, 0.1) 100%);
  border-radius: 50%;
  animation: steamRise 2s ease-in-out infinite;
  filter: blur(1px);
  z-index: 10;
}

.store-item:not(.store-closed) .store-front-header h3 {
  position: relative;
}

.clickable-status {
  cursor: pointer;
  transition: all 0.3s ease;
}

.clickable-status:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 16px rgba(5, 150, 105, 0.5);
}

@keyframes openStatusPulse {
  0%, 100% {
    color: #ffffff;
    border-color: #059669;
    background: #059669;
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
  }
  50% {
    color: #ffffff;
    border-color: #10b981;
    background: #10b981;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
  }
}

.closed-status {
  color: #ffffff;
  font-weight: 600;
  padding: 8px 16px;
  background: #dc2626;
  border-radius: 20px;
  border: 2px solid #dc2626;
  display: inline-block;
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
}

/* ä¿ƒéŠ·æ´»å‹•é–ƒçˆæ•ˆæœ - æ¸›å¼±ç‰ˆ */
.promotion-text {
  color: #fbbf24;
  font-weight: 700;
  text-shadow:
    1px 1px 0 rgba(0, 0, 0, 0.8),
    -1px -1px 0 rgba(0, 0, 0, 0.8),
    1px -1px 0 rgba(0, 0, 0, 0.8),
    -1px 1px 0 rgba(0, 0, 0, 0.8),
    0 0 3px rgba(251, 191, 36, 0.4),
    0 0 6px rgba(251, 191, 36, 0.3);
  animation: promotionFlash 3s ease-in-out infinite;
  display: inline-block;
  white-space: nowrap;
}

@keyframes promotionFlash {
  0%, 100% {
    color: #d4af37;
    text-shadow:
      1px 1px 0 rgba(0, 0, 0, 0.6),
      -1px -1px 0 rgba(0, 0, 0, 0.6),
      1px -1px 0 rgba(0, 0, 0, 0.6),
      -1px 1px 0 rgba(0, 0, 0, 0.6),
      0 0 2px rgba(212, 175, 55, 0.3);
  }
  50% {
    color: #b8860b;
    text-shadow:
      1px 1px 0 rgba(0, 0, 0, 0.6),
      -1px -1px 0 rgba(0, 0, 0, 0.6),
      1px -1px 0 rgba(0, 0, 0, 0.6),
      -1px 1px 0 rgba(0, 0, 0, 0.6),
      0 0 3px rgba(184, 134, 11, 0.4);
  }
}

/* --- å¡ç‰‡æŒ‰éˆ• --- */
.btn-group {
  padding: 24px 28px 28px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.btn-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.btn-group button {
  flex: 1;
  min-width: 80px;
  padding: 10px 8px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #ffffff;
  color: #374151;
  font-size: 11px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  white-space: nowrap;
  text-overflow: ellipsis;
  line-height: 1.3;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.btn-group button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  border-color: #3b82f6;
  color: #3b82f6;
  background: #f8fafc;
}

.full-width-btn {
  width: 100% !important;
  min-width: 100% !important;
  flex: none !important;
  background: #059669 !important;
  color: white !important;
  border-color: #059669 !important;
  font-weight: 700 !important;
}

.full-width-btn:hover {
  background: #047857 !important;
  border-color: #047857 !important;
  color: white !important;
}

/* --- ä¼‘æ¯ä¸­åº—å®¶é®ç½© --- */
.store-item.store-closed { cursor: pointer; }
.closed-mask-content {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 12;
  border-radius: 16px;
  backdrop-filter: blur(3px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  text-align: center;
  padding: 10px;
}
.closed-icon {
  font-size: 24px;
  margin-bottom: 8px;
  text-shadow:
    3px 3px 0 rgba(0, 0, 0, 1),
    -3px -3px 0 rgba(0, 0, 0, 1),
    3px -3px 0 rgba(0, 0, 0, 1),
    -3px 3px 0 rgba(0, 0, 0, 1);
}
.closed-store-name {
  color: #ffffff;
  font-size: 16px;
  font-weight: 700;
  text-shadow:
    3px 3px 0 rgba(0, 0, 0, 1),
    -3px -3px 0 rgba(0, 0, 0, 1),
    3px -3px 0 rgba(0, 0, 0, 1),
    -3px 3px 0 rgba(0, 0, 0, 1),
    2px 2px 4px rgba(0, 0, 0, 0.8);
  margin-bottom: 4px;
}
.closed-status {
  color: #ffffff;
  font-size: 14px;
  font-weight: 600;
  text-shadow:
    3px 3px 0 rgba(0, 0, 0, 1),
    -3px -3px 0 rgba(0, 0, 0, 1),
    3px -3px 0 rgba(0, 0, 0, 1),
    -3px 3px 0 rgba(0, 0, 0, 1),
    2px 2px 4px rgba(0, 0, 0, 0.8);
}
.store-item.store-closed.clicked-transparent .closed-mask-content {
  background: rgba(0, 0, 0, 0.25) !important;
  backdrop-filter: blur(0.5px) !important;
}
/* ç§»é™¤æœªç‡Ÿæ¥­åº—å®¶çš„æ–‡å­—å¤–æ¡† */
.store-item.store-closed .closed-icon,
.store-item.store-closed .closed-store-name,
.store-item.store-closed .closed-status {
  text-shadow: none;
}
.store-item.store-closed.clicked-transparent .closed-icon,
.store-item.store-closed.clicked-transparent .closed-store-name,
.store-item.store-closed.clicked-transparent .closed-status {
  text-shadow: none;
}
/* ç§»é™¤æœªç‡Ÿæ¥­åº—å®¶çš„å£æ°´æ•ˆæœ */
.store-item.store-closed .store-front-header h3::after {
  display: none;
}

/* --- ç‡Ÿæ¥­ä¸­é‡‘è‰²å…‰æšˆç‰¹æ•ˆ --- */
.store-card.flame-border {
  position: relative;
  box-shadow:
    0 0 15px rgba(255, 215, 0, 0.25),
    0 0 30px rgba(255, 215, 0, 0.15),
    0 4px 20px rgba(0, 0, 0, 0.1);
  animation: goldenGlow 4s ease-in-out infinite alternate;
}

.store-card.flame-border::before {
  content: '';
  position: absolute;
  top: -1px; left: -1px; right: -1px; bottom: -1px;
  z-index: 1;
  background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700, #ffed4e);
  background-size: 400% 400%;
  border-radius: 20px;
  opacity: 0.3;
  animation: gradientShift 6s ease-in-out infinite;
  pointer-events: none;
}

.store-card.flame-border::after {
  content: '';
  position: absolute;
  top: -0.5px; left: -0.5px; right: -0.5px; bottom: -0.5px;
  z-index: 0;
  background: linear-gradient(90deg, #fff59d, #ffd700, #fff59d);
  background-size: 200% 200%;
  border-radius: 18px;
  opacity: 0.2;
  animation: gradientShift 8s ease-in-out infinite reverse;
  pointer-events: none;
}

/* --- ç‡Ÿæ¥­æ™‚é–“å±•é–‹ --- */
.business-hours-toggle {
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  transition: background-color 0.3s ease;
}
.business-hours-toggle:hover { background: rgba(59, 130, 246, 0.05); }
.business-hours-toggle .toggle-icon {
  font-size: 12px;
  color: #d97706;
  transition: transform 0.3s ease;
}
.business-hours-toggle.expanded .toggle-icon { transform: rotate(180deg); }
.business-hours-details {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  background: rgba(59, 130, 246, 0.02);
  border-radius: 8px;
  margin-top: 8px;
}
.business-hours-details.expanded {
  max-height: 280px;
  padding: 12px;
}
.day-hours {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
  font-size: 13px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.05);
}
.day-hours:last-child { border-bottom: none; }
.day-name { color: #94a3b8; }
.day-time { color: #60a5fa; font-weight: 600; }

/* --- æ‡¸æµ®é›æ’ --- */
.tech-floating-chicken {
  position: fixed;
  right: 20px;
  top: 70%;
  transform: translateY(-50%);
  z-index: 1000;
  cursor: pointer;
  animation: floatingChicken 8s ease-in-out infinite;
}
.chicken-container {
  position: relative;
  width: 130px;
  height: 130px;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: floatEnhanced 2.5s ease-in-out infinite;
}
.chicken-img {
  width: 150px;
  height: 150px;
  object-fit: contain;
  border-radius: 0;
  transition: all 0.3s ease;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}
.chicken-container:hover .chicken-img {
  transform: scale(1.1) rotate(5deg);
  filter: drop-shadow(0 6px 12px rgba(255, 215, 0, 0.5));
}
.chicken-tooltip {
  position: absolute;
  top: -40px;
  right: -10px;
  color: white;
  font-size: 16px;
  font-weight: bold;
  text-shadow:
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    2px 2px 0 #000,
    0 0 10px rgba(255, 255, 255, 0.8);
  white-space: nowrap;
  z-index: 1001;
  animation: neonGlow 2s ease-in-out infinite alternate;
  pointer-events: none;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s ease;
}

/* ç§»é™¤æ‡¸æµ®é›æ’tooltipçš„ç…™éœ§ç‰¹æ•ˆ */

/* æ‡¸æµ®é›æ’hoveræ•ˆæœ */
.tech-floating-chicken:hover .chicken-tooltip {
  opacity: 1;
  transform: translateY(0);
}

/* æ‡¸æµ®é›æ’ç†±ç…™æ•ˆæœ - åœ¨é›è‚‰ä¸Šæ–¹ */
.chicken-container::before {
  content: '';
  position: absolute;
  top: -5px;
  left: 50px;
  width: 3px;
  height: 12px;
  background: linear-gradient(to top,
    rgba(255, 255, 255, 0.8) 0%,
    rgba(255, 255, 255, 0.6) 30%,
    rgba(255, 255, 255, 0.3) 60%,
    rgba(255, 255, 255, 0.1) 100%);
  border-radius: 50%;
  animation: hotSteam 3s ease-in-out infinite;
  filter: blur(1px);
  z-index: 10;
  box-shadow:
    15px 2px 0 -1px rgba(255, 255, 255, 0.6),
    30px -1px 0 -1px rgba(255, 255, 255, 0.4),
    -15px 1px 0 -1px rgba(255, 255, 255, 0.5);
}

.chicken-container::after {
  content: '';
  position: absolute;
  top: -8px;
  left: 65px;
  width: 2px;
  height: 10px;
  background: linear-gradient(to top,
    rgba(255, 255, 255, 0.6) 0%,
    rgba(255, 255, 255, 0.4) 40%,
    rgba(255, 255, 255, 0.2) 80%,
    rgba(255, 255, 255, 0.05) 100%);
  border-radius: 50%;
  animation: hotSteam 3s ease-in-out infinite 1.2s;
  filter: blur(1px);
  z-index: 10;
  box-shadow:
    -20px 1px 0 0 rgba(255, 255, 255, 0.4),
    10px -1px 0 0 rgba(255, 255, 255, 0.3);
}

/* ç™½è‰²éœ“è™¹å…‰æ•ˆæœ */
@keyframes neonGlow {
  0% {
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 5px rgba(255, 255, 255, 0.5);
  }
  100% {
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 20px rgba(255, 255, 255, 1),
      0 0 30px rgba(255, 255, 255, 0.8);
  }
}

/* é»æˆ‘åŠ å¥½å‹æ–‡å­— */
.add-friend-text {
  position: absolute;
  bottom: -30px;
  left: 0;
  right: 0;
  font-size: 12px;
  font-weight: 600;
  color: #ffd700;
  text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
  animation: addFriendGlow 2s ease-in-out infinite alternate, floatEnhanced 2.5s ease-in-out infinite;
  white-space: nowrap;
  pointer-events: auto;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.add-friend-text:hover {
  transform: scale(1.1);
  color: #fff;
  text-shadow: 0 0 12px rgba(255, 215, 0, 1), 0 0 20px rgba(255, 215, 0, 0.8);
}

@keyframes addFriendGlow {
  0% {
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.8), 0 0 16px rgba(255, 215, 0, 0.6);
    color: #ffd700;
  }
  100% {
    text-shadow: 0 0 12px rgba(255, 215, 0, 1), 0 0 24px rgba(255, 215, 0, 0.8);
    color: #ffed4e;
  }
}

/* é‡‘å…‰é–ƒçˆæ•ˆæœ - ç¸®å°ç‰ˆ */
.golden-glow {
  position: absolute;
  top: 5px;
  left: 5px;
  right: 5px;
  bottom: 5px;
  border-radius: 20%;
  background: conic-gradient(
    from 0deg,
    #ffd700 0deg,
    #ffed4e 60deg,
    #fff59d 120deg,
    #ffd700 180deg,
    #ffb300 240deg,
    #ffd700 300deg,
    #fff176 360deg
  );
  animation: goldenRotate 5s linear infinite;
  opacity: 0.8;
  z-index: -1;
}

.golden-glow::before {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  right: 3px;
  bottom: 3px;
  background: rgba(15, 20, 25, 0.9);
  border-radius: 50%;
  z-index: 1;
}

@keyframes goldenRotate {
  0% {
    transform: rotate(0deg);
    opacity: 0.6;
  }
  50% {
    opacity: 1;
  }
  100% {
    transform: rotate(360deg);
    opacity: 0.6;
  }
}

/* --- åœ°åœ–æ¨™è¨˜ --- */
.user-location-marker {
  font-size: 24px;
  text-align: center;
  animation: userLocationPulse 2s infinite;
}

/* --- å‹•ç•«é›†åˆ --- */
@keyframes loadingDots {
  0% { content: "."; }
  33% { content: ".."; }
  66% { content: "..."; }
  100% { content: "."; }
}
@keyframes pulse-glow {
  0% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3)); }
  50% { transform: scale(1.05); filter: drop-shadow(0 0 16px rgba(255, 215, 0, 0.6)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3)); }
}
@keyframes goldenGlow {
  0%, 100% {
    box-shadow:
      0 0 8px rgba(255, 215, 0, 0.15),
      0 0 16px rgba(255, 215, 0, 0.1),
      0 4px 20px rgba(0, 0, 0, 0.1);
  }
  50% {
    box-shadow:
      0 0 12px rgba(255, 215, 0, 0.2),
      0 0 24px rgba(255, 215, 0, 0.12),
      0 4px 25px rgba(0, 0, 0, 0.12);
  }
}

@keyframes gradientShift {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}
/* æ‡¸æµ®é›æ’æ•´é«”ä¸Šä¸‹ç§»å‹•å‹•ç•« */
@keyframes floatingChicken {
  0% {
    transform: translateY(-50%);
  }
  25% {
    transform: translateY(-60%);
  }
  50% {
    transform: translateY(-40%);
  }
  75% {
    transform: translateY(-60%);
  }
  100% {
    transform: translateY(-50%);
  }
}

@keyframes floatEnhanced {
  0% {
    transform: translate(0, 0) rotate(0deg);
  }
  25% {
    transform: translate(-5px, -4px) rotate(-4deg);
  }
  50% {
    transform: translate(0px, 6px) rotate(0deg);
  }
  75% {
    transform: translate(5px, -4px) rotate(4deg);
  }
  100% {
    transform: translate(0, 0) rotate(0deg);
  }
}
@keyframes userLocationPulse {
  0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(52, 211, 153, 0.7)); }
  50% { transform: scale(1.1); filter: drop-shadow(0 0 12px rgba(52, 211, 153, 1)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(52, 211, 153, 0.7)); }
}

/* --- æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ --- */
@media (max-width: 480px) {
  #map {
    margin: 0;
    border-radius: 0;
    height: 250px;
    border: 2px solid rgba(255, 255, 255, 0.8);
  }
  #locate-btn { margin-top: 10px !important; }

  .tech-floating-chicken {
    width: 80px;
    height: 80px;
    right: 15px;
    top: auto;
    bottom: 20px;
    transform: none;
  }

  .chicken-container {
    width: 80px;
    height: 80px;
  }

  .chicken-img {
    width: 60px;
    height: 60px;
  }
}

/* ç‡Ÿæ¥­ä¸­åº—å®¶çš„é»ƒé‡‘å…‰æšˆç‰¹æ•ˆ */
.store-card.flame-border .store-front::before {
  opacity: 1 !important;
  background: linear-gradient(45deg,
    #ffd700 0%, #ffed4e 25%, #f39c12 50%, #e67e22 75%, #ffd700 100%) !important;
  background-size: 300% 300% !important;
  animation: goldenShift 2s ease infinite !important;
}

.store-card.flame-border .store-front {
  animation: goldenPulse 2s ease-in-out infinite alternate;
  box-shadow:
    0 8px 32px rgba(255, 215, 0, 0.4),
    0 2px 16px rgba(255, 215, 0, 0.2),
    0 0 40px rgba(255, 215, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

@keyframes goldenShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

@keyframes goldenPulse {
  0% {
    box-shadow:
      0 8px 32px rgba(255, 215, 0, 0.4),
      0 2px 16px rgba(255, 215, 0, 0.2),
      0 0 40px rgba(255, 215, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  100% {
    box-shadow:
      0 12px 48px rgba(255, 215, 0, 0.6),
      0 4px 24px rgba(255, 215, 0, 0.4),
      0 0 60px rgba(255, 215, 0, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
}

/* é‡è¤‡çš„å±•é–‹ç®­é ­æ¨£å¼å·²ç§»é™¤ï¼Œä½¿ç”¨ä¸Šé¢çš„æ–°æ¨£å¼ */

/* ä¿®æ­£ä¼‘æ¯ä¸­é®ç½©çš„ z-indexï¼Œç¢ºä¿å®ƒåœ¨æ‰€æœ‰å…§å®¹ä¹‹ä¸Š */
.closed-mask-content {
  z-index: 12; /* æ¯”æŒ‰éˆ•(15)ä½ï¼Œæ¯”å…§å®¹(5)é«˜ */
}
.store-item.store-closed .btn-group {
  z-index: 15;
}

/* å…¨è¢å¹•è¼‰å…¥é®ç½© */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease-out, visibility 0.6s;
  opacity: 1;
  visibility: visible;
}

#loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-content {
  text-align: center;
}

.loading-logo {
  width: 120px;
  height: auto;
  margin-bottom: 24px;
  animation: pulse-glow 2.5s infinite ease-in-out;
}

.loading-text {
  color: #e1e5e9;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 1px;
}

.loading-subtext {
  color: #94a3b8;
  font-size: 14px;
  margin-top: 8px;
}

/* è¼‰å…¥ä¸­çš„ ... å‹•ç•« */
.loading-dots {
  display: inline-block;
}
.loading-dots::after {
  content: '';
  display: inline-block;
  width: 1.2em;
  text-align: left;
  animation: loadingDots 1.2s steps(3, end) infinite;
}
@keyframes loadingDots {
  0% { content: ''; }
  33% { content: '.'; }
  66% { content: '..'; }
  100% { content: '...'; }
}

@keyframes pulse-glow {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
  }
  50% {
    transform: scale(1.05);
    filter: drop-shadow(0 0 16px rgba(255, 215, 0, 0.6));
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
  }
}
</style>
</head>
<body class="dynamic-colors">
<div id="loading-overlay">
  <div class="loading-content">
    <div class="loading-card-container">
      <div class="loading-chicken-wrapper">
        <div class="loading-speech-bubble">å¿«ä¾†åƒæˆ‘</div>
        <img src="https://chatscai10.github.io/bjg8/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png" alt="Loading Logo" class="loading-logo">
      </div>
      <div class="loading-store-card">
        <div class="loading-store-header">
          <h3>æœå°‹å¥½åƒçš„é›æ’ä¸­<span class="loading-dots"></span></h3>
        </div>
        <div class="loading-store-address">æ­£åœ¨ç‚ºæ‚¨æº–å‚™æœ€æ–°é®®çš„é›æ’è³‡è¨Š</div>
      </div>
    </div>
  </div>
</div>
<svg style="position:absolute; width:0; height:0; overflow:hidden;">
  <!-- ç§»é™¤ç«ç„°æ¿¾é¡ï¼Œæ”¹ç”¨CSSå…‰æšˆæ•ˆæœ -->
</svg>
  <!-- æ‡¸æµ®é›æ’è£é£¾ -->
  <div class="tech-floating-chicken" id="floating-chicken" onclick="openLineAddFriend()" title="é»æ“ŠåŠ LINEå¥½å‹">
    <div class="chicken-container">
      <div class="golden-glow"></div>
      <img src="https://chatscai10.github.io/bjg8/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png"
           alt="ä¸æ—©è„†çš®é›æ’" class="chicken-img">
    </div>
    <div class="chicken-tooltip">å¿«ä¾†åƒæˆ‘</div>
    <div class="add-friend-text" onclick="openLineAddFriend()">é»æˆ‘åŠ å¥½å‹</div>
  </div>

  <div class="main-container">
    <!-- æ¸¬è©¦æ™‚é–“æŒ‡ç¤ºå™¨ -->
    <div id="test-time-indicator" style="display: none; margin-bottom: 15px; padding: 8px; background: rgba(255, 193, 7, 0.2); border-radius: 6px; font-size: 13px; text-align: center;">
      <i class="fas fa-clock me-1"></i>
      <strong>æ¸¬è©¦æ¨¡å¼ï¼š</strong><span id="test-time-display"></span>
    </div>

    <!-- åœ°åœ–å®¹å™¨ -->
    <div id="map"></div>

    <!-- å®šä½æŒ‰éˆ• -->
    <div style="text-align: center; margin: 20px;">
      <button id="locate-btn" onclick="manualRequestLocation()" class="locate-button">
        ğŸ“ é‡æ–°å®šä½
      </button>
    </div>

    <!-- åº—å®¶åˆ—è¡¨ -->
    <div id="store-list">
      <!-- åº—å®¶å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  


  <!-- Firebase SDK -->




  <script>
  // å…¨åŸŸè®Šæ•¸
  let map;
  let userLocation = null;
  let isLocationRequested = false;
  let storeData = [];
  let testTime = null; // æ¸¬è©¦æ™‚é–“

  // Google Apps Script Web App URL
  const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZ1EWtf0SBF7nJiJVsoTWyHkGp5hU1n8f14w69Xrs_0x0tiET-aG9m49_fp1eUx-mc/exec';
  // â›”ï¸ è«‹å†æ¬¡ç¢ºèªé€™ä¸²URLæ˜¯æ‚¨æ­£ç¢ºä¸”å¯å…¬é–‹å­˜å–çš„GAS Web Appéƒ¨ç½²ç¶²å€ã€‚
  
  console.log('ğŸ”§ Google Apps Script é…ç½®å·²è¼‰å…¥:', GAS_WEB_APP_URL);

  // éš±è—è¼‰å…¥é®ç½© - å»¶é²2ç§’
  function hideLoadingOverlay() {
    setTimeout(() => {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) {
        overlay.classList.add('hidden');
        console.log('âœ… è¼‰å…¥å®Œæˆï¼Œéš±è—é®ç½©');
      }
    }, 2000); // å»¶é²2ç§’
  }

  // åˆå§‹åŒ–æ‡‰ç”¨
  async function init() {
    console.log('ğŸš€ åˆå§‹åŒ–åˆ†åº—åœ°åœ–ç³»çµ±...');

    try {
      // è¼‰å…¥åˆ†åº—æ•¸æ“š
      await loadStoreData();

      // åˆå§‹åŒ–åœ°åœ–
      initializeMap();

      // æ¸²æŸ“åº—å®¶åˆ—è¡¨
      renderStoreList();

      // ç­‰å¾…åœ°åœ–å®Œå…¨è¼‰å…¥å¾Œå†æ·»åŠ æ¨™è¨˜
      setTimeout(() => {
        addStoreMarkersToMap();
      }, 500); // ç¨å¾®ç¸®çŸ­å»¶é²

      // è«‹æ±‚ç”¨æˆ¶ä½ç½®
      requestUserLocation();

      console.log('âœ… åˆ†åº—åœ°åœ–ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
      // æˆåŠŸå®Œæˆå¾Œï¼Œéš±è—è¼‰å…¥é®ç½©
      hideLoadingOverlay();

    } catch (error) {
      console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
      document.getElementById('store-list').innerHTML = '<div class="error">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
      // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä¹Ÿè¦éš±è—è¼‰å…¥é®ç½©
      hideLoadingOverlay();
    }
  }

  // è¼‰å…¥åˆ†åº—æ•¸æ“š - æ”¹ç”¨Google Apps Script API
  async function loadStoreData() {
    console.log('ğŸ”„ å¾Google Apps Scriptè¼‰å…¥åˆ†åº—æ•¸æ“š...');

    try {
      const response = await fetch(GAS_WEB_APP_URL + '?action=getStoreMapData');

      if (!response.ok) {
        throw new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—: ' + response.status);
      }

      const result = await response.json();

      if (result.success && result.data) {
        // --- é‡è¦ï¼šé€™è£¡çš„è³‡æ–™æ˜ å°„é‚è¼¯éœ€è¦ç¬¦åˆ store-map.html çš„éœ€æ±‚ ---
        storeData = result.data.map(store => ({
          id: store['åº—é‹ªID'],
          name: store['åº—é‹ªåç¨±'],
          address: store['åœ°å€'],
          phone: store['é›»è©±'],
          lat: parseFloat(store['ç·¯åº¦']),
          lng: parseFloat(store['ç¶“åº¦']),
          businessHours: store['ç‡Ÿæ¥­æ™‚é–“'],
          isOpen: store['isOpen'],
          specialOffers: store['ä¿ƒéŠ·è¨Šæ¯'] ? [store['ä¿ƒéŠ·è¨Šæ¯']] : [],
          hasPanda: !!store['ç†Šè²“å¤–é€ç¶²å€'],
          hasUber: !!store['Uberå¤–é€ç¶²å€'],
          onlineOrderUrl: store['ç·šä¸Šé»é¤ç¶²å€'] || '',
          pandaUrl: store['ç†Šè²“å¤–é€ç¶²å€'] || '',
          uberUrl: store['Uberå¤–é€ç¶²å€'] || '',
          status: store['status'] || (store['isOpen'] ? 'active' : 'closed')
        }));
        
        console.log('âœ… æˆåŠŸè¼‰å…¥', storeData.length, 'å€‹åˆ†åº—');
      } else {
        throw new Error(result.error || 'ç„¡æ³•ç²å–åˆ†åº—è³‡æ–™');
      }

    } catch (error) {
      console.error('âŒ è¼‰å…¥åˆ†åº—æ•¸æ“šå¤±æ•—:', error);
      // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå¯ä»¥é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯æˆ–ä½¿ç”¨å‚™ç”¨è³‡æ–™
      storeData = []; // æ¸…ç©ºè³‡æ–™ä»¥é¿å…é¡¯ç¤ºèˆŠçš„æˆ–éŒ¯èª¤çš„å…§å®¹
      document.getElementById('store-list').innerHTML = '<div class="error">ç„¡æ³•è¼‰å…¥åˆ†åº—è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
    }
  }



    // åˆå§‹åŒ–åœ°åœ–
    function initializeMap() {
      try {
        // å‰µå»ºåœ°åœ–ï¼Œä¸­å¿ƒé»è¨­åœ¨æ¡ƒåœ’ï¼Œç¸®æ”¾ç´šåˆ¥èª¿ä½ä»¥é¡¯ç¤ºæ›´å¤§ç¯„åœ
        map = L.map('map').setView([24.9500, 121.2200], 10);

        // æ·»åŠ åœ°åœ–åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        console.log('âœ… åœ°åœ–åˆå§‹åŒ–å®Œæˆ');

        // å¦‚æœæœ‰åˆ†åº—æ•¸æ“šï¼Œèª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰åˆ†åº—
        if (storeData && storeData.length > 0) {
          setTimeout(() => {
            fitMapToStores();
          }, 1000);
        }

      } catch (error) {
        console.error('âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">åœ°åœ–è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰åˆ†åº—
    function fitMapToStores() {
  if (!map || !storeData || storeData.length === 0) return;

  try {
    const bounds = L.latLngBounds();

    // åŠ å…¥æ‰€æœ‰åˆ†åº—
    storeData.forEach(store => {
      bounds.extend([store.lat, store.lng]);
    });

    // åŠ å…¥ç›®å‰ä½ç½®ï¼ˆè‹¥æœ‰ï¼‰
    if (userLocation) {
      bounds.extend([userLocation.lat, userLocation.lng]);
    }

    map.fitBounds(bounds, { padding: [20, 20] });
    console.log('âœ… åœ°åœ–è¦–é‡å·²èª¿æ•´åŒ…å«åˆ†åº—èˆ‡ç”¨æˆ¶ä½ç½®');
  } catch (error) {
    console.error('âŒ èª¿æ•´åœ°åœ–è¦–é‡å¤±æ•—:', error);
  }
}


    // æ·»åŠ åˆ†åº—æ¨™è¨˜åˆ°åœ°åœ–
    function addStoreMarkersToMap() {
      if (!map || !storeData.length) return;

      try {
        console.log('ğŸ—ºï¸ é–‹å§‹æ·»åŠ é›æ’åœ–ç¤ºæ¨™è¨˜...');

        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        if (window.storeMarkers) {
          window.storeMarkers.forEach(marker => {
            map.removeLayer(marker);
          });
        }
        window.storeMarkers = [];

        // ä½¿ç”¨emojiåœ–æ¨™ä½œç‚ºä¸»è¦æ–¹æ¡ˆï¼ˆæ›´ç©©å®šï¼‰
        storeData.forEach((store, index) => {
          // ç¢ºä¿åº§æ¨™æ˜¯æ•¸å­—é¡å‹
          const lat = parseFloat(store.lat);
          const lng = parseFloat(store.lng);

          console.log(`ğŸ“ æ·»åŠ åˆ†åº—æ¨™è¨˜ ${index + 1}: ${store.name} at [${lat}, ${lng}]`);

          // é©—è­‰åº§æ¨™æœ‰æ•ˆæ€§
          if (isNaN(lat) || isNaN(lng)) {
            console.error(`âŒ ç„¡æ•ˆåº§æ¨™: ${store.name} - lat: ${store.lat}, lng: ${store.lng}`);
            return;
          }

          // æª¢æŸ¥ç‡Ÿæ¥­ç‹€æ…‹ - è§£æç‡Ÿæ¥­æ™‚é–“ JSON å­—ä¸²
          let businessHours = {};
          try {
            businessHours = typeof store.businessHours === 'string'
              ? JSON.parse(store.businessHours)
              : (store.businessHours || {});
          } catch (e) {
            console.error(`âŒ è§£æç‡Ÿæ¥­æ™‚é–“å¤±æ•—: ${store.name}`, e);
            businessHours = {};
          }
          const isStoreOpen = checkIfStoreIsOpen(store, businessHours);

const chickenIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/chatscai10/bjg8/refs/heads/main/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png',
  iconSize: [42, 64],
  iconAnchor: [21, 64], // åœ–ç‰‡ä¸‹ç·£ä¸­é–“
  popupAnchor: [0, -64]
});

          const marker = L.marker([lat, lng], { icon: chickenIcon }).addTo(map);

          const popupContent = `
            <div style="text-align: center; font-family: 'SF Pro Display', sans-serif; min-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: #1f2937;">ğŸ— ${store.name}</h4>
              <p style="margin: 4px 0; color: #6b7280; font-size: 13px;"><strong>åœ°å€:</strong> ${store.address}</p>
              <p style="margin: 4px 0; color: #6b7280; font-size: 13px;"><strong>é›»è©±:</strong> <a href="tel:${store.phone}" style="color: #3b82f6;">${store.phone}</a></p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>ç‹€æ…‹:</strong> <span style="color: ${isStoreOpen ? '#10b981' : '#f87171'}; font-weight: 600;">${isStoreOpen ? 'ğŸŸ¢ ç‡Ÿæ¥­ä¸­' : 'ğŸ”´ ä¼‘æ¯ä¸­'}</span></p>
              ${store.specialOffers && store.specialOffers.length > 0 ? `
                <p style="margin: 4px 0; color: #f59e0b; font-weight: 600; font-size: 13px;">ğŸ‰ ${store.specialOffers.join(', ')}</p>
              ` : ''}
              <div style="margin-top: 8px;">
                <button onclick="openGoogleMaps(${lat}, ${lng}, '${store.name}')"
                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer;">
                  ğŸ—ºï¸ å°èˆª
                </button>
                <button onclick="callStore('${store.phone}')"
                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer;">
                  ğŸ“ æ’¥æ‰“
                </button>
              </div>
            </div>
          `;

          marker.bindPopup(popupContent);
          window.storeMarkers.push(marker);
        });

        console.log(`âœ… å·²æ·»åŠ  ${window.storeMarkers.length} å€‹é›æ’emojiæ¨™è¨˜`);

        // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
        fitMapToStores();

      } catch (error) {
        console.error('âŒ æ·»åŠ åˆ†åº—æ¨™è¨˜å¤±æ•—:', error);
      }
    }

    // è¨ˆç®—å…©é»é–“è·é›¢ï¼ˆå…¬é‡Œï¼‰
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // æ¸²æŸ“åº—å®¶åˆ—è¡¨
    function renderStoreList() {
      const storeList = document.getElementById('store-list');
      storeList.innerHTML = '';

      // è¨ˆç®—æ¯å€‹åˆ†åº—çš„è·é›¢ä¸¦æ’åº
      let sortedStores = [...storeData];

      if (userLocation) {
        // è¨ˆç®—è·é›¢ä¸¦åŠ å…¥åˆ°åˆ†åº—è³‡æ–™ä¸­
        sortedStores = storeData.map(store => {
          const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            parseFloat(store.lat), parseFloat(store.lng)
          );
          console.log(`ğŸ“ ${store.name} è·é›¢: ${distance.toFixed(2)}km`);
          return { ...store, distance: distance };
        });

        // æŒ‰è·é›¢æ’åºï¼ˆè¿‘åˆ°é ï¼‰
        sortedStores.sort((a, b) => a.distance - b.distance);
        console.log('âœ… åˆ†åº—å·²æŒ‰è·é›¢æ’åº:', sortedStores.map(s => `${s.name}: ${s.distance?.toFixed(2)}km`));
      }

      sortedStores.forEach(store => {
        const storeElement = createStoreCard(store);
        storeList.appendChild(storeElement);
      });

      console.log(`âœ… æ¸²æŸ“ ${sortedStores.length} å€‹åº—å®¶å¡ç‰‡`);
    }

// å‰µå»ºåº—å®¶å¡ç‰‡ - ä½¿ç”¨ç¯„æœ¬åœ°åœ–çš„é€²éšæ•ˆæœ
function createStoreCard(store) {
  const storeItem = document.createElement('div');
  storeItem.className = 'store-item';
  storeItem.setAttribute('data-store-id', store.id);

  // --- æ–°çµæ§‹ï¼šå¡ç‰‡é è¨­æ˜¯æ”¶åˆçš„ ---
  // å¡ç‰‡é»æ“Šæ™‚æœƒåˆ‡æ› 'expanded' class
  storeItem.addEventListener('click', (e) => {
    // é˜»æ­¢é»æ“ŠæŒ‰éˆ•ã€é€£çµæˆ–ç‡Ÿæ¥­æ™‚é–“å±•é–‹æŒ‰éˆ•æ™‚è§¸ç™¼æ”¶åˆ
    if (e.target.closest('a, button, .business-hours-toggle')) {
      return;
    }
    // å°æ–¼ä¼‘æ¯ä¸­çš„åº—å®¶ï¼Œé»æ“Šäº‹ä»¶ç”± addClosedStoreClickEffect çµ±ä¸€è™•ç†
    if (storeItem.classList.contains('store-closed')) {
      return;
    }

    // å…ˆæ”¶èµ·æ‰€æœ‰å…¶ä»–å¡ç‰‡
    document.querySelectorAll('.store-item.expanded').forEach(item => {
      if (item !== storeItem) {
        item.classList.remove('expanded');
        // åŒæ™‚æ”¶èµ·è©²å¡ç‰‡çš„ç‡Ÿæ¥­æ™‚é–“
        const hoursDetails = item.querySelector('.business-hours-details');
        const hoursToggle = item.querySelector('.business-hours-toggle');
        if (hoursDetails) hoursDetails.classList.remove('expanded');
        if (hoursToggle) hoursToggle.classList.remove('expanded');
      }
    });

    // åˆ‡æ›ç•¶å‰å¡ç‰‡
    storeItem.classList.toggle('expanded');
  });

  const storeCard = document.createElement('div');
  storeCard.className = 'store-card';

  const storeFront = document.createElement('div');
  storeFront.className = 'store-front';
  
  // --- æ–°çµæ§‹ï¼šå°‡æ¨™é¡Œå’Œåœ°å€åˆ†é–‹ ---
  const storeHeader = document.createElement('div');
  storeHeader.className = 'store-front-header';

  // ç”Ÿæˆä¿ƒéŠ·æ´»å‹•æ–‡å­—ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  const promotionText = (store.specialOffers && store.specialOffers.length > 0) ?
    `<span class="store-name-promotion">${store.specialOffers[0]}</span>` : '';

  storeHeader.innerHTML = `
    <h3>
      <span>${store.name}</span>
      ${promotionText}
    </h3>
    <span class="expand-arrow">â–¼</span>
  `;
  
  const storeAddress = document.createElement('div');
  storeAddress.className = 'store-address';

  // é¡¯ç¤ºåœ°å€å’Œè·é›¢
  let addressText = store.address;
  if (store.distance !== undefined) {
    const distanceText = store.distance < 1
      ? `${Math.round(store.distance * 1000)}m`
      : `${store.distance.toFixed(1)}km`;
    addressText += ` <span style="font-size: 11px; color: #6b7280; font-weight: 500;">(è·é›¢ ${distanceText})</span>`;
  }
  storeAddress.innerHTML = addressText;

  storeFront.appendChild(storeHeader);
  storeFront.appendChild(storeAddress);

  // --- æ–°çµæ§‹ï¼šå»ºç«‹ä¸€å€‹å¯æ”¶åˆçš„å…§å®¹å®¹å™¨ ---
  const collapsibleContent = document.createElement('div');
  collapsibleContent.className = 'store-collapsible-content';

  // åŸºæœ¬è³‡è¨Š
  const basicInfo = document.createElement('div');
  basicInfo.className = 'basic-info';
  
  let businessHours = {};
  try {
    businessHours = typeof store.businessHours === 'string' ? JSON.parse(store.businessHours) : (store.businessHours || {});
  } catch (e) {
    console.error(`âŒ è§£æç‡Ÿæ¥­æ™‚é–“å¤±æ•—: ${store.name}`, e);
    businessHours = {};
  }
  
  let hoursDisplay = '';
  if (Object.keys(businessHours).length > 0) {
    const storeId = store.id;
    hoursDisplay = `
      <div class="business-hours-toggle" onclick="toggleBusinessHours('${storeId}')">
        <strong>ğŸ•’ ç‡Ÿæ¥­æ™‚é–“</strong>
        <span class="toggle-icon">â–¼</span>
      </div>
      <div class="business-hours-details" id="hours-${storeId}">
    `;
    Object.entries(businessHours).forEach(([day, hours]) => {
      hoursDisplay += `<div class="day-hours"><span class="day-name">${day}</span><span class="day-time">${hours}</span></div>`;
    });
    hoursDisplay += '</div>';
  }

  // --- æ–°å¢ï¼šä¿ƒéŠ·è¨Šæ¯é¡¯ç¤º ---
  let promotionDisplay = '';
  if (store.specialOffers && store.specialOffers.length > 0 && store.specialOffers[0]) {
    promotionDisplay = `<p style="margin-top:8px;"><strong>ğŸ‰ ä¿ƒéŠ·æ´»å‹•ï¼š</strong><span class="promotion-text">${store.specialOffers.join(', ')}</span></p>`;
  }

  basicInfo.innerHTML = `
    <div>
      <p><strong>ğŸ“ é›»è©±ï¼š</strong><a href='tel:${store.phone.replace(/-/g, '')}'>${store.phone}</a></p>
      ${promotionDisplay}
      ${hoursDisplay}
    </div>
  `;
  collapsibleContent.appendChild(basicInfo);

  // ç‡Ÿæ¥­ç‹€æ…‹
  const isOpen = checkIfStoreIsOpen(store, businessHours);

  // ç‚ºç‡Ÿæ¥­ä¸­çš„åº—å®¶æ·»åŠ  store-open é¡ä»¥è§¸ç™¼é‡‘è‰²é–ƒçˆæ•ˆæœ
  if (isOpen) {
    storeItem.classList.add('store-open');
  }

  const statusInfo = document.createElement('div');
  statusInfo.className = 'status-info';
  statusInfo.innerHTML = `
    <strong style="color: #374151;">ç‹€æ…‹ï¼š</strong>
    <span class="${isOpen ? 'open-status clickable-status' : 'closed-status'}" ${isOpen ? `onclick="window.open('${store.orderUrl || 'https://www.foodpanda.com.tw'}', '_blank')"` : ''}>${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­'}</span>
  `;
  collapsibleContent.appendChild(statusInfo);

  // æŒ‰éˆ•ç¾¤çµ„
  const btnGroup = document.createElement('div');
  btnGroup.className = 'btn-group';
  
  // æŒ‰éˆ•å…§å®¹ - æ–°é †åºï¼šUberã€å°èˆªã€æ’¥æ‰“ã€ç†Šè²“
  const topRowButtons = `
    <button onclick="openUberOrder('${store.uberUrl}')" ${!store.uberUrl ? 'disabled' : ''}>ğŸš— Uber</button>
    <button onclick="openGoogleMaps(${store.lat}, ${store.lng}, '${store.name}')">ğŸ—ºï¸ å°èˆª</button>
    <button onclick="callStore('${store.phone}')">ğŸ“ æ’¥æ‰“</button>
    <button onclick="openPandaOrder('${store.pandaUrl}')" ${!store.pandaUrl ? 'disabled' : ''}>ğŸ¼ ç†Šè²“</button>
  `;

  const bottomRowButton = `
    <button onclick="openOnlineOrder('${store.onlineOrderUrl}')" ${!store.onlineOrderUrl ? 'disabled' : ''} class="full-width-btn">ğŸ— ç·šä¸Šé»é¤</button>
  `;

  btnGroup.innerHTML = `
    <div class="btn-row">${topRowButtons}</div>
    <div class="btn-row">${bottomRowButton}</div>
  `;

  // è™•ç†ç¦ç”¨æŒ‰éˆ•çš„ç–ŠåŠ æç¤º
  btnGroup.querySelectorAll('button[disabled]').forEach(btn => {
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      btn.style.position = 'relative';
      const overlay = document.createElement('div');
      overlay.style.cssText = `position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0,0,0,0.6);color: white;font-size: 10px;display: flex;align-items: center;justify-content: center;border-radius: inherit;`;
      overlay.textContent = 'æš«ç„¡æœå‹™';
      btn.appendChild(overlay);
  });
  
  collapsibleContent.appendChild(btnGroup);

  // å°‡å¯æ”¶åˆå®¹å™¨åŠ å…¥åˆ°å¡ç‰‡æ­£é¢
  storeFront.appendChild(collapsibleContent);

  // ä¼‘æ¯ä¸­åº—å®¶é®ç½©æ•ˆæœ
  if (!isOpen) {
    storeItem.classList.add('store-closed');
    const maskContent = document.createElement('div');
    maskContent.className = 'closed-mask-content';
    const nextOpenTime = getNextOpenTime(store.businessHours);
    maskContent.innerHTML = `
      <div class="closed-icon">ğŸ˜´</div>
      <div class="closed-store-name" style="color: #ffffff; font-weight: bold; font-size: 18px; text-shadow: 3px 3px 0 #000, -3px -3px 0 #000, 3px -3px 0 #000, -3px 3px 0 #000, 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 1px 1px 2px rgba(0,0,0,0.9);">${store.name}</div>
      <div class="closed-status" style="color: #ffffff; font-weight: bold; font-size: 16px; text-shadow: 3px 3px 0 #000, -3px -3px 0 #000, 3px -3px 0 #000, -3px 3px 0 #000, 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 1px 1px 2px rgba(0,0,0,0.9);">ä¼‘æ¯ä¸­</div>
      <div style="color: #ffffff; font-size: 13px; margin-top: 4px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">ä¸‹æ¬¡ç‡Ÿæ¥­ï¼š${nextOpenTime}</div>
    `;
    storeItem.appendChild(maskContent);
    addClosedStoreClickEffect(storeItem);
  }

  storeCard.appendChild(storeFront);
  storeItem.appendChild(storeCard);

  // åˆ¤æ–·æ˜¯å¦ç‡Ÿæ¥­ä¸­ï¼Œä¸¦æ·»åŠ ç«ç„°ç‰¹æ•ˆ class
  if (isOpen) {
    storeCard.classList.add('flame-border');
  }

  return storeItem;
}

    // è«‹æ±‚ç”¨æˆ¶ä½ç½®
    async function requestUserLocation() {
      if (isLocationRequested) return;

      try {
        isLocationRequested = true;

        // æª¢æŸ¥æ˜¯å¦æœ‰ç·©å­˜çš„ä½ç½®
        const cachedLocation = localStorage.getItem('userLocation');
        if (cachedLocation) {
          userLocation = JSON.parse(cachedLocation);
          updateMapWithUserLocation();
          return;
        }

        // è«‹æ±‚æ–°çš„ä½ç½®
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              // ç·©å­˜ä½ç½®
              localStorage.setItem('userLocation', JSON.stringify(userLocation));

              updateMapWithUserLocation();
              console.log('âœ… ç”¨æˆ¶ä½ç½®ç²å–æˆåŠŸ');
            },
            (error) => {
              console.warn('âš ï¸ ç„¡æ³•ç²å–ç”¨æˆ¶ä½ç½®:', error);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000 // 5åˆ†é˜ç·©å­˜
            }
          );
        }
      } catch (error) {
        console.error('âŒ ä½ç½®è«‹æ±‚å¤±æ•—:', error);
      }
    }

    // æ›´æ–°åœ°åœ–é¡¯ç¤ºç”¨æˆ¶ä½ç½®
    function updateMapWithUserLocation() {
      if (!map || !userLocation) return;

      try {
        // æ·»åŠ ç”¨æˆ¶ä½ç½®æ¨™è¨˜
const userIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/chatscai10/bjg8/refs/heads/main/line/754e3924-3cc8-46a9-b512-48aaf012d1dd.png',
  iconSize: [42, 64],
  iconAnchor: [21, 64], // åŒæ¨£åœ–ç‰‡ä¸‹ç·£ä¸­é–“
  popupAnchor: [0, -64]
});


        L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
          .addTo(map)
          .bindPopup('åƒé›æ’æ‰¾ ä¸æ—© ~')
          .openPopup();

        // èª¿æ•´åœ°åœ–è¦–é‡åŒ…å«ç”¨æˆ¶ä½ç½®å’Œæ‰€æœ‰åˆ†åº—
        const allPoints = [
          [userLocation.lat, userLocation.lng],
          ...storeData.map(store => [store.lat, store.lng])
        ];

        const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
        map.fitBounds(group.getBounds().pad(0.1));

        // é‡æ–°æ¸²æŸ“åº—å®¶åˆ—è¡¨ä»¥é¡¯ç¤ºè·é›¢æ’åº
        renderStoreList();

        console.log('âœ… åœ°åœ–å·²æ›´æ–°ç”¨æˆ¶ä½ç½®ï¼Œåº—å®¶åˆ—è¡¨å·²é‡æ–°æ’åº');
      } catch (error) {
        console.error('âŒ æ›´æ–°ç”¨æˆ¶ä½ç½®å¤±æ•—:', error);
      }
    }

    // é–‹å•ŸGoogleåœ°åœ–å°èˆª
    function openGoogleMaps(lat, lng, storeName) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(storeName)}`;
      openExternalOrHref(url);
    }

    // æ’¥æ‰“é›»è©±
    function callStore(phone) {
      window.location.href = `tel:${phone}`;
    }

    // é–‹å•Ÿç·šä¸Šé»é¤
    function openOnlineOrder(onlineOrderUrl) {
      if (onlineOrderUrl) {
        openExternalOrHref(onlineOrderUrl);
      } else {
        console.log('âš ï¸ æ­¤åˆ†åº—æš«ç„¡ç·šä¸Šé»é¤æœå‹™');
      }
    }

    // é–‹å•Ÿç†Šè²“å¤–é€
    function openPandaOrder(pandaUrl) {
      if (pandaUrl) {
        openExternalOrHref(pandaUrl);
      } else {
        console.log('âš ï¸ æ­¤åˆ†åº—æš«ç„¡ç†Šè²“å¤–é€æœå‹™');
      }
    }

    // é–‹å•ŸUberå¤–é€
    function openUberOrder(uberUrl) {
      if (uberUrl) {
        openExternalOrHref(uberUrl);
      } else {
        console.log('âš ï¸ æ­¤åˆ†åº—æš«ç„¡Uberå¤–é€æœå‹™');
      }
    }

function addClosedStoreClickEffect(storeElement) {
  storeElement.addEventListener('click', function (e) {
    // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ã€é€£çµæˆ–ç‡Ÿæ¥­æ™‚é–“å±•é–‹æŒ‰éˆ•ï¼Œå°±ç•¥é
    if (e.target.closest('a, button, .business-hours-toggle')) {
      return;
    }

    // å…ˆæ”¶èµ·æ‰€æœ‰å…¶ä»–å¡ç‰‡
    document.querySelectorAll('.store-item.expanded').forEach(item => {
      if (item !== storeElement) {
        item.classList.remove('expanded');
        item.classList.remove('clicked-transparent');
        // åŒæ™‚æ”¶èµ·è©²å¡ç‰‡çš„ç‡Ÿæ¥­æ™‚é–“
        const hoursDetails = item.querySelector('.business-hours-details');
        const hoursToggle = item.querySelector('.business-hours-toggle');
        if (hoursDetails) hoursDetails.classList.remove('expanded');
        if (hoursToggle) hoursToggle.classList.remove('expanded');
      }
    });

    // åˆ‡æ›é®ç½©é€æ˜åº¦
    storeElement.classList.toggle('clicked-transparent');

    // åŒæ™‚åˆ‡æ›å¡ç‰‡å±•é–‹ç‹€æ…‹
    storeElement.classList.toggle('expanded');
    
    console.log(`  é»æ“Šä¼‘æ¯ä¸­åº—å®¶ ${storeElement.dataset.storeId} â†’ åˆ‡æ›é¡¯ç¤ºç‹€æ…‹`);
  });
}


    // æ‰‹å‹•è«‹æ±‚å®šä½
    function manualRequestLocation() {
      const btn = document.getElementById('locate-btn');

      // é‡ç½®ç‹€æ…‹
      isLocationRequested = false;
      userLocation = null;

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      btn.innerHTML = 'ğŸ”„ å®šä½ä¸­...';
      btn.disabled = true;

      // æ¸…é™¤ç·©å­˜
      localStorage.removeItem('userLocation');

      // é‡æ–°è«‹æ±‚ä½ç½®
      requestUserLocation().finally(() => {
        btn.innerHTML = 'ğŸ“ é‡æ–°å®šä½';
        btn.disabled = false;
      });
    }

    // å¤–éƒ¨é€£çµé–‹å•Ÿ
    function openExternalOrHref(finalUrl) {
      if (typeof liff !== "undefined" && liff.isInClient()) {
        liff.openWindow({
          url: finalUrl,
          external: true
        });
      } else {
        window.open(finalUrl, "_blank");
      }
    }

    // é–‹å•ŸLINEåŠ å¥½å‹
    function openLineAddFriend() {
      const lineAddFriendUrl = 'https://line.me/R/ti/p/@fried'; // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„LINE ID
      console.log('ğŸ” é»æ“Šæ‡¸æµ®é›æ’ï¼Œé–‹å•ŸLINEåŠ å¥½å‹');
      openExternalOrHref(lineAddFriendUrl);
    }

    // æª¢æŸ¥åˆ†åº—æ˜¯å¦ç‡Ÿæ¥­ä¸­
    function checkIfStoreIsOpen(store, businessHours) {
      // å¦‚æœåˆ†åº—è¨­å®šç‚ºé—œé–‰ï¼Œç›´æ¥è¿”å›false
      if (store.isOpen === false) {
        console.log(`âŒ ${store.name} åˆ†åº—è¨­å®šç‚ºé—œé–‰ (store.isOpen = false)`);
        return false;
      }

      // ä½¿ç”¨æ¸¬è©¦æ™‚é–“æˆ–å¯¦éš›æ™‚é–“
      const now = testTime || new Date();
      const currentDay = now.getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, ..., 6=é€±å…­
      const currentTime = now.getHours() * 100 + now.getMinutes(); // ä¾‹å¦‚: 14:30 = 1430

      // å°‡æ•¸å­—è½‰æ›ç‚ºä¸­æ–‡æ˜ŸæœŸ
      const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
      const todayName = dayNames[currentDay];

      // ç²å–ä»Šå¤©çš„ç‡Ÿæ¥­æ™‚é–“
      const todayHours = businessHours[todayName];

      console.log(`ğŸ•’ ç‡Ÿæ¥­æ™‚é–“æª¢æŸ¥ - åˆ†åº—: ${store.name}`);
      console.log(`   ğŸ“… ä»Šå¤©: ${todayName} (${currentDay})`);
      console.log(`   â° ç•¶å‰æ™‚é–“: ${Math.floor(currentTime/100)}:${String(currentTime%100).padStart(2,'0')} (${currentTime})`);
      console.log(`   ğŸª ç‡Ÿæ¥­æ™‚é–“: ${todayHours}`);
      console.log(`   ğŸ“‹ å®Œæ•´ç‡Ÿæ¥­æ™‚é–“:`, businessHours);

      if (!todayHours || todayHours === 'ä¼‘æ¯' || todayHours === 'å…¬ä¼‘') {
        console.log(`âŒ ${store.name} ä»Šå¤©ä¼‘æ¯æˆ–ç„¡ç‡Ÿæ¥­æ™‚é–“è¨­å®š`);
        return false;
      }





      // è§£æç‡Ÿæ¥­æ™‚é–“ - æ”¯æ´å¤šæ™‚æ®µæ ¼å¼ (ä¾‹å¦‚: "11:00-21:00" æˆ– "00:00-01:00,15:00-24:00")
      const timeSegments = todayHours.split(',').map(segment => segment.trim());
      console.log(`ğŸ“Š ${store.name} æ™‚é–“æ®µè§£æ: ${timeSegments.join(' + ')}`);

      let isOpen = false;

      for (const segment of timeSegments) {
        const timeMatch = segment.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
        if (!timeMatch) {
          console.log(`âš ï¸ ${store.name} ç„¡æ³•è§£ææ™‚é–“æ®µæ ¼å¼: ${segment}`);
          continue;
        }

        const openTime = parseInt(timeMatch[1]) * 100 + parseInt(timeMatch[2]);
        const closeTime = parseInt(timeMatch[3]) * 100 + parseInt(timeMatch[4]);

        console.log(`   ğŸ“Š æ™‚é–“æ®µ: ${segment}`);
        console.log(`   ğŸ”“ é–‹åº—æ™‚é–“: ${openTime} (${Math.floor(openTime/100)}:${String(openTime%100).padStart(2,'0')})`);
        console.log(`   ğŸ”’ é—œåº—æ™‚é–“: ${closeTime} (${Math.floor(closeTime/100)}:${String(closeTime%100).padStart(2,'0')})`);
        console.log(`   â° ç•¶å‰æ™‚é–“: ${currentTime} (${Math.floor(currentTime/100)}:${String(currentTime%100).padStart(2,'0')})`);

        // æª¢æŸ¥ç•¶å‰æ™‚é–“æ˜¯å¦åœ¨é€™å€‹æ™‚é–“æ®µå…§
        let segmentOpen;
        if (closeTime > openTime) {
          // æ­£å¸¸æƒ…æ³ï¼šä¸è·¨æ—¥ (ä¾‹å¦‚: 11:00-21:00)
          segmentOpen = currentTime >= openTime && currentTime < closeTime;
          console.log(`   ğŸ“‹ åˆ¤æ–·é‚è¼¯: ${currentTime} >= ${openTime} && ${currentTime} < ${closeTime} = ${segmentOpen}`);
        } else {
          // è·¨æ—¥æƒ…æ³ï¼š(ä¾‹å¦‚: 22:00-02:00)
          segmentOpen = currentTime >= openTime || currentTime < closeTime;
          console.log(`   ğŸ“‹ è·¨æ—¥åˆ¤æ–·é‚è¼¯: ${currentTime} >= ${openTime} || ${currentTime} < ${closeTime} = ${segmentOpen}`);
        }

        if (segmentOpen) {
          isOpen = true;
          console.log(`   âœ… åœ¨æ™‚é–“æ®µ ${segment} å…§ç‡Ÿæ¥­ä¸­`);
          break; // åªè¦æœ‰ä¸€å€‹æ™‚é–“æ®µç‡Ÿæ¥­ä¸­å°±å¯ä»¥äº†
        } else {
          console.log(`   âŒ ä¸åœ¨æ™‚é–“æ®µ ${segment} å…§`);
        }
      }

      console.log(`${isOpen ? 'âœ…' : 'âŒ'} ${store.name} æœ€çµ‚çµæœ: ${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­'}`);
      return isOpen;
    }


function getNextOpenTime(businessHours) {
  const now = testTime || new Date(); // ä½¿ç”¨æ¸¬è©¦æ™‚é–“æˆ–å¯¦éš›æ™‚é–“
  const currentDay = now.getDay();
  const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];

  for (let i = 1; i <= 7; i++) {
    const nextDayIndex = (currentDay + i) % 7;
    const nextDayName = dayNames[nextDayIndex];
    const hours = businessHours[nextDayName];

    if (hours && hours !== 'ä¼‘æ¯') {
      return (i === 1 ? 'æ˜å¤©' : nextDayName) + ' ' + hours.split('-')[0] + ' é–‹å§‹ç‡Ÿæ¥­';
    }
  }

  return 'å°šæœªè¨­å®šç‡Ÿæ¥­æ™‚é–“';
}


    // ç‡Ÿæ¥­æ™‚é–“å±•é–‹/æ”¶èµ·åŠŸèƒ½
    function toggleBusinessHours(storeId) {
      console.log(`ğŸ•’ åˆ‡æ›ç‡Ÿæ¥­æ™‚é–“é¡¯ç¤º: ${storeId}`);

      const toggle = document.querySelector(`[onclick="toggleBusinessHours('${storeId}')"]`);
      const details = document.getElementById(`hours-${storeId}`);

      if (toggle && details) {
        const isExpanded = details.classList.contains('expanded');

        if (isExpanded) {
          // æ”¶èµ·
          details.classList.remove('expanded');
          toggle.classList.remove('expanded');
          console.log(`ğŸ“ ${storeId} ç‡Ÿæ¥­æ™‚é–“å·²æ”¶èµ·`);
        } else {
          // å±•é–‹
          details.classList.add('expanded');
          toggle.classList.add('expanded');
          console.log(`ğŸ“‚ ${storeId} ç‡Ÿæ¥­æ™‚é–“å·²å±•é–‹`);
        }
      }
    }

    // å•Ÿå‹•æ‡‰ç”¨
    document.addEventListener('DOMContentLoaded', init);

    // æ§åˆ¶å°æç¤º
    console.log('ğŸš€ ä¸æ—©è„†çš®é›æ’-åˆ†åº—åœ°åœ–å·²è¼‰å…¥ï¼');
  </script>
</body>
</html>
