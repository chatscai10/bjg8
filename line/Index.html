<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>不早脆皮雞排 - 分店地圖</title>

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://unpkg.com https://chatscai10.github.io https://static.line-scdn.net; object-src 'none';">

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
/* --- 全局與基本設定 --- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
  min-height: 100vh;
  color: #e1e5e9;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:
    radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
  z-index: -1;
}

.main-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 0;
  position: relative;
  z-index: 1;
  min-height: 100vh;
}

/* --- 全螢幕載入遮罩 --- */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease-out, visibility 0.6s;
  opacity: 1;
  visibility: visible;
}

#loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-content { text-align: center; }
.loading-logo {
  width: 120px;
  height: auto;
  margin-bottom: 24px;
  animation: pulse-glow 2.5s infinite ease-in-out;
}
.loading-text {
  color: #e1e5e9;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 1px;
}
.loading-subtext {
  color: #94a3b8;
  font-size: 14px;
  margin-top: 8px;
}
.loading-dots { display: inline-block; }
.loading-dots::after {
  content: '.';
  animation: loadingDots 1.4s steps(4, end) infinite;
}

/* --- 頁面元件 --- */
#announcement {
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  color: #94a3b8;
  padding: 16px 20px;
  text-align: center;
  font-weight: 500;
  font-size: 14px;
  position: relative;
}

#map {
  height: 300px;
  margin: 20px;
  border-radius: 12px;
  border: 1px solid rgba(59, 130, 246, 0.15);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  position: relative;
  background: rgba(15, 20, 25, 0.5);
}

#store-list { padding: 20px; }

/* --- 店家卡片基礎結構 --- */
.store-item {
  margin-bottom: 24px;
  position: relative;
}
.store-card {
  width: 100%;
  border-radius: 16px;
  overflow: visible; /* 為了讓火焰特效能溢出 */
  position: relative;
}
.store-front {
  width: 100%;
  border-radius: 16px;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(20px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(59, 130, 246, 0.1);
  position: relative;
  z-index: 2;
  overflow: hidden;
}

/* --- 卡片收合/展開效果 --- */
.store-front-header {
  padding: 16px 20px;
  cursor: pointer;
  position: relative;
  transition: background-color 0.3s ease;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.08) 100%);
  border-bottom: 1px solid rgba(59, 130, 246, 0.15);
}
.store-front-header:hover { background-color: rgba(59, 130, 246, 0.05); }
.store-front-header h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  color: #ffffff;
}
.expand-arrow {
  position: absolute;
  top: 50%;
  right: 20px;
  transform: translateY(-50%) rotate(0deg);
  transition: transform 0.4s ease;
  font-size: 16px;
  color: #60a5fa;
}
.store-item.expanded .expand-arrow { transform: translateY(-50%) rotate(180deg); }
.store-address {
  font-size: 14px;
  color: #94a3b8;
  padding: 12px 20px 16px;
  cursor: pointer;
  border-bottom: 1px solid rgba(59, 130, 246, 0.05);
}
.store-collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.store-item.expanded .store-collapsible-content { max-height: 500px; }
.basic-info {
  padding: 20px;
  color: #e0e0e0;
  font-size: 14px;
  line-height: 1.6;
}
.basic-info strong {
  color: #60a5fa;
  font-weight: 600;
}
.basic-info a {
  color: #10b981;
  text-decoration: none;
  transition: all 0.3s ease;
}
.basic-info a:hover {
  color: #34d399;
  text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
}
.status-info {
  padding: 12px 20px;
  background: rgba(0, 0, 0, 0.2);
  border-top: 1px solid rgba(59, 130, 246, 0.1);
}
.open-status {
  color: #34d399;
  font-weight: 600;
  text-shadow: 0 0 8px rgba(52, 211, 153, 0.4);
}
.closed-status {
  color: #f87171;
  font-weight: 600;
  text-shadow: 0 0 8px rgba(248, 113, 113, 0.4);
}

/* --- 卡片按鈕 --- */
.btn-group {
  padding: 20px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.btn-group button {
  flex: 1;
  min-width: 100px;
  padding: 12px 16px;
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(59, 130, 246, 0.1);
  color: #60a5fa;
  font-size: 14px;
  position: relative;
  overflow: hidden;
}
.btn-group button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
  border-color: #60a5fa;
  color: #ffffff;
  background: rgba(59, 130, 246, 0.2);
}

/* --- 休息中店家遮罩 --- */
.store-item.store-closed { cursor: pointer; }
.closed-mask-content {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 12;
  border-radius: 16px;
  backdrop-filter: blur(3px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  text-align: center;
  padding: 10px;
}
.closed-icon { font-size: 24px; margin-bottom: 8px; }
.closed-store-name {
  color: #ffffff;
  font-size: 16px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
  margin-bottom: 4px;
}
.closed-status {
  color: #ff6b6b;
  font-size: 14px;
  font-weight: 600;
}
.store-item.store-closed.clicked-transparent .closed-mask-content {
  background: rgba(0, 0, 0, 0.25) !important;
  backdrop-filter: blur(0.5px) !important;
}

/* --- 營業中火焰特效 --- */
.store-card.flame-border::before {
  content: '';
  position: absolute;
  top: -8px; left: -8px; right: -8px; bottom: -8px;
  z-index: 1;
  background: linear-gradient(45deg, #ffdd00, #ff8800, #ff4400);
  border-radius: 20px;
  filter: url(#flame-filter);
  animation: flameAnimation 2.2s infinite alternate;
  pointer-events: none;
}
.store-card.flame-border::after {
  content: '';
  position: absolute;
  top: -12px; left: -12px; right: -12px; bottom: -12px;
  z-index: 0;
  background: linear-gradient(60deg, #ffea00, #ff9800, #ff5722);
  border-radius: 24px;
  filter: url(#flame-filter);
  opacity: 0.5;
  animation: flameAnimation 3.1s infinite alternate-reverse;
  pointer-events: none;
}

/* --- 營業時間展開 --- */
.business-hours-toggle {
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  transition: background-color 0.3s ease;
}
.business-hours-toggle:hover { background: rgba(59, 130, 246, 0.05); }
.business-hours-toggle .toggle-icon {
  font-size: 12px;
  color: #60a5fa;
  transition: transform 0.3s ease;
}
.business-hours-toggle.expanded .toggle-icon { transform: rotate(180deg); }
.business-hours-details {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  background: rgba(59, 130, 246, 0.02);
  border-radius: 8px;
  margin-top: 8px;
}
.business-hours-details.expanded {
  max-height: 250px;
  padding: 12px;
}
.day-hours {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
  font-size: 13px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.05);
}
.day-hours:last-child { border-bottom: none; }
.day-name { color: #94a3b8; }
.day-time { color: #60a5fa; font-weight: 600; }

/* --- 懸浮雞排 --- */
.tech-floating-chicken {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 1000;
  cursor: pointer;
}
.chicken-container {
  position: relative;
  width: 130px;
  height: 130px;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: floatEnhanced 2.5s ease-in-out infinite;
}
.chicken-img {
  width: 150px;
  height: 150px;
  object-fit: contain;
  border-radius: 0;
  transition: all 0.3s ease;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}
.chicken-container:hover .chicken-img {
  transform: scale(1.1) rotate(5deg);
  filter: drop-shadow(0 6px 12px rgba(255, 215, 0, 0.5));
}
.chicken-tooltip {
  position: absolute;
  top: -40px;
  right: 0;
  left: 0;
  margin: auto;
  width: max-content;
  padding: 6px 10px;
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  font-size: 13px;
  border-radius: 8px;
  white-space: nowrap;
  opacity: 0;
  transform: translateY(10px);
  pointer-events: none;
  transition: all 0.3s ease;
  text-align: center;
  z-index: 1001;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.tech-floating-chicken:hover .chicken-tooltip {
  opacity: 1;
  transform: translateY(0);
}

/* 金光閃爍效果 - 縮小版 */
.golden-glow {
  position: absolute;
  top: 5px;
  left: 5px;
  right: 5px;
  bottom: 5px;
  border-radius: 20%;
  background: conic-gradient(
    from 0deg,
    #ffd700 0deg,
    #ffed4e 60deg,
    #fff59d 120deg,
    #ffd700 180deg,
    #ffb300 240deg,
    #ffd700 300deg,
    #fff176 360deg
  );
  animation: goldenRotate 5s linear infinite;
  opacity: 0.8;
  z-index: -1;
}

.golden-glow::before {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  right: 3px;
  bottom: 3px;
  background: rgba(15, 20, 25, 0.9);
  border-radius: 50%;
  z-index: 1;
}

@keyframes goldenRotate {
  0% {
    transform: rotate(0deg);
    opacity: 0.6;
  }
  50% {
    opacity: 1;
  }
  100% {
    transform: rotate(360deg);
    opacity: 0.6;
  }
}

/* --- 地圖標記 --- */
.user-location-marker {
  font-size: 24px;
  text-align: center;
  animation: userLocationPulse 2s infinite;
}

/* --- 動畫集合 --- */
@keyframes loadingDots {
  0% { content: "."; }
  33% { content: ".."; }
  66% { content: "..."; }
  100% { content: "."; }
}
@keyframes pulse-glow {
  0% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3)); }
  50% { transform: scale(1.05); filter: drop-shadow(0 0 16px rgba(255, 215, 0, 0.6)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3)); }
}
@keyframes flameAnimation {
  0%, 100% { transform: scale(1); opacity: 0.9; }
  50% { transform: scale(1.05); opacity: 1; }
}
@keyframes floatEnhanced {
  0% {
    transform: translate(0, 0) rotate(0deg);
  }
  25% {
    transform: translate(-5px, -4px) rotate(-4deg);
  }
  50% {
    transform: translate(0px, 6px) rotate(0deg);
  }
  75% {
    transform: translate(5px, -4px) rotate(4deg);
  }
  100% {
    transform: translate(0, 0) rotate(0deg);
  }
}
@keyframes userLocationPulse {
  0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(52, 211, 153, 0.7)); }
  50% { transform: scale(1.1); filter: drop-shadow(0 0 12px rgba(52, 211, 153, 1)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(52, 211, 153, 0.7)); }
}

/* --- 手機版響應式設計 --- */
@media (max-width: 480px) {
  #map { margin: 0; border-radius: 0; height: 250px; }
  #locate-btn { margin-top: 10px !important; }

  .tech-floating-chicken {
    width: 80px;
    height: 80px;
    right: 15px;
    top: auto;
    bottom: 20px;
    transform: none;
  }

  .chicken-container {
    width: 80px;
    height: 80px;
  }

  .chicken-img {
    width: 60px;
    height: 60px;
  }
}

.store-card.flame-border::before {
  content: '';
  position: absolute;
  top: -8px; left: -8px; right: -8px; bottom: -8px;
  z-index: -1;
  background: linear-gradient(45deg, #ffdd00, #ff8800, #ff4400);
  border-radius: 20px;
  filter: url(#flame-filter);
  animation: flameAnimation 2.2s infinite alternate;
  pointer-events: none;
}

/* 疊加一層不同延遲的火焰動畫，讓閃爍更不規則 */
.store-card.flame-border::after {
  content: '';
  position: absolute;
  top: -12px; left: -12px; right: -12px; bottom: -12px;
  z-index: -2;
  background: linear-gradient(60deg, #ffea00, #ff9800, #ff5722);
  border-radius: 24px;
  filter: url(#flame-filter);
  opacity: 0.5;
  animation: flameAnimation 3.1s infinite alternate-reverse;
  pointer-events: none;
}

/* 展開箭頭圖示 */
.expand-arrow {
  position: absolute;
  top: 50%;
  right: 20px;
  transform: translateY(-50%) rotate(0deg);
  transition: transform 0.4s ease;
  font-size: 16px;
  color: #60a5fa;
}

.store-item.expanded .expand-arrow {
  transform: translateY(-50%) rotate(180deg);
}

/* 修正休息中遮罩的 z-index，確保它在所有內容之上 */
.closed-mask-content {
  z-index: 12; /* 比按鈕(15)低，比內容(5)高 */
}
.store-item.store-closed .btn-group {
  z-index: 15;
}

/* 全螢幕載入遮罩 */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease-out, visibility 0.6s;
  opacity: 1;
  visibility: visible;
}

#loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-content {
  text-align: center;
}

.loading-logo {
  width: 120px;
  height: auto;
  margin-bottom: 24px;
  animation: pulse-glow 2.5s infinite ease-in-out;
}

.loading-text {
  color: #e1e5e9;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 1px;
}

.loading-subtext {
  color: #94a3b8;
  font-size: 14px;
  margin-top: 8px;
}

/* 載入中的 ... 動畫 */
.loading-dots {
  display: inline-block;
}
.loading-dots::after {
  content: '';
  display: inline-block;
  width: 1.2em;
  text-align: left;
  animation: loadingDots 1.2s steps(3, end) infinite;
}
@keyframes loadingDots {
  0% { content: ''; }
  33% { content: '.'; }
  66% { content: '..'; }
  100% { content: '...'; }
}

@keyframes pulse-glow {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
  }
  50% {
    transform: scale(1.05);
    filter: drop-shadow(0 0 16px rgba(255, 215, 0, 0.6));
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
  }
}
</style>
</head>
<body class="dynamic-colors">
<div id="loading-overlay">
  <div class="loading-content">
    <img src="https://chatscai10.github.io/bjg8/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png" alt="Loading Logo" class="loading-logo">
    <div class="loading-text">
      資料載入中<span class="loading-dots"></span>
    </div>
    <div class="loading-subtext">正在為您準備最新鮮的雞排資訊</div>
  </div>
</div>
<svg style="position:absolute; width:0; height:0; overflow:hidden;">
  <filter id="flame-filter">
    <feTurbulence type="fractalNoise" baseFrequency="0.02 0.05" numOctaves="2" seed="2" result="turbulence">
      <animate attributeName="seed" from="2" to="10" dur="2s" repeatCount="indefinite" />
    </feTurbulence>
    <feDisplacementMap in2="turbulence" in="SourceGraphic" scale="15" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg>
  <!-- 懸浮雞排裝飾 -->
  <div class="tech-floating-chicken" id="floating-chicken" onclick="openLineAddFriend()" title="點擊加LINE好友">
    <div class="chicken-container">
      <div class="golden-glow"></div>
      <img src="https://chatscai10.github.io/bjg8/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png"
           alt="不早脆皮雞排" class="chicken-img">
    </div>
<div class="chicken-tooltip">快來咬我</div>

  </div>

  <div class="main-container">
    <!-- 頂部公告區 -->
    <div id="announcement">
      🍗 歡迎來到不早脆皮雞排點餐地圖 | 點擊店家查看詳細資訊
      <div id="test-time-indicator" style="display: none; margin-top: 8px; padding: 8px; background: rgba(255, 193, 7, 0.2); border-radius: 6px; font-size: 13px;">
        <i class="fas fa-clock me-1"></i>
        <strong>測試模式：</strong><span id="test-time-display"></span>
      </div>
    </div>

    <!-- 地圖容器 -->
    <div id="map"></div>

    <!-- 定位按鈕 -->
    <div style="text-align: center; margin: 20px;">
      <button id="locate-btn" onclick="manualRequestLocation()" 
              style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px 24px; border-radius: 8px; cursor: pointer;">
        📍 重新定位
      </button>
    </div>

    <!-- 店家列表 -->
    <div id="store-list">
      <!-- 店家卡片將動態生成 -->
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  


  <!-- Firebase SDK -->




  <script>
  // 全域變數
  let map;
  let userLocation = null;
  let isLocationRequested = false;
  let storeData = [];
  let testTime = null; // 測試時間

  // Google Apps Script Web App URL
  const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZ1EWtf0SBF7nJiJVsoTWyHkGp5hU1n8f14w69Xrs_0x0tiET-aG9m49_fp1eUx-mc/exec';
  // ⛔️ 請再次確認這串URL是您正確且可公開存取的GAS Web App部署網址。
  
  console.log('🔧 Google Apps Script 配置已載入:', GAS_WEB_APP_URL);

  // 隱藏載入遮罩
  function hideLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.add('hidden');
      console.log('✅ 載入完成，隱藏遮罩');
    }
  }

  // 初始化應用
  async function init() {
    console.log('🚀 初始化分店地圖系統...');

    try {
      // 載入分店數據
      await loadStoreData();

      // 初始化地圖
      initializeMap();

      // 渲染店家列表
      renderStoreList();

      // 等待地圖完全載入後再添加標記
      setTimeout(() => {
        addStoreMarkersToMap();
      }, 500); // 稍微縮短延遲

      // 請求用戶位置
      requestUserLocation();

      console.log('✅ 分店地圖系統初始化完成');
      // 成功完成後，隱藏載入遮罩
      hideLoadingOverlay();

    } catch (error) {
      console.error('❌ 初始化失敗:', error);
      document.getElementById('store-list').innerHTML = '<div class="error">系統初始化失敗，請重新整理頁面</div>';
      // 發生錯誤時，也要隱藏載入遮罩
      hideLoadingOverlay();
    }
  }

  // 載入分店數據 - 改用Google Apps Script API
  async function loadStoreData() {
    console.log('🔄 從Google Apps Script載入分店數據...');

    try {
      const response = await fetch(GAS_WEB_APP_URL + '?action=getStoreMapData');

      if (!response.ok) {
        throw new Error('網路請求失敗: ' + response.status);
      }

      const result = await response.json();

      if (result.success && result.data) {
        // --- 重要：這裡的資料映射邏輯需要符合 store-map.html 的需求 ---
        storeData = result.data.map(store => ({
          id: store['店鋪ID'],
          name: store['店鋪名稱'],
          address: store['地址'],
          phone: store['電話'],
          lat: parseFloat(store['緯度']),
          lng: parseFloat(store['經度']),
          businessHours: store['營業時間'],
          isOpen: store['isOpen'],
          specialOffers: store['促銷訊息'] ? [store['促銷訊息']] : [],
          hasPanda: !!store['熊貓外送網址'],
          hasUber: !!store['Uber外送網址'],
          onlineOrderUrl: store['線上點餐網址'] || '',
          pandaUrl: store['熊貓外送網址'] || '',
          uberUrl: store['Uber外送網址'] || '',
          status: store['status'] || (store['isOpen'] ? 'active' : 'closed')
        }));
        
        console.log('✅ 成功載入', storeData.length, '個分店');
      } else {
        throw new Error(result.error || '無法獲取分店資料');
      }

    } catch (error) {
      console.error('❌ 載入分店數據失敗:', error);
      // 發生錯誤時，可以顯示錯誤訊息或使用備用資料
      storeData = []; // 清空資料以避免顯示舊的或錯誤的內容
      document.getElementById('store-list').innerHTML = '<div class="error">無法載入分店資料，請稍後再試。</div>';
    }
  }



    // 初始化地圖
    function initializeMap() {
      try {
        // 創建地圖，中心點設在桃園，縮放級別調低以顯示更大範圍
        map = L.map('map').setView([24.9500, 121.2200], 10);

        // 添加地圖圖層
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        console.log('✅ 地圖初始化完成');

        // 如果有分店數據，調整地圖視野以包含所有分店
        if (storeData && storeData.length > 0) {
          setTimeout(() => {
            fitMapToStores();
          }, 1000);
        }

      } catch (error) {
        console.error('❌ 地圖初始化失敗:', error);
        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">地圖載入失敗</div>';
      }
    }

    // 調整地圖視野以包含所有分店
    function fitMapToStores() {
  if (!map || !storeData || storeData.length === 0) return;

  try {
    const bounds = L.latLngBounds();

    // 加入所有分店
    storeData.forEach(store => {
      bounds.extend([store.lat, store.lng]);
    });

    // 加入目前位置（若有）
    if (userLocation) {
      bounds.extend([userLocation.lat, userLocation.lng]);
    }

    map.fitBounds(bounds, { padding: [20, 20] });
    console.log('✅ 地圖視野已調整包含分店與用戶位置');
  } catch (error) {
    console.error('❌ 調整地圖視野失敗:', error);
  }
}


    // 添加分店標記到地圖
    function addStoreMarkersToMap() {
      if (!map || !storeData.length) return;

      try {
        console.log('🗺️ 開始添加雞排圖示標記...');

        // 清除現有標記
        if (window.storeMarkers) {
          window.storeMarkers.forEach(marker => {
            map.removeLayer(marker);
          });
        }
        window.storeMarkers = [];

        // 使用emoji圖標作為主要方案（更穩定）
        storeData.forEach((store, index) => {
          // 確保座標是數字類型
          const lat = parseFloat(store.lat);
          const lng = parseFloat(store.lng);

          console.log(`📍 添加分店標記 ${index + 1}: ${store.name} at [${lat}, ${lng}]`);

          // 驗證座標有效性
          if (isNaN(lat) || isNaN(lng)) {
            console.error(`❌ 無效座標: ${store.name} - lat: ${store.lat}, lng: ${store.lng}`);
            return;
          }

          // 檢查營業狀態 - 解析營業時間 JSON 字串
          let businessHours = {};
          try {
            businessHours = typeof store.businessHours === 'string'
              ? JSON.parse(store.businessHours)
              : (store.businessHours || {});
          } catch (e) {
            console.error(`❌ 解析營業時間失敗: ${store.name}`, e);
            businessHours = {};
          }
          const isStoreOpen = checkIfStoreIsOpen(store, businessHours);

const chickenIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/chatscai10/bjg8/refs/heads/main/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png',
  iconSize: [42, 64],
  iconAnchor: [21, 64], // 圖片下緣中間
  popupAnchor: [0, -64]
});

          const marker = L.marker([lat, lng], { icon: chickenIcon }).addTo(map);

          const popupContent = `
            <div style="text-align: center; font-family: 'SF Pro Display', sans-serif; min-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: #1f2937;">🍗 ${store.name}</h4>
              <p style="margin: 4px 0; color: #6b7280; font-size: 13px;"><strong>地址:</strong> ${store.address}</p>
              <p style="margin: 4px 0; color: #6b7280; font-size: 13px;"><strong>電話:</strong> <a href="tel:${store.phone}" style="color: #3b82f6;">${store.phone}</a></p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>狀態:</strong> <span style="color: ${isStoreOpen ? '#10b981' : '#f87171'}; font-weight: 600;">${isStoreOpen ? '🟢 營業中' : '🔴 休息中'}</span></p>
              ${store.specialOffers && store.specialOffers.length > 0 ? `
                <p style="margin: 4px 0; color: #f59e0b; font-weight: 600; font-size: 13px;">🎉 ${store.specialOffers.join(', ')}</p>
              ` : ''}
              <div style="margin-top: 8px;">
                <button onclick="openGoogleMaps(${lat}, ${lng}, '${store.name}')"
                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer;">
                  🗺️ 導航
                </button>
                <button onclick="callStore('${store.phone}')"
                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer;">
                  📞 撥打
                </button>
              </div>
            </div>
          `;

          marker.bindPopup(popupContent);
          window.storeMarkers.push(marker);
        });

        console.log(`✅ 已添加 ${window.storeMarkers.length} 個雞排emoji標記`);

        // 調整地圖視野以包含所有標記
        fitMapToStores();

      } catch (error) {
        console.error('❌ 添加分店標記失敗:', error);
      }
    }

    // 渲染店家列表
    function renderStoreList() {
      const storeList = document.getElementById('store-list');
      storeList.innerHTML = '';

      storeData.forEach(store => {
        const storeElement = createStoreCard(store);
        storeList.appendChild(storeElement);
      });

      console.log(`✅ 渲染 ${storeData.length} 個店家卡片`);
    }

// 創建店家卡片 - 使用範本地圖的進階效果
function createStoreCard(store) {
  const storeItem = document.createElement('div');
  storeItem.className = 'store-item';
  storeItem.setAttribute('data-store-id', store.id);

  // --- 新結構：卡片預設是收合的 ---
  // 卡片點擊時會切換 'expanded' class
  storeItem.addEventListener('click', (e) => {
    // 阻止點擊按鈕或連結時觸發收合
    if (e.target.closest('a, button')) {
      return;
    }
    // 對於休息中的店家，點擊事件由 addClosedStoreClickEffect 統一處理
    if (storeItem.classList.contains('store-closed')) {
      return;
    }
    storeItem.classList.toggle('expanded');
  });

  const storeCard = document.createElement('div');
  storeCard.className = 'store-card';

  const storeFront = document.createElement('div');
  storeFront.className = 'store-front';
  
  // --- 新結構：將標題和地址分開 ---
  const storeHeader = document.createElement('div');
  storeHeader.className = 'store-front-header';
  storeHeader.innerHTML = `
    <h3>${store.name}</h3>
    <span class="expand-arrow">▼</span>
  `;
  
  const storeAddress = document.createElement('div');
  storeAddress.className = 'store-address';
  storeAddress.textContent = store.address;

  storeFront.appendChild(storeHeader);
  storeFront.appendChild(storeAddress);

  // --- 新結構：建立一個可收合的內容容器 ---
  const collapsibleContent = document.createElement('div');
  collapsibleContent.className = 'store-collapsible-content';

  // 基本資訊
  const basicInfo = document.createElement('div');
  basicInfo.className = 'basic-info';
  
  let businessHours = {};
  try {
    businessHours = typeof store.businessHours === 'string' ? JSON.parse(store.businessHours) : (store.businessHours || {});
  } catch (e) {
    console.error(`❌ 解析營業時間失敗: ${store.name}`, e);
    businessHours = {};
  }
  
  let hoursDisplay = '';
  if (Object.keys(businessHours).length > 0) {
    const storeId = store.id;
    hoursDisplay = `
      <div class="business-hours-toggle" onclick="toggleBusinessHours('${storeId}')">
        <strong>🕒 營業時間</strong>
        <span class="toggle-icon">▼</span>
      </div>
      <div class="business-hours-details" id="hours-${storeId}">
    `;
    Object.entries(businessHours).forEach(([day, hours]) => {
      hoursDisplay += `<div class="day-hours"><span class="day-name">${day}</span><span class="day-time">${hours}</span></div>`;
    });
    hoursDisplay += '</div>';
  }

  // --- 新增：促銷訊息顯示 ---
  let promotionDisplay = '';
  if (store.specialOffers && store.specialOffers.length > 0 && store.specialOffers[0]) {
    promotionDisplay = `<p style="margin-top:8px;"><strong>🎉 促銷活動：</strong><span style="color: #fbbf24; font-weight: 600;">${store.specialOffers.join(', ')}</span></p>`;
  }

  basicInfo.innerHTML = `
    <div>
      <p><strong>電話：</strong><a href='tel:${store.phone.replace(/-/g, '')}'>${store.phone}</a></p>
      ${promotionDisplay}
      ${hoursDisplay}
    </div>
  `;
  collapsibleContent.appendChild(basicInfo);

  // 營業狀態
  const isOpen = checkIfStoreIsOpen(store, businessHours);
  const statusInfo = document.createElement('div');
  statusInfo.className = 'status-info';
  statusInfo.innerHTML = `
    <strong>狀態：</strong>
    <span class="${isOpen ? 'open-status' : 'closed-status'}">${isOpen ? '營業中' : '休息中'}</span>
  `;
  collapsibleContent.appendChild(statusInfo);

  // 按鈕群組
  const btnGroup = document.createElement('div');
  btnGroup.className = 'btn-group';
  
  // 按鈕內容 (與舊版相同，直接複製貼上)
  btnGroup.innerHTML = `
    <button onclick="openOnlineOrder('${store.onlineOrderUrl}')" ${!store.onlineOrderUrl ? 'disabled' : ''}>🍗 線上點餐</button>
    <button onclick="openGoogleMaps(${store.lat}, ${store.lng}, '${store.name}')">🗺️ 導航</button>
    <button onclick="callStore('${store.phone}')">📞 撥打</button>
    <button onclick="openPandaOrder('${store.pandaUrl}')" ${!store.pandaUrl ? 'disabled' : ''}>🐼 熊貓</button>
    <button onclick="openUberOrder('${store.uberUrl}')" ${!store.uberUrl ? 'disabled' : ''}>🚗 Uber</button>
  `;

  // 處理禁用按鈕的疊加提示
  btnGroup.querySelectorAll('button[disabled]').forEach(btn => {
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      btn.style.position = 'relative';
      const overlay = document.createElement('div');
      overlay.style.cssText = `position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0,0,0,0.6);color: white;font-size: 10px;display: flex;align-items: center;justify-content: center;border-radius: inherit;`;
      overlay.textContent = '暫無服務';
      btn.appendChild(overlay);
  });
  
  collapsibleContent.appendChild(btnGroup);

  // 將可收合容器加入到卡片正面
  storeFront.appendChild(collapsibleContent);

  // 休息中店家遮罩效果
  if (!isOpen) {
    storeItem.classList.add('store-closed');
    const maskContent = document.createElement('div');
    maskContent.className = 'closed-mask-content';
    const nextOpenTime = getNextOpenTime(store.businessHours);
    maskContent.innerHTML = `
      <div class="closed-icon">😴</div>
      <div class="closed-store-name">${store.name}</div>
      <div class="closed-status">休息中</div>
      <div style="color: #60a5fa; font-size: 13px; margin-top: 4px;">下次營業：${nextOpenTime}</div>
    `;
    storeItem.appendChild(maskContent);
    addClosedStoreClickEffect(storeItem);
  }

  storeCard.appendChild(storeFront);
  storeItem.appendChild(storeCard);

  // 判斷是否營業中，並添加火焰特效 class
  if (isOpen) {
    storeCard.classList.add('flame-border');
  }

  return storeItem;
}

    // 請求用戶位置
    async function requestUserLocation() {
      if (isLocationRequested) return;

      try {
        isLocationRequested = true;

        // 檢查是否有緩存的位置
        const cachedLocation = localStorage.getItem('userLocation');
        if (cachedLocation) {
          userLocation = JSON.parse(cachedLocation);
          updateMapWithUserLocation();
          return;
        }

        // 請求新的位置
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              // 緩存位置
              localStorage.setItem('userLocation', JSON.stringify(userLocation));

              updateMapWithUserLocation();
              console.log('✅ 用戶位置獲取成功');
            },
            (error) => {
              console.warn('⚠️ 無法獲取用戶位置:', error);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000 // 5分鐘緩存
            }
          );
        }
      } catch (error) {
        console.error('❌ 位置請求失敗:', error);
      }
    }

    // 更新地圖顯示用戶位置
    function updateMapWithUserLocation() {
      if (!map || !userLocation) return;

      try {
        // 添加用戶位置標記
const userIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/chatscai10/bjg8/refs/heads/main/line/754e3924-3cc8-46a9-b512-48aaf012d1dd.png',
  iconSize: [42, 64],
  iconAnchor: [21, 64], // 同樣圖片下緣中間
  popupAnchor: [0, -64]
});


        L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
          .addTo(map)
          .bindPopup('期待的您')
          .openPopup();

        // 調整地圖視野包含用戶位置和所有分店
        const allPoints = [
          [userLocation.lat, userLocation.lng],
          ...storeData.map(store => [store.lat, store.lng])
        ];

        const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
        map.fitBounds(group.getBounds().pad(0.1));

        console.log('✅ 地圖已更新用戶位置');
      } catch (error) {
        console.error('❌ 更新用戶位置失敗:', error);
      }
    }

    // 開啟Google地圖導航
    function openGoogleMaps(lat, lng, storeName) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(storeName)}`;
      openExternalOrHref(url);
    }

    // 撥打電話
    function callStore(phone) {
      window.location.href = `tel:${phone}`;
    }

    // 開啟線上點餐
    function openOnlineOrder(onlineOrderUrl) {
      if (onlineOrderUrl) {
        openExternalOrHref(onlineOrderUrl);
      } else {
        console.log('⚠️ 此分店暫無線上點餐服務');
      }
    }

    // 開啟熊貓外送
    function openPandaOrder(pandaUrl) {
      if (pandaUrl) {
        openExternalOrHref(pandaUrl);
      } else {
        console.log('⚠️ 此分店暫無熊貓外送服務');
      }
    }

    // 開啟Uber外送
    function openUberOrder(uberUrl) {
      if (uberUrl) {
        openExternalOrHref(uberUrl);
      } else {
        console.log('⚠️ 此分店暫無Uber外送服務');
      }
    }

function addClosedStoreClickEffect(storeElement) {
  storeElement.addEventListener('click', function (e) {
    // 如果點擊的是按鈕或連結，就略過
    if (e.target.closest('a, button')) {
      return;
    }

    // 切換遮罩透明度
    storeElement.classList.toggle('clicked-transparent');
    
    // 同時切換卡片展開狀態
    storeElement.classList.toggle('expanded');
    
    console.log(`  點擊休息中店家 ${storeElement.dataset.storeId} → 切換顯示狀態`);
  });
}


    // 手動請求定位
    function manualRequestLocation() {
      const btn = document.getElementById('locate-btn');

      // 重置狀態
      isLocationRequested = false;
      userLocation = null;

      // 更新按鈕狀態
      btn.innerHTML = '🔄 定位中...';
      btn.disabled = true;

      // 清除緩存
      localStorage.removeItem('userLocation');

      // 重新請求位置
      requestUserLocation().finally(() => {
        btn.innerHTML = '📍 重新定位';
        btn.disabled = false;
      });
    }

    // 外部連結開啟
    function openExternalOrHref(finalUrl) {
      if (typeof liff !== "undefined" && liff.isInClient()) {
        liff.openWindow({
          url: finalUrl,
          external: true
        });
      } else {
        window.open(finalUrl, "_blank");
      }
    }

    // 開啟LINE加好友
    function openLineAddFriend() {
      const lineAddFriendUrl = 'https://line.me/R/ti/p/@fried'; // 請替換為實際的LINE ID
      console.log('🐔 點擊懸浮雞排，開啟LINE加好友');
      openExternalOrHref(lineAddFriendUrl);
    }

    // 檢查分店是否營業中
    function checkIfStoreIsOpen(store, businessHours) {
      // 如果分店設定為關閉，直接返回false
      if (store.isOpen === false) {
        console.log(`❌ ${store.name} 分店設定為關閉 (store.isOpen = false)`);
        return false;
      }

      // 使用測試時間或實際時間
      const now = testTime || new Date();
      const currentDay = now.getDay(); // 0=週日, 1=週一, ..., 6=週六
      const currentTime = now.getHours() * 100 + now.getMinutes(); // 例如: 14:30 = 1430

      // 將數字轉換為中文星期
      const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
      const todayName = dayNames[currentDay];

      // 獲取今天的營業時間
      const todayHours = businessHours[todayName];

      console.log(`🕒 營業時間檢查 - 分店: ${store.name}`);
      console.log(`   📅 今天: ${todayName} (${currentDay})`);
      console.log(`   ⏰ 當前時間: ${Math.floor(currentTime/100)}:${String(currentTime%100).padStart(2,'0')} (${currentTime})`);
      console.log(`   🏪 營業時間: ${todayHours}`);
      console.log(`   📋 完整營業時間:`, businessHours);

      if (!todayHours || todayHours === '休息' || todayHours === '公休') {
        console.log(`❌ ${store.name} 今天休息或無營業時間設定`);
        return false;
      }





      // 解析營業時間 - 支援多時段格式 (例如: "11:00-21:00" 或 "00:00-01:00,15:00-24:00")
      const timeSegments = todayHours.split(',').map(segment => segment.trim());
      console.log(`📊 ${store.name} 時間段解析: ${timeSegments.join(' + ')}`);

      let isOpen = false;

      for (const segment of timeSegments) {
        const timeMatch = segment.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
        if (!timeMatch) {
          console.log(`⚠️ ${store.name} 無法解析時間段格式: ${segment}`);
          continue;
        }

        const openTime = parseInt(timeMatch[1]) * 100 + parseInt(timeMatch[2]);
        const closeTime = parseInt(timeMatch[3]) * 100 + parseInt(timeMatch[4]);

        console.log(`   📊 時間段: ${segment}`);
        console.log(`   🔓 開店時間: ${openTime} (${Math.floor(openTime/100)}:${String(openTime%100).padStart(2,'0')})`);
        console.log(`   🔒 關店時間: ${closeTime} (${Math.floor(closeTime/100)}:${String(closeTime%100).padStart(2,'0')})`);
        console.log(`   ⏰ 當前時間: ${currentTime} (${Math.floor(currentTime/100)}:${String(currentTime%100).padStart(2,'0')})`);

        // 檢查當前時間是否在這個時間段內
        let segmentOpen;
        if (closeTime > openTime) {
          // 正常情況：不跨日 (例如: 11:00-21:00)
          segmentOpen = currentTime >= openTime && currentTime < closeTime;
          console.log(`   📋 判斷邏輯: ${currentTime} >= ${openTime} && ${currentTime} < ${closeTime} = ${segmentOpen}`);
        } else {
          // 跨日情況：(例如: 22:00-02:00)
          segmentOpen = currentTime >= openTime || currentTime < closeTime;
          console.log(`   📋 跨日判斷邏輯: ${currentTime} >= ${openTime} || ${currentTime} < ${closeTime} = ${segmentOpen}`);
        }

        if (segmentOpen) {
          isOpen = true;
          console.log(`   ✅ 在時間段 ${segment} 內營業中`);
          break; // 只要有一個時間段營業中就可以了
        } else {
          console.log(`   ❌ 不在時間段 ${segment} 內`);
        }
      }

      console.log(`${isOpen ? '✅' : '❌'} ${store.name} 最終結果: ${isOpen ? '營業中' : '休息中'}`);
      return isOpen;
    }


function getNextOpenTime(businessHours) {
  const now = testTime || new Date(); // 使用測試時間或實際時間
  const currentDay = now.getDay();
  const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];

  for (let i = 1; i <= 7; i++) {
    const nextDayIndex = (currentDay + i) % 7;
    const nextDayName = dayNames[nextDayIndex];
    const hours = businessHours[nextDayName];

    if (hours && hours !== '休息') {
      return (i === 1 ? '明天' : nextDayName) + ' ' + hours.split('-')[0] + ' 開始營業';
    }
  }

  return '尚未設定營業時間';
}


    // 營業時間展開/收起功能
    function toggleBusinessHours(storeId) {
      console.log(`🕒 切換營業時間顯示: ${storeId}`);

      const toggle = document.querySelector(`[onclick="toggleBusinessHours('${storeId}')"]`);
      const details = document.getElementById(`hours-${storeId}`);

      if (toggle && details) {
        const isExpanded = details.classList.contains('expanded');

        if (isExpanded) {
          // 收起
          details.classList.remove('expanded');
          toggle.classList.remove('expanded');
          console.log(`📁 ${storeId} 營業時間已收起`);
        } else {
          // 展開
          details.classList.add('expanded');
          toggle.classList.add('expanded');
          console.log(`📂 ${storeId} 營業時間已展開`);
        }
      }
    }

    // 啟動應用
    document.addEventListener('DOMContentLoaded', init);

    // 控制台提示
    console.log('🚀 不早脆皮雞排-分店地圖已載入！');
  </script>
</body>
</html>
