<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸æ—©è„†çš®é›æ’ - åˆ†åº—åœ°åœ–</title>

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://unpkg.com https://chatscai10.github.io https://static.line-scdn.net; object-src 'none';">

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
/* --- å…¨å±€èˆ‡åŸºæœ¬è¨­å®š --- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
  min-height: 100vh;
  color: #e1e5e9;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:
    radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
  z-index: -1;
}

.main-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 0;
  position: relative;
  z-index: 1;
  min-height: 100vh;
}

/* --- å…¨è¢å¹•è¼‰å…¥é®ç½© --- */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease-out, visibility 0.6s;
  opacity: 1;
  visibility: visible;
}

#loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-content { text-align: center; }
.loading-logo {
  width: 120px;
  height: auto;
  margin-bottom: 24px;
  animation: pulse-glow 2.5s infinite ease-in-out;
}
.loading-text {
  color: #e1e5e9;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 1px;
}
.loading-subtext {
  color: #94a3b8;
  font-size: 14px;
  margin-top: 8px;
}
.loading-dots { display: inline-block; }
.loading-dots::after {
  content: '.';
  animation: loadingDots 1.4s steps(4, end) infinite;
}

/* --- é é¢å…ƒä»¶ --- */
#announcement {
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  color: #94a3b8;
  padding: 16px 20px;
  text-align: center;
  font-weight: 500;
  font-size: 14px;
  position: relative;
}

#map {
  height: 300px;
  margin: 20px;
  border-radius: 12px;
  border: 1px solid rgba(59, 130, 246, 0.15);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  position: relative;
  background: rgba(15, 20, 25, 0.5);
}

#store-list { padding: 20px; }

/* --- åº—å®¶å¡ç‰‡åŸºç¤çµæ§‹ --- */
.store-item {
  margin-bottom: 24px;
  position: relative;
}
.store-card {
  width: 100%;
  border-radius: 16px;
  overflow: visible; /* ç‚ºäº†è®“ç«ç„°ç‰¹æ•ˆèƒ½æº¢å‡º */
  position: relative;
}
.store-front {
  width: 100%;
  border-radius: 16px;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(20px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(59, 130, 246, 0.1);
  position: relative;
  z-index: 2;
  overflow: hidden;
}

/* --- å¡ç‰‡æ”¶åˆ/å±•é–‹æ•ˆæœ --- */
.store-front-header {
  padding: 16px 20px;
  cursor: pointer;
  position: relative;
  transition: background-color 0.3s ease;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.08) 100%);
  border-bottom: 1px solid rgba(59, 130, 246, 0.15);
}
.store-front-header:hover { background-color: rgba(59, 130, 246, 0.05); }
.store-front-header h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  color: #ffffff;
}
.expand-arrow {
  position: absolute;
  top: 50%;
  right: 20px;
  transform: translateY(-50%) rotate(0deg);
  transition: transform 0.4s ease;
  font-size: 16px;
  color: #60a5fa;
}
.store-item.expanded .expand-arrow { transform: translateY(-50%) rotate(180deg); }
.store-address {
  font-size: 14px;
  color: #94a3b8;
  padding: 12px 20px 16px;
  cursor: pointer;
  border-bottom: 1px solid rgba(59, 130, 246, 0.05);
}
.store-collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.store-item.expanded .store-collapsible-content { max-height: 500px; }
.basic-info {
  padding: 20px;
  color: #e0e0e0;
  font-size: 14px;
  line-height: 1.6;
}
.basic-info strong {
  color: #60a5fa;
  font-weight: 600;
}
.basic-info a {
  color: #10b981;
  text-decoration: none;
  transition: all 0.3s ease;
}
.basic-info a:hover {
  color: #34d399;
  text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
}
.status-info {
  padding: 12px 20px;
  background: rgba(0, 0, 0, 0.2);
  border-top: 1px solid rgba(59, 130, 246, 0.1);
}
.open-status {
  color: #34d399;
  font-weight: 600;
  text-shadow: 0 0 8px rgba(52, 211, 153, 0.4);
}
.closed-status {
  color: #f87171;
  font-weight: 600;
  text-shadow: 0 0 8px rgba(248, 113, 113, 0.4);
}

/* --- å¡ç‰‡æŒ‰éˆ• --- */
.btn-group {
  padding: 20px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.btn-group button {
  flex: 1;
  min-width: 100px;
  padding: 12px 16px;
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(59, 130, 246, 0.1);
  color: #60a5fa;
  font-size: 14px;
  position: relative;
  overflow: hidden;
}
.btn-group button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
  border-color: #60a5fa;
  color: #ffffff;
  background: rgba(59, 130, 246, 0.2);
}

/* --- ä¼‘æ¯ä¸­åº—å®¶é®ç½© --- */
.store-item.store-closed { cursor: pointer; }
.closed-mask-content {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 12;
  border-radius: 16px;
  backdrop-filter: blur(3px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  text-align: center;
  padding: 10px;
}
.closed-icon { font-size: 24px; margin-bottom: 8px; }
.closed-store-name {
  color: #ffffff;
  font-size: 16px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
  margin-bottom: 4px;
}
.closed-status {
  color: #ff6b6b;
  font-size: 14px;
  font-weight: 600;
}
.store-item.store-closed.clicked-transparent .closed-mask-content {
  background: rgba(0, 0, 0, 0.25) !important;
  backdrop-filter: blur(0.5px) !important;
}

/* --- ç‡Ÿæ¥­ä¸­ç«ç„°ç‰¹æ•ˆ --- */
.store-card.flame-border::before {
  content: '';
  position: absolute;
  top: -8px; left: -8px; right: -8px; bottom: -8px;
  z-index: 1;
  background: linear-gradient(45deg, #ffdd00, #ff8800, #ff4400);
  border-radius: 20px;
  filter: url(#flame-filter);
  animation: flameAnimation 2.2s infinite alternate;
  pointer-events: none;
}
.store-card.flame-border::after {
  content: '';
  position: absolute;
  top: -12px; left: -12px; right: -12px; bottom: -12px;
  z-index: 0;
  background: linear-gradient(60deg, #ffea00, #ff9800, #ff5722);
  border-radius: 24px;
  filter: url(#flame-filter);
  opacity: 0.5;
  animation: flameAnimation 3.1s infinite alternate-reverse;
  pointer-events: none;
}

/* --- ç‡Ÿæ¥­æ™‚é–“å±•é–‹ --- */
.business-hours-toggle {
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  transition: background-color 0.3s ease;
}
.business-hours-toggle:hover { background: rgba(59, 130, 246, 0.05); }
.business-hours-toggle .toggle-icon {
  font-size: 12px;
  color: #60a5fa;
  transition: transform 0.3s ease;
}
.business-hours-toggle.expanded .toggle-icon { transform: rotate(180deg); }
.business-hours-details {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  background: rgba(59, 130, 246, 0.02);
  border-radius: 8px;
  margin-top: 8px;
}
.business-hours-details.expanded {
  max-height: 250px;
  padding: 12px;
}
.day-hours {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
  font-size: 13px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.05);
}
.day-hours:last-child { border-bottom: none; }
.day-name { color: #94a3b8; }
.day-time { color: #60a5fa; font-weight: 600; }

/* --- æ‡¸æµ®é›æ’ --- */
.tech-floating-chicken {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 1000;
  cursor: pointer;
}
.chicken-container {
  position: relative;
  width: 130px;
  height: 130px;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: floatEnhanced 2.5s ease-in-out infinite;
}
.chicken-img {
  width: 150px;
  height: 150px;
  object-fit: contain;
  border-radius: 0;
  transition: all 0.3s ease;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}
.chicken-container:hover .chicken-img {
  transform: scale(1.1) rotate(5deg);
  filter: drop-shadow(0 6px 12px rgba(255, 215, 0, 0.5));
}
.chicken-tooltip {
  position: absolute;
  top: -40px;
  right: 0;
  left: 0;
  margin: auto;
  width: max-content;
  padding: 6px 10px;
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  font-size: 13px;
  border-radius: 8px;
  white-space: nowrap;
  opacity: 0;
  transform: translateY(10px);
  pointer-events: none;
  transition: all 0.3s ease;
  text-align: center;
  z-index: 1001;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.tech-floating-chicken:hover .chicken-tooltip {
  opacity: 1;
  transform: translateY(0);
}

/* é‡‘å…‰é–ƒçˆæ•ˆæœ - ç¸®å°ç‰ˆ */
.golden-glow {
  position: absolute;
  top: 5px;
  left: 5px;
  right: 5px;
  bottom: 5px;
  border-radius: 20%;
  background: conic-gradient(
    from 0deg,
    #ffd700 0deg,
    #ffed4e 60deg,
    #fff59d 120deg,
    #ffd700 180deg,
    #ffb300 240deg,
    #ffd700 300deg,
    #fff176 360deg
  );
  animation: goldenRotate 5s linear infinite;
  opacity: 0.8;
  z-index: -1;
}

.golden-glow::before {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  right: 3px;
  bottom: 3px;
  background: rgba(15, 20, 25, 0.9);
  border-radius: 50%;
  z-index: 1;
}

@keyframes goldenRotate {
  0% {
    transform: rotate(0deg);
    opacity: 0.6;
  }
  50% {
    opacity: 1;
  }
  100% {
    transform: rotate(360deg);
    opacity: 0.6;
  }
}

/* --- åœ°åœ–æ¨™è¨˜ --- */
.user-location-marker {
  font-size: 24px;
  text-align: center;
  animation: userLocationPulse 2s infinite;
}

/* --- å‹•ç•«é›†åˆ --- */
@keyframes loadingDots {
  0% { content: "."; }
  33% { content: ".."; }
  66% { content: "..."; }
  100% { content: "."; }
}
@keyframes pulse-glow {
  0% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3)); }
  50% { transform: scale(1.05); filter: drop-shadow(0 0 16px rgba(255, 215, 0, 0.6)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3)); }
}
@keyframes flameAnimation {
  0%, 100% { transform: scale(1); opacity: 0.9; }
  50% { transform: scale(1.05); opacity: 1; }
}
@keyframes floatEnhanced {
  0% {
    transform: translate(0, 0) rotate(0deg);
  }
  25% {
    transform: translate(-5px, -4px) rotate(-4deg);
  }
  50% {
    transform: translate(0px, 6px) rotate(0deg);
  }
  75% {
    transform: translate(5px, -4px) rotate(4deg);
  }
  100% {
    transform: translate(0, 0) rotate(0deg);
  }
}
@keyframes userLocationPulse {
  0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(52, 211, 153, 0.7)); }
  50% { transform: scale(1.1); filter: drop-shadow(0 0 12px rgba(52, 211, 153, 1)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(52, 211, 153, 0.7)); }
}

/* --- æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ --- */
@media (max-width: 480px) {
  #map { margin: 0; border-radius: 0; height: 250px; }
  #locate-btn { margin-top: 10px !important; }

  .tech-floating-chicken {
    width: 80px;
    height: 80px;
    right: 15px;
    top: auto;
    bottom: 20px;
    transform: none;
  }

  .chicken-container {
    width: 80px;
    height: 80px;
  }

  .chicken-img {
    width: 60px;
    height: 60px;
  }
}

.store-card.flame-border::before {
  content: '';
  position: absolute;
  top: -8px; left: -8px; right: -8px; bottom: -8px;
  z-index: -1;
  background: linear-gradient(45deg, #ffdd00, #ff8800, #ff4400);
  border-radius: 20px;
  filter: url(#flame-filter);
  animation: flameAnimation 2.2s infinite alternate;
  pointer-events: none;
}

/* ç–ŠåŠ ä¸€å±¤ä¸åŒå»¶é²çš„ç«ç„°å‹•ç•«ï¼Œè®“é–ƒçˆæ›´ä¸è¦å‰‡ */
.store-card.flame-border::after {
  content: '';
  position: absolute;
  top: -12px; left: -12px; right: -12px; bottom: -12px;
  z-index: -2;
  background: linear-gradient(60deg, #ffea00, #ff9800, #ff5722);
  border-radius: 24px;
  filter: url(#flame-filter);
  opacity: 0.5;
  animation: flameAnimation 3.1s infinite alternate-reverse;
  pointer-events: none;
}

/* å±•é–‹ç®­é ­åœ–ç¤º */
.expand-arrow {
  position: absolute;
  top: 50%;
  right: 20px;
  transform: translateY(-50%) rotate(0deg);
  transition: transform 0.4s ease;
  font-size: 16px;
  color: #60a5fa;
}

.store-item.expanded .expand-arrow {
  transform: translateY(-50%) rotate(180deg);
}

/* ä¿®æ­£ä¼‘æ¯ä¸­é®ç½©çš„ z-indexï¼Œç¢ºä¿å®ƒåœ¨æ‰€æœ‰å…§å®¹ä¹‹ä¸Š */
.closed-mask-content {
  z-index: 12; /* æ¯”æŒ‰éˆ•(15)ä½ï¼Œæ¯”å…§å®¹(5)é«˜ */
}
.store-item.store-closed .btn-group {
  z-index: 15;
}

/* å…¨è¢å¹•è¼‰å…¥é®ç½© */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 20, 25, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease-out, visibility 0.6s;
  opacity: 1;
  visibility: visible;
}

#loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-content {
  text-align: center;
}

.loading-logo {
  width: 120px;
  height: auto;
  margin-bottom: 24px;
  animation: pulse-glow 2.5s infinite ease-in-out;
}

.loading-text {
  color: #e1e5e9;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 1px;
}

.loading-subtext {
  color: #94a3b8;
  font-size: 14px;
  margin-top: 8px;
}

/* è¼‰å…¥ä¸­çš„ ... å‹•ç•« */
.loading-dots {
  display: inline-block;
}
.loading-dots::after {
  content: '';
  display: inline-block;
  width: 1.2em;
  text-align: left;
  animation: loadingDots 1.2s steps(3, end) infinite;
}
@keyframes loadingDots {
  0% { content: ''; }
  33% { content: '.'; }
  66% { content: '..'; }
  100% { content: '...'; }
}

@keyframes pulse-glow {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
  }
  50% {
    transform: scale(1.05);
    filter: drop-shadow(0 0 16px rgba(255, 215, 0, 0.6));
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
  }
}
</style>
</head>
<body class="dynamic-colors">
<div id="loading-overlay">
  <div class="loading-content">
    <img src="https://chatscai10.github.io/bjg8/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png" alt="Loading Logo" class="loading-logo">
    <div class="loading-text">
      è³‡æ–™è¼‰å…¥ä¸­<span class="loading-dots"></span>
    </div>
    <div class="loading-subtext">æ­£åœ¨ç‚ºæ‚¨æº–å‚™æœ€æ–°é®®çš„é›æ’è³‡è¨Š</div>
  </div>
</div>
<svg style="position:absolute; width:0; height:0; overflow:hidden;">
  <filter id="flame-filter">
    <feTurbulence type="fractalNoise" baseFrequency="0.02 0.05" numOctaves="2" seed="2" result="turbulence">
      <animate attributeName="seed" from="2" to="10" dur="2s" repeatCount="indefinite" />
    </feTurbulence>
    <feDisplacementMap in2="turbulence" in="SourceGraphic" scale="15" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg>
  <!-- æ‡¸æµ®é›æ’è£é£¾ -->
  <div class="tech-floating-chicken" id="floating-chicken" onclick="openLineAddFriend()" title="é»æ“ŠåŠ LINEå¥½å‹">
    <div class="chicken-container">
      <div class="golden-glow"></div>
      <img src="https://chatscai10.github.io/bjg8/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png"
           alt="ä¸æ—©è„†çš®é›æ’" class="chicken-img">
    </div>
<div class="chicken-tooltip">å¿«ä¾†å’¬æˆ‘</div>

  </div>

  <div class="main-container">
    <!-- é ‚éƒ¨å…¬å‘Šå€ -->
    <div id="announcement">
      ğŸ— æ­¡è¿ä¾†åˆ°ä¸æ—©è„†çš®é›æ’é»é¤åœ°åœ– | é»æ“Šåº—å®¶æŸ¥çœ‹è©³ç´°è³‡è¨Š
      <div id="test-time-indicator" style="display: none; margin-top: 8px; padding: 8px; background: rgba(255, 193, 7, 0.2); border-radius: 6px; font-size: 13px;">
        <i class="fas fa-clock me-1"></i>
        <strong>æ¸¬è©¦æ¨¡å¼ï¼š</strong><span id="test-time-display"></span>
      </div>
    </div>

    <!-- åœ°åœ–å®¹å™¨ -->
    <div id="map"></div>

    <!-- å®šä½æŒ‰éˆ• -->
    <div style="text-align: center; margin: 20px;">
      <button id="locate-btn" onclick="manualRequestLocation()" 
              style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px 24px; border-radius: 8px; cursor: pointer;">
        ğŸ“ é‡æ–°å®šä½
      </button>
    </div>

    <!-- åº—å®¶åˆ—è¡¨ -->
    <div id="store-list">
      <!-- åº—å®¶å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  


  <!-- Firebase SDK -->




  <script>
  // å…¨åŸŸè®Šæ•¸
  let map;
  let userLocation = null;
  let isLocationRequested = false;
  let storeData = [];
  let testTime = null; // æ¸¬è©¦æ™‚é–“

  // Google Apps Script Web App URL
  const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZ1EWtf0SBF7nJiJVsoTWyHkGp5hU1n8f14w69Xrs_0x0tiET-aG9m49_fp1eUx-mc/exec';
  // â›”ï¸ è«‹å†æ¬¡ç¢ºèªé€™ä¸²URLæ˜¯æ‚¨æ­£ç¢ºä¸”å¯å…¬é–‹å­˜å–çš„GAS Web Appéƒ¨ç½²ç¶²å€ã€‚
  
  console.log('ğŸ”§ Google Apps Script é…ç½®å·²è¼‰å…¥:', GAS_WEB_APP_URL);

  // éš±è—è¼‰å…¥é®ç½©
  function hideLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.add('hidden');
      console.log('âœ… è¼‰å…¥å®Œæˆï¼Œéš±è—é®ç½©');
    }
  }

  // åˆå§‹åŒ–æ‡‰ç”¨
  async function init() {
    console.log('ğŸš€ åˆå§‹åŒ–åˆ†åº—åœ°åœ–ç³»çµ±...');

    try {
      // è¼‰å…¥åˆ†åº—æ•¸æ“š
      await loadStoreData();

      // åˆå§‹åŒ–åœ°åœ–
      initializeMap();

      // æ¸²æŸ“åº—å®¶åˆ—è¡¨
      renderStoreList();

      // ç­‰å¾…åœ°åœ–å®Œå…¨è¼‰å…¥å¾Œå†æ·»åŠ æ¨™è¨˜
      setTimeout(() => {
        addStoreMarkersToMap();
      }, 500); // ç¨å¾®ç¸®çŸ­å»¶é²

      // è«‹æ±‚ç”¨æˆ¶ä½ç½®
      requestUserLocation();

      console.log('âœ… åˆ†åº—åœ°åœ–ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
      // æˆåŠŸå®Œæˆå¾Œï¼Œéš±è—è¼‰å…¥é®ç½©
      hideLoadingOverlay();

    } catch (error) {
      console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
      document.getElementById('store-list').innerHTML = '<div class="error">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
      // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä¹Ÿè¦éš±è—è¼‰å…¥é®ç½©
      hideLoadingOverlay();
    }
  }

  // è¼‰å…¥åˆ†åº—æ•¸æ“š - æ”¹ç”¨Google Apps Script API
  async function loadStoreData() {
    console.log('ğŸ”„ å¾Google Apps Scriptè¼‰å…¥åˆ†åº—æ•¸æ“š...');

    try {
      const response = await fetch(GAS_WEB_APP_URL + '?action=getStoreMapData');

      if (!response.ok) {
        throw new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—: ' + response.status);
      }

      const result = await response.json();

      if (result.success && result.data) {
        // --- é‡è¦ï¼šé€™è£¡çš„è³‡æ–™æ˜ å°„é‚è¼¯éœ€è¦ç¬¦åˆ store-map.html çš„éœ€æ±‚ ---
        storeData = result.data.map(store => ({
          id: store['åº—é‹ªID'],
          name: store['åº—é‹ªåç¨±'],
          address: store['åœ°å€'],
          phone: store['é›»è©±'],
          lat: parseFloat(store['ç·¯åº¦']),
          lng: parseFloat(store['ç¶“åº¦']),
          businessHours: store['ç‡Ÿæ¥­æ™‚é–“'],
          isOpen: store['isOpen'],
          specialOffers: store['ä¿ƒéŠ·è¨Šæ¯'] ? [store['ä¿ƒéŠ·è¨Šæ¯']] : [],
          hasPanda: !!store['ç†Šè²“å¤–é€ç¶²å€'],
          hasUber: !!store['Uberå¤–é€ç¶²å€'],
          onlineOrderUrl: store['ç·šä¸Šé»é¤ç¶²å€'] || '',
          pandaUrl: store['ç†Šè²“å¤–é€ç¶²å€'] || '',
          uberUrl: store['Uberå¤–é€ç¶²å€'] || '',
          status: store['status'] || (store['isOpen'] ? 'active' : 'closed')
        }));
        
        console.log('âœ… æˆåŠŸè¼‰å…¥', storeData.length, 'å€‹åˆ†åº—');
      } else {
        throw new Error(result.error || 'ç„¡æ³•ç²å–åˆ†åº—è³‡æ–™');
      }

    } catch (error) {
      console.error('âŒ è¼‰å…¥åˆ†åº—æ•¸æ“šå¤±æ•—:', error);
      // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå¯ä»¥é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯æˆ–ä½¿ç”¨å‚™ç”¨è³‡æ–™
      storeData = []; // æ¸…ç©ºè³‡æ–™ä»¥é¿å…é¡¯ç¤ºèˆŠçš„æˆ–éŒ¯èª¤çš„å…§å®¹
      document.getElementById('store-list').innerHTML = '<div class="error">ç„¡æ³•è¼‰å…¥åˆ†åº—è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
    }
  }



    // åˆå§‹åŒ–åœ°åœ–
    function initializeMap() {
      try {
        // å‰µå»ºåœ°åœ–ï¼Œä¸­å¿ƒé»è¨­åœ¨æ¡ƒåœ’ï¼Œç¸®æ”¾ç´šåˆ¥èª¿ä½ä»¥é¡¯ç¤ºæ›´å¤§ç¯„åœ
        map = L.map('map').setView([24.9500, 121.2200], 10);

        // æ·»åŠ åœ°åœ–åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        console.log('âœ… åœ°åœ–åˆå§‹åŒ–å®Œæˆ');

        // å¦‚æœæœ‰åˆ†åº—æ•¸æ“šï¼Œèª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰åˆ†åº—
        if (storeData && storeData.length > 0) {
          setTimeout(() => {
            fitMapToStores();
          }, 1000);
        }

      } catch (error) {
        console.error('âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">åœ°åœ–è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰åˆ†åº—
    function fitMapToStores() {
  if (!map || !storeData || storeData.length === 0) return;

  try {
    const bounds = L.latLngBounds();

    // åŠ å…¥æ‰€æœ‰åˆ†åº—
    storeData.forEach(store => {
      bounds.extend([store.lat, store.lng]);
    });

    // åŠ å…¥ç›®å‰ä½ç½®ï¼ˆè‹¥æœ‰ï¼‰
    if (userLocation) {
      bounds.extend([userLocation.lat, userLocation.lng]);
    }

    map.fitBounds(bounds, { padding: [20, 20] });
    console.log('âœ… åœ°åœ–è¦–é‡å·²èª¿æ•´åŒ…å«åˆ†åº—èˆ‡ç”¨æˆ¶ä½ç½®');
  } catch (error) {
    console.error('âŒ èª¿æ•´åœ°åœ–è¦–é‡å¤±æ•—:', error);
  }
}


    // æ·»åŠ åˆ†åº—æ¨™è¨˜åˆ°åœ°åœ–
    function addStoreMarkersToMap() {
      if (!map || !storeData.length) return;

      try {
        console.log('ğŸ—ºï¸ é–‹å§‹æ·»åŠ é›æ’åœ–ç¤ºæ¨™è¨˜...');

        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        if (window.storeMarkers) {
          window.storeMarkers.forEach(marker => {
            map.removeLayer(marker);
          });
        }
        window.storeMarkers = [];

        // ä½¿ç”¨emojiåœ–æ¨™ä½œç‚ºä¸»è¦æ–¹æ¡ˆï¼ˆæ›´ç©©å®šï¼‰
        storeData.forEach((store, index) => {
          // ç¢ºä¿åº§æ¨™æ˜¯æ•¸å­—é¡å‹
          const lat = parseFloat(store.lat);
          const lng = parseFloat(store.lng);

          console.log(`ğŸ“ æ·»åŠ åˆ†åº—æ¨™è¨˜ ${index + 1}: ${store.name} at [${lat}, ${lng}]`);

          // é©—è­‰åº§æ¨™æœ‰æ•ˆæ€§
          if (isNaN(lat) || isNaN(lng)) {
            console.error(`âŒ ç„¡æ•ˆåº§æ¨™: ${store.name} - lat: ${store.lat}, lng: ${store.lng}`);
            return;
          }

          // æª¢æŸ¥ç‡Ÿæ¥­ç‹€æ…‹ - è§£æç‡Ÿæ¥­æ™‚é–“ JSON å­—ä¸²
          let businessHours = {};
          try {
            businessHours = typeof store.businessHours === 'string'
              ? JSON.parse(store.businessHours)
              : (store.businessHours || {});
          } catch (e) {
            console.error(`âŒ è§£æç‡Ÿæ¥­æ™‚é–“å¤±æ•—: ${store.name}`, e);
            businessHours = {};
          }
          const isStoreOpen = checkIfStoreIsOpen(store, businessHours);

const chickenIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/chatscai10/bjg8/refs/heads/main/line/6d08c24e-8c45-4950-b4da-aae1c19e641c.png',
  iconSize: [42, 64],
  iconAnchor: [21, 64], // åœ–ç‰‡ä¸‹ç·£ä¸­é–“
  popupAnchor: [0, -64]
});

          const marker = L.marker([lat, lng], { icon: chickenIcon }).addTo(map);

          const popupContent = `
            <div style="text-align: center; font-family: 'SF Pro Display', sans-serif; min-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: #1f2937;">ğŸ— ${store.name}</h4>
              <p style="margin: 4px 0; color: #6b7280; font-size: 13px;"><strong>åœ°å€:</strong> ${store.address}</p>
              <p style="margin: 4px 0; color: #6b7280; font-size: 13px;"><strong>é›»è©±:</strong> <a href="tel:${store.phone}" style="color: #3b82f6;">${store.phone}</a></p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>ç‹€æ…‹:</strong> <span style="color: ${isStoreOpen ? '#10b981' : '#f87171'}; font-weight: 600;">${isStoreOpen ? 'ğŸŸ¢ ç‡Ÿæ¥­ä¸­' : 'ğŸ”´ ä¼‘æ¯ä¸­'}</span></p>
              ${store.specialOffers && store.specialOffers.length > 0 ? `
                <p style="margin: 4px 0; color: #f59e0b; font-weight: 600; font-size: 13px;">ğŸ‰ ${store.specialOffers.join(', ')}</p>
              ` : ''}
              <div style="margin-top: 8px;">
                <button onclick="openGoogleMaps(${lat}, ${lng}, '${store.name}')"
                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer;">
                  ğŸ—ºï¸ å°èˆª
                </button>
                <button onclick="callStore('${store.phone}')"
                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer;">
                  ğŸ“ æ’¥æ‰“
                </button>
              </div>
            </div>
          `;

          marker.bindPopup(popupContent);
          window.storeMarkers.push(marker);
        });

        console.log(`âœ… å·²æ·»åŠ  ${window.storeMarkers.length} å€‹é›æ’emojiæ¨™è¨˜`);

        // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
        fitMapToStores();

      } catch (error) {
        console.error('âŒ æ·»åŠ åˆ†åº—æ¨™è¨˜å¤±æ•—:', error);
      }
    }

    // æ¸²æŸ“åº—å®¶åˆ—è¡¨
    function renderStoreList() {
      const storeList = document.getElementById('store-list');
      storeList.innerHTML = '';

      storeData.forEach(store => {
        const storeElement = createStoreCard(store);
        storeList.appendChild(storeElement);
      });

      console.log(`âœ… æ¸²æŸ“ ${storeData.length} å€‹åº—å®¶å¡ç‰‡`);
    }

// å‰µå»ºåº—å®¶å¡ç‰‡ - ä½¿ç”¨ç¯„æœ¬åœ°åœ–çš„é€²éšæ•ˆæœ
function createStoreCard(store) {
  const storeItem = document.createElement('div');
  storeItem.className = 'store-item';
  storeItem.setAttribute('data-store-id', store.id);

  // --- æ–°çµæ§‹ï¼šå¡ç‰‡é è¨­æ˜¯æ”¶åˆçš„ ---
  // å¡ç‰‡é»æ“Šæ™‚æœƒåˆ‡æ› 'expanded' class
  storeItem.addEventListener('click', (e) => {
    // é˜»æ­¢é»æ“ŠæŒ‰éˆ•æˆ–é€£çµæ™‚è§¸ç™¼æ”¶åˆ
    if (e.target.closest('a, button')) {
      return;
    }
    // å°æ–¼ä¼‘æ¯ä¸­çš„åº—å®¶ï¼Œé»æ“Šäº‹ä»¶ç”± addClosedStoreClickEffect çµ±ä¸€è™•ç†
    if (storeItem.classList.contains('store-closed')) {
      return;
    }
    storeItem.classList.toggle('expanded');
  });

  const storeCard = document.createElement('div');
  storeCard.className = 'store-card';

  const storeFront = document.createElement('div');
  storeFront.className = 'store-front';
  
  // --- æ–°çµæ§‹ï¼šå°‡æ¨™é¡Œå’Œåœ°å€åˆ†é–‹ ---
  const storeHeader = document.createElement('div');
  storeHeader.className = 'store-front-header';
  storeHeader.innerHTML = `
    <h3>${store.name}</h3>
    <span class="expand-arrow">â–¼</span>
  `;
  
  const storeAddress = document.createElement('div');
  storeAddress.className = 'store-address';
  storeAddress.textContent = store.address;

  storeFront.appendChild(storeHeader);
  storeFront.appendChild(storeAddress);

  // --- æ–°çµæ§‹ï¼šå»ºç«‹ä¸€å€‹å¯æ”¶åˆçš„å…§å®¹å®¹å™¨ ---
  const collapsibleContent = document.createElement('div');
  collapsibleContent.className = 'store-collapsible-content';

  // åŸºæœ¬è³‡è¨Š
  const basicInfo = document.createElement('div');
  basicInfo.className = 'basic-info';
  
  let businessHours = {};
  try {
    businessHours = typeof store.businessHours === 'string' ? JSON.parse(store.businessHours) : (store.businessHours || {});
  } catch (e) {
    console.error(`âŒ è§£æç‡Ÿæ¥­æ™‚é–“å¤±æ•—: ${store.name}`, e);
    businessHours = {};
  }
  
  let hoursDisplay = '';
  if (Object.keys(businessHours).length > 0) {
    const storeId = store.id;
    hoursDisplay = `
      <div class="business-hours-toggle" onclick="toggleBusinessHours('${storeId}')">
        <strong>ğŸ•’ ç‡Ÿæ¥­æ™‚é–“</strong>
        <span class="toggle-icon">â–¼</span>
      </div>
      <div class="business-hours-details" id="hours-${storeId}">
    `;
    Object.entries(businessHours).forEach(([day, hours]) => {
      hoursDisplay += `<div class="day-hours"><span class="day-name">${day}</span><span class="day-time">${hours}</span></div>`;
    });
    hoursDisplay += '</div>';
  }

  // --- æ–°å¢ï¼šä¿ƒéŠ·è¨Šæ¯é¡¯ç¤º ---
  let promotionDisplay = '';
  if (store.specialOffers && store.specialOffers.length > 0 && store.specialOffers[0]) {
    promotionDisplay = `<p style="margin-top:8px;"><strong>ğŸ‰ ä¿ƒéŠ·æ´»å‹•ï¼š</strong><span style="color: #fbbf24; font-weight: 600;">${store.specialOffers.join(', ')}</span></p>`;
  }

  basicInfo.innerHTML = `
    <div>
      <p><strong>é›»è©±ï¼š</strong><a href='tel:${store.phone.replace(/-/g, '')}'>${store.phone}</a></p>
      ${promotionDisplay}
      ${hoursDisplay}
    </div>
  `;
  collapsibleContent.appendChild(basicInfo);

  // ç‡Ÿæ¥­ç‹€æ…‹
  const isOpen = checkIfStoreIsOpen(store, businessHours);
  const statusInfo = document.createElement('div');
  statusInfo.className = 'status-info';
  statusInfo.innerHTML = `
    <strong>ç‹€æ…‹ï¼š</strong>
    <span class="${isOpen ? 'open-status' : 'closed-status'}">${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­'}</span>
  `;
  collapsibleContent.appendChild(statusInfo);

  // æŒ‰éˆ•ç¾¤çµ„
  const btnGroup = document.createElement('div');
  btnGroup.className = 'btn-group';
  
  // æŒ‰éˆ•å…§å®¹ (èˆ‡èˆŠç‰ˆç›¸åŒï¼Œç›´æ¥è¤‡è£½è²¼ä¸Š)
  btnGroup.innerHTML = `
    <button onclick="openOnlineOrder('${store.onlineOrderUrl}')" ${!store.onlineOrderUrl ? 'disabled' : ''}>ğŸ— ç·šä¸Šé»é¤</button>
    <button onclick="openGoogleMaps(${store.lat}, ${store.lng}, '${store.name}')">ğŸ—ºï¸ å°èˆª</button>
    <button onclick="callStore('${store.phone}')">ğŸ“ æ’¥æ‰“</button>
    <button onclick="openPandaOrder('${store.pandaUrl}')" ${!store.pandaUrl ? 'disabled' : ''}>ğŸ¼ ç†Šè²“</button>
    <button onclick="openUberOrder('${store.uberUrl}')" ${!store.uberUrl ? 'disabled' : ''}>ğŸš— Uber</button>
  `;

  // è™•ç†ç¦ç”¨æŒ‰éˆ•çš„ç–ŠåŠ æç¤º
  btnGroup.querySelectorAll('button[disabled]').forEach(btn => {
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      btn.style.position = 'relative';
      const overlay = document.createElement('div');
      overlay.style.cssText = `position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0,0,0,0.6);color: white;font-size: 10px;display: flex;align-items: center;justify-content: center;border-radius: inherit;`;
      overlay.textContent = 'æš«ç„¡æœå‹™';
      btn.appendChild(overlay);
  });
  
  collapsibleContent.appendChild(btnGroup);

  // å°‡å¯æ”¶åˆå®¹å™¨åŠ å…¥åˆ°å¡ç‰‡æ­£é¢
  storeFront.appendChild(collapsibleContent);

  // ä¼‘æ¯ä¸­åº—å®¶é®ç½©æ•ˆæœ
  if (!isOpen) {
    storeItem.classList.add('store-closed');
    const maskContent = document.createElement('div');
    maskContent.className = 'closed-mask-content';
    const nextOpenTime = getNextOpenTime(store.businessHours);
    maskContent.innerHTML = `
      <div class="closed-icon">ğŸ˜´</div>
      <div class="closed-store-name">${store.name}</div>
      <div class="closed-status">ä¼‘æ¯ä¸­</div>
      <div style="color: #60a5fa; font-size: 13px; margin-top: 4px;">ä¸‹æ¬¡ç‡Ÿæ¥­ï¼š${nextOpenTime}</div>
    `;
    storeItem.appendChild(maskContent);
    addClosedStoreClickEffect(storeItem);
  }

  storeCard.appendChild(storeFront);
  storeItem.appendChild(storeCard);

  // åˆ¤æ–·æ˜¯å¦ç‡Ÿæ¥­ä¸­ï¼Œä¸¦æ·»åŠ ç«ç„°ç‰¹æ•ˆ class
  if (isOpen) {
    storeCard.classList.add('flame-border');
  }

  return storeItem;
}

    // è«‹æ±‚ç”¨æˆ¶ä½ç½®
    async function requestUserLocation() {
      if (isLocationRequested) return;

      try {
        isLocationRequested = true;

        // æª¢æŸ¥æ˜¯å¦æœ‰ç·©å­˜çš„ä½ç½®
        const cachedLocation = localStorage.getItem('userLocation');
        if (cachedLocation) {
          userLocation = JSON.parse(cachedLocation);
          updateMapWithUserLocation();
          return;
        }

        // è«‹æ±‚æ–°çš„ä½ç½®
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              // ç·©å­˜ä½ç½®
              localStorage.setItem('userLocation', JSON.stringify(userLocation));

              updateMapWithUserLocation();
              console.log('âœ… ç”¨æˆ¶ä½ç½®ç²å–æˆåŠŸ');
            },
            (error) => {
              console.warn('âš ï¸ ç„¡æ³•ç²å–ç”¨æˆ¶ä½ç½®:', error);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000 // 5åˆ†é˜ç·©å­˜
            }
          );
        }
      } catch (error) {
        console.error('âŒ ä½ç½®è«‹æ±‚å¤±æ•—:', error);
      }
    }

    // æ›´æ–°åœ°åœ–é¡¯ç¤ºç”¨æˆ¶ä½ç½®
    function updateMapWithUserLocation() {
      if (!map || !userLocation) return;

      try {
        // æ·»åŠ ç”¨æˆ¶ä½ç½®æ¨™è¨˜
const userIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/chatscai10/bjg8/refs/heads/main/line/754e3924-3cc8-46a9-b512-48aaf012d1dd.png',
  iconSize: [42, 64],
  iconAnchor: [21, 64], // åŒæ¨£åœ–ç‰‡ä¸‹ç·£ä¸­é–“
  popupAnchor: [0, -64]
});


        L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
          .addTo(map)
          .bindPopup('æœŸå¾…çš„æ‚¨')
          .openPopup();

        // èª¿æ•´åœ°åœ–è¦–é‡åŒ…å«ç”¨æˆ¶ä½ç½®å’Œæ‰€æœ‰åˆ†åº—
        const allPoints = [
          [userLocation.lat, userLocation.lng],
          ...storeData.map(store => [store.lat, store.lng])
        ];

        const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
        map.fitBounds(group.getBounds().pad(0.1));

        console.log('âœ… åœ°åœ–å·²æ›´æ–°ç”¨æˆ¶ä½ç½®');
      } catch (error) {
        console.error('âŒ æ›´æ–°ç”¨æˆ¶ä½ç½®å¤±æ•—:', error);
      }
    }

    // é–‹å•ŸGoogleåœ°åœ–å°èˆª
    function openGoogleMaps(lat, lng, storeName) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(storeName)}`;
      openExternalOrHref(url);
    }

    // æ’¥æ‰“é›»è©±
    function callStore(phone) {
      window.location.href = `tel:${phone}`;
    }

    // é–‹å•Ÿç·šä¸Šé»é¤
    function openOnlineOrder(onlineOrderUrl) {
      if (onlineOrderUrl) {
        openExternalOrHref(onlineOrderUrl);
      } else {
        console.log('âš ï¸ æ­¤åˆ†åº—æš«ç„¡ç·šä¸Šé»é¤æœå‹™');
      }
    }

    // é–‹å•Ÿç†Šè²“å¤–é€
    function openPandaOrder(pandaUrl) {
      if (pandaUrl) {
        openExternalOrHref(pandaUrl);
      } else {
        console.log('âš ï¸ æ­¤åˆ†åº—æš«ç„¡ç†Šè²“å¤–é€æœå‹™');
      }
    }

    // é–‹å•ŸUberå¤–é€
    function openUberOrder(uberUrl) {
      if (uberUrl) {
        openExternalOrHref(uberUrl);
      } else {
        console.log('âš ï¸ æ­¤åˆ†åº—æš«ç„¡Uberå¤–é€æœå‹™');
      }
    }

function addClosedStoreClickEffect(storeElement) {
  storeElement.addEventListener('click', function (e) {
    // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ–é€£çµï¼Œå°±ç•¥é
    if (e.target.closest('a, button')) {
      return;
    }

    // åˆ‡æ›é®ç½©é€æ˜åº¦
    storeElement.classList.toggle('clicked-transparent');
    
    // åŒæ™‚åˆ‡æ›å¡ç‰‡å±•é–‹ç‹€æ…‹
    storeElement.classList.toggle('expanded');
    
    console.log(`  é»æ“Šä¼‘æ¯ä¸­åº—å®¶ ${storeElement.dataset.storeId} â†’ åˆ‡æ›é¡¯ç¤ºç‹€æ…‹`);
  });
}


    // æ‰‹å‹•è«‹æ±‚å®šä½
    function manualRequestLocation() {
      const btn = document.getElementById('locate-btn');

      // é‡ç½®ç‹€æ…‹
      isLocationRequested = false;
      userLocation = null;

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      btn.innerHTML = 'ğŸ”„ å®šä½ä¸­...';
      btn.disabled = true;

      // æ¸…é™¤ç·©å­˜
      localStorage.removeItem('userLocation');

      // é‡æ–°è«‹æ±‚ä½ç½®
      requestUserLocation().finally(() => {
        btn.innerHTML = 'ğŸ“ é‡æ–°å®šä½';
        btn.disabled = false;
      });
    }

    // å¤–éƒ¨é€£çµé–‹å•Ÿ
    function openExternalOrHref(finalUrl) {
      if (typeof liff !== "undefined" && liff.isInClient()) {
        liff.openWindow({
          url: finalUrl,
          external: true
        });
      } else {
        window.open(finalUrl, "_blank");
      }
    }

    // é–‹å•ŸLINEåŠ å¥½å‹
    function openLineAddFriend() {
      const lineAddFriendUrl = 'https://line.me/R/ti/p/@fried'; // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„LINE ID
      console.log('ğŸ” é»æ“Šæ‡¸æµ®é›æ’ï¼Œé–‹å•ŸLINEåŠ å¥½å‹');
      openExternalOrHref(lineAddFriendUrl);
    }

    // æª¢æŸ¥åˆ†åº—æ˜¯å¦ç‡Ÿæ¥­ä¸­
    function checkIfStoreIsOpen(store, businessHours) {
      // å¦‚æœåˆ†åº—è¨­å®šç‚ºé—œé–‰ï¼Œç›´æ¥è¿”å›false
      if (store.isOpen === false) {
        console.log(`âŒ ${store.name} åˆ†åº—è¨­å®šç‚ºé—œé–‰ (store.isOpen = false)`);
        return false;
      }

      // ä½¿ç”¨æ¸¬è©¦æ™‚é–“æˆ–å¯¦éš›æ™‚é–“
      const now = testTime || new Date();
      const currentDay = now.getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, ..., 6=é€±å…­
      const currentTime = now.getHours() * 100 + now.getMinutes(); // ä¾‹å¦‚: 14:30 = 1430

      // å°‡æ•¸å­—è½‰æ›ç‚ºä¸­æ–‡æ˜ŸæœŸ
      const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
      const todayName = dayNames[currentDay];

      // ç²å–ä»Šå¤©çš„ç‡Ÿæ¥­æ™‚é–“
      const todayHours = businessHours[todayName];

      console.log(`ğŸ•’ ç‡Ÿæ¥­æ™‚é–“æª¢æŸ¥ - åˆ†åº—: ${store.name}`);
      console.log(`   ğŸ“… ä»Šå¤©: ${todayName} (${currentDay})`);
      console.log(`   â° ç•¶å‰æ™‚é–“: ${Math.floor(currentTime/100)}:${String(currentTime%100).padStart(2,'0')} (${currentTime})`);
      console.log(`   ğŸª ç‡Ÿæ¥­æ™‚é–“: ${todayHours}`);
      console.log(`   ğŸ“‹ å®Œæ•´ç‡Ÿæ¥­æ™‚é–“:`, businessHours);

      if (!todayHours || todayHours === 'ä¼‘æ¯' || todayHours === 'å…¬ä¼‘') {
        console.log(`âŒ ${store.name} ä»Šå¤©ä¼‘æ¯æˆ–ç„¡ç‡Ÿæ¥­æ™‚é–“è¨­å®š`);
        return false;
      }





      // è§£æç‡Ÿæ¥­æ™‚é–“ - æ”¯æ´å¤šæ™‚æ®µæ ¼å¼ (ä¾‹å¦‚: "11:00-21:00" æˆ– "00:00-01:00,15:00-24:00")
      const timeSegments = todayHours.split(',').map(segment => segment.trim());
      console.log(`ğŸ“Š ${store.name} æ™‚é–“æ®µè§£æ: ${timeSegments.join(' + ')}`);

      let isOpen = false;

      for (const segment of timeSegments) {
        const timeMatch = segment.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
        if (!timeMatch) {
          console.log(`âš ï¸ ${store.name} ç„¡æ³•è§£ææ™‚é–“æ®µæ ¼å¼: ${segment}`);
          continue;
        }

        const openTime = parseInt(timeMatch[1]) * 100 + parseInt(timeMatch[2]);
        const closeTime = parseInt(timeMatch[3]) * 100 + parseInt(timeMatch[4]);

        console.log(`   ğŸ“Š æ™‚é–“æ®µ: ${segment}`);
        console.log(`   ğŸ”“ é–‹åº—æ™‚é–“: ${openTime} (${Math.floor(openTime/100)}:${String(openTime%100).padStart(2,'0')})`);
        console.log(`   ğŸ”’ é—œåº—æ™‚é–“: ${closeTime} (${Math.floor(closeTime/100)}:${String(closeTime%100).padStart(2,'0')})`);
        console.log(`   â° ç•¶å‰æ™‚é–“: ${currentTime} (${Math.floor(currentTime/100)}:${String(currentTime%100).padStart(2,'0')})`);

        // æª¢æŸ¥ç•¶å‰æ™‚é–“æ˜¯å¦åœ¨é€™å€‹æ™‚é–“æ®µå…§
        let segmentOpen;
        if (closeTime > openTime) {
          // æ­£å¸¸æƒ…æ³ï¼šä¸è·¨æ—¥ (ä¾‹å¦‚: 11:00-21:00)
          segmentOpen = currentTime >= openTime && currentTime < closeTime;
          console.log(`   ğŸ“‹ åˆ¤æ–·é‚è¼¯: ${currentTime} >= ${openTime} && ${currentTime} < ${closeTime} = ${segmentOpen}`);
        } else {
          // è·¨æ—¥æƒ…æ³ï¼š(ä¾‹å¦‚: 22:00-02:00)
          segmentOpen = currentTime >= openTime || currentTime < closeTime;
          console.log(`   ğŸ“‹ è·¨æ—¥åˆ¤æ–·é‚è¼¯: ${currentTime} >= ${openTime} || ${currentTime} < ${closeTime} = ${segmentOpen}`);
        }

        if (segmentOpen) {
          isOpen = true;
          console.log(`   âœ… åœ¨æ™‚é–“æ®µ ${segment} å…§ç‡Ÿæ¥­ä¸­`);
          break; // åªè¦æœ‰ä¸€å€‹æ™‚é–“æ®µç‡Ÿæ¥­ä¸­å°±å¯ä»¥äº†
        } else {
          console.log(`   âŒ ä¸åœ¨æ™‚é–“æ®µ ${segment} å…§`);
        }
      }

      console.log(`${isOpen ? 'âœ…' : 'âŒ'} ${store.name} æœ€çµ‚çµæœ: ${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­'}`);
      return isOpen;
    }


function getNextOpenTime(businessHours) {
  const now = testTime || new Date(); // ä½¿ç”¨æ¸¬è©¦æ™‚é–“æˆ–å¯¦éš›æ™‚é–“
  const currentDay = now.getDay();
  const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];

  for (let i = 1; i <= 7; i++) {
    const nextDayIndex = (currentDay + i) % 7;
    const nextDayName = dayNames[nextDayIndex];
    const hours = businessHours[nextDayName];

    if (hours && hours !== 'ä¼‘æ¯') {
      return (i === 1 ? 'æ˜å¤©' : nextDayName) + ' ' + hours.split('-')[0] + ' é–‹å§‹ç‡Ÿæ¥­';
    }
  }

  return 'å°šæœªè¨­å®šç‡Ÿæ¥­æ™‚é–“';
}


    // ç‡Ÿæ¥­æ™‚é–“å±•é–‹/æ”¶èµ·åŠŸèƒ½
    function toggleBusinessHours(storeId) {
      console.log(`ğŸ•’ åˆ‡æ›ç‡Ÿæ¥­æ™‚é–“é¡¯ç¤º: ${storeId}`);

      const toggle = document.querySelector(`[onclick="toggleBusinessHours('${storeId}')"]`);
      const details = document.getElementById(`hours-${storeId}`);

      if (toggle && details) {
        const isExpanded = details.classList.contains('expanded');

        if (isExpanded) {
          // æ”¶èµ·
          details.classList.remove('expanded');
          toggle.classList.remove('expanded');
          console.log(`ğŸ“ ${storeId} ç‡Ÿæ¥­æ™‚é–“å·²æ”¶èµ·`);
        } else {
          // å±•é–‹
          details.classList.add('expanded');
          toggle.classList.add('expanded');
          console.log(`ğŸ“‚ ${storeId} ç‡Ÿæ¥­æ™‚é–“å·²å±•é–‹`);
        }
      }
    }

    // å•Ÿå‹•æ‡‰ç”¨
    document.addEventListener('DOMContentLoaded', init);

    // æ§åˆ¶å°æç¤º
    console.log('ğŸš€ ä¸æ—©è„†çš®é›æ’-åˆ†åº—åœ°åœ–å·²è¼‰å…¥ï¼');
  </script>
</body>
</html>
