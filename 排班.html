<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機版排班系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.2/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; margin: 0; padding: 20px; }
        h1, h2 { color: #333; }
        table { width: 100%; max-width: 400px; margin: 20px auto; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { border: 1px solid black; padding: 10px; width: 14%; height: 50px; text-align: center; cursor: pointer; font-size: 18px; }
        .disabled { background-color: red !important; color: white; pointer-events: none; }
        .selected { background-color: gray; color: white; }
        button { font-size: 18px; padding: 12px 24px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; }
        #confirm-btn { background: #28a745; color: white; }
        #cancel-btn { background: #dc3545; color: white; }
        #result { font-size: 18px; font-weight: bold; color: #333; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>排班系統</h1>
    <h2 id="month-title"></h2>
    <p>可排休天數: <span id="max-days"></span></p>
    <p>不可排休日期: <span id="blocked-dates"></span></p>
    <p>每日排休人數上限: <span id="max-per-day"></span></p>

    <table id="calendar"></table>

    <button id="confirm-btn" onclick="confirmSchedule()">確認排休</button>
    <button id="cancel-btn" onclick="clearSelection()">取消</button>

    <h2>排休結果</h2>
    <p id="result"></p>

    <script>
        let maxDays = 0, month = "", blockedDays = [], dailyLimit = 0;
        let selectedDays = new Set();
        let name = "";
        const sheetId = "1-WvZ2HG57mG7xl9iVP7gtVZdy94FmF_RiQcSsuXIqB0";

        // 讀取 Google Sheets
        async function loadGoogleSheet() {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(47, text.length - 2));

            // 解析「數據設定」分頁
            const rows = json.table.rows;
            maxDays = parseInt(rows[0].c[0].v);
            month = rows[0].c[1].v;
            blockedDays = rows[0].c[2].v.split('.').map(Number);
            dailyLimit = parseInt(rows[0].c[3].v);

            document.getElementById("month-title").textContent = `${month}月排班`;
            document.getElementById("max-days").textContent = maxDays;
            document.getElementById("blocked-dates").textContent = blockedDays.join(", ");
            document.getElementById("max-per-day").textContent = dailyLimit;

            generateCalendar();
        }

        // 產生月曆
        function generateCalendar() {
            const table = document.getElementById("calendar");
            table.innerHTML = "";
            let row = table.insertRow();
            for (let day = 1; day <= 31; day++) {
                let cell = row.insertCell();
                cell.textContent = day;
                cell.dataset.day = day;

                if (blockedDays.includes(day)) {
                    cell.classList.add("disabled");
                }

                cell.addEventListener("click", () => toggleDay(cell));
                if (day % 7 === 0) row = table.insertRow();
            }
        }

        // 切換選擇的日期
        function toggleDay(cell) {
            const day = Number(cell.dataset.day);
            if (selectedDays.has(day)) {
                selectedDays.delete(day);
                cell.classList.remove("selected");
            } else if (selectedDays.size < maxDays) {
                selectedDays.add(day);
                cell.classList.add("selected");
            }
        }

        // 確認排休
        function confirmSchedule() {
            if (!name) {
                name = prompt("請輸入你的名字：");
                if (!name) return;
            }

            let remainingDays = maxDays - selectedDays.size;
            let resultText = `${name} - 目前排班 ${selectedDays.size} 天 - ${Array.from(selectedDays).map(d => `${d}日`).join(", ")} - 還有 ${remainingDays} 天可以排班`;
            document.getElementById("result").textContent = resultText;

            saveToGoogleSheet(name, selectedDays);
        }

        // 清除已選的日期
        function clearSelection() {
            selectedDays.clear();
            document.querySelectorAll(".selected").forEach(cell => cell.classList.remove("selected"));
            document.getElementById("result").textContent = "已取消選擇，請重新選擇排休日期";
        }

        // 儲存到 Google Sheets
        async function saveToGoogleSheet(name, selectedDays) {
            const scriptUrl = "https://script.google.com/macros/s/你的GoogleAppsScript網址/exec"; 
            const data = { name, dates: Array.from(selectedDays), month };

            try {
                await axios.post(scriptUrl, data);
                alert("排休已儲存！");
            } catch (error) {
                alert("儲存失敗，請重試");
            }
        }

        loadGoogleSheet();
    </script>
</body>
</html>
